<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-06-20 Mon 12:23 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>example code of jojo</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="http://xieyuheng.github.io/asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
長悲嘆而掩面兮 憐其獨於夢睹
</div>
<div id="content">
<h1 class="title">example code of jojo</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7f3018e">define function</a></li>
<li><a href="#org634ec8">loop by explicit tail-call</a></li>
<li><a href="#org6a818ff">branching by if</a></li>
<li><a href="#orgdd36eac">receive function</a></li>
<li><a href="#org9c1f475">integer</a></li>
<li><a href="#orgf910063">string</a></li>
<li><a href="#org71010f7">file</a></li>
<li><a href="#orgbc9df32">system</a></li>
<li><a href="#orga07ff9f">var</a></li>
<li><a href="#org66338f0">report</a></li>
<li><a href="#orgb150ec7">gc</a>
<ul>
<li><a href="#org89e6ba3">cons-area</a></li>
<li><a href="#orge21fe10">cons-area-report</a></li>
<li><a href="#orged4a1f7">sweep-cons-area</a></li>
<li><a href="#org5e830f">mark-cons-area</a></li>
<li><a href="#orgf60beaf">cons</a></li>
<li><a href="#org79bcc42"><span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#orgf73e2f2">list</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7f3018e" class="outline-2">
<h2 id="org7f3018e">define function</h2>
<div class="outline-text-2" id="text-org7f3018e">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">square</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> int int <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> int<span style="color: #696969;">)</span>
  dup mul end<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 11<span style="color: #696969;">)</span> square dot<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org634ec8" class="outline-2">
<h2 id="org634ec8">loop by explicit tail-call</h2>
<div class="outline-text-2" id="text-org634ec8">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply-key</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> jo <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> *<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup jo-used? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> apply end<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>undefined keyword : <span style="color: #696969;">))</span> print-string
  jo-&gt;string print-string end<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">stack-repl</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #797979;">[</span>io<span style="color: #797979;">]</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> *<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> read-jo round-bar eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> read-jo apply-key print-stack<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> stack-repl<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> stack-repl<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a818ff" class="outline-2">
<h2 id="org6a818ff">branching by if</h2>
<div class="outline-text-2" id="text-org6a818ff">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> true <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> true dot end<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> false <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> false dot end<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd36eac" class="outline-2">
<h2 id="orgdd36eac">receive function</h2>
<div class="outline-text-2" id="text-orgdd36eac">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">factorial</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> int <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> int<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> lteq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> end<span style="color: #696969;">)</span>
  dup <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> sub factorial mul end<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span> factorial dot
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> factorial dot
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 2<span style="color: #696969;">)</span> factorial dot
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 3<span style="color: #696969;">)</span> factorial dot
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 4<span style="color: #696969;">)</span> factorial dot<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c1f475" class="outline-2">
<h2 id="org9c1f475">integer</h2>
<div class="outline-text-2" id="text-org9c1f475">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 18 5<span style="color: #696969;">)</span> mod dot<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf910063" class="outline-2">
<h2 id="orgf910063">string</h2>
<div class="outline-text-2" id="text-orgf910063">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>test1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>test2<span style="color: #696969;">))</span>
     print-string print-string<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org71010f7" class="outline-2">
<h2 id="org71010f7">file</h2>
<div class="outline-text-2" id="text-org71010f7">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>README<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1024<span style="color: #696969;">)</span> allocate tuck
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1024<span style="color: #696969;">)</span> read-file dot
     print-string<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc9df32" class="outline-2">
<h2 id="orgbc9df32">system</h2>
<div class="outline-text-2" id="text-orgbc9df32">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> getcwd print-string<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga07ff9f" class="outline-2">
<h2 id="orga07ff9f">var</h2>
<div class="outline-text-2" id="text-orga07ff9f">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> var1 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 666<span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 666<span style="color: #696969;">)</span> add<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> var1 dot<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org66338f0" class="outline-2">
<h2 id="org66338f0">report</h2>
<div class="outline-text-2" id="text-org66338f0">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> defprim-report
     defun-report
     defvar-report<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb150ec7" class="outline-2">
<h2 id="orgb150ec7">gc</h2>
<div class="outline-text-2" id="text-orgb150ec7">
</div><div id="outline-container-org89e6ba3" class="outline-3">
<h3 id="org89e6ba3">cons-area</h3>
<div class="outline-text-3" id="text-org89e6ba3">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> cons-size <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 3<span style="color: #696969;">)</span> cell-size mul<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> cons-area-size <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 5<span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1024 1024<span style="color: #696969;">)</span> mul<span style="color: #696969;">)</span> cons-size mul<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> cons-area cons-area-size allocate<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> cons-area-top cons-area cons-area-size add<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> cons-pointer cons-area<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons-pointer/next</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-pointer<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  cons-size cons-pointer add
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">var</span> cons-pointer<span style="color: #696969;">)</span> set<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons-pointer/init</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-pointer<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  cons-area
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">var</span> cons-pointer<span style="color: #696969;">)</span> set<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons-pointer/next-free</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-pointer<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cons-pointer cons-area-top eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> end<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cons-pointer get currnet-mark eq? not <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> end<span style="color: #696969;">)</span>
  cons-pointer/next
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> cons-pointer/next-free<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge21fe10" class="outline-3">
<h3 id="orge21fe10">cons-area-report</h3>
<div class="outline-text-3" id="text-orge21fe10">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons-area-report/loop</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>io<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup cons-area-top eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop end<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>#:<span style="color: #696969;">))</span> print-string
  dup dot
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>mark: <span style="color: #696969;">))</span> print-string
  dup get dot
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>car: <span style="color: #696969;">))</span> print-string
  dup car dot
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>cdr: <span style="color: #696969;">))</span> print-string
  dup cdr dot
  newline
  cons-size add
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> cons-area-report/loop<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons-area-report</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>io<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  cons-area cons-area-report/loop<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orged4a1f7" class="outline-3">
<h3 id="orged4a1f7">sweep-cons-area</h3>
<div class="outline-text-3" id="text-orged4a1f7">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">sweep-cons-area/loop</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>io<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup cons-area-top eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop end<span style="color: #696969;">)</span>
  dup <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span>  swap set
  cons-size add
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> sweep-cons-area/loop<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">sweep-cons-area</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-area<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  cons-area sweep-cons-area/loop<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e830f" class="outline-3">
<h3 id="org5e830f">mark-cons-area</h3>
<div class="outline-text-3" id="text-org5e830f">
<ul class="org-ul">
<li><p>root from</p><p><ul class="org-ul"></p><p><li><p>stack</p></li></p><p><li><p>defvar</p></li></ul></p></li></ul>

<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> currnet-mark <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defvar</span> max-mark <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 3<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">mark-cons</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-area<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup cons? not <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop end<span style="color: #696969;">)</span>
  dup currnet-mark swap set
  dup car mark-cons
  cdr <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> mark-cons<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">mark-cons-area-for-defvar</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> defvar-record/addr <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-area<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup get <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span> eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop end<span style="color: #696969;">)</span>
  dup get mark-cons
  cell-size add
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> mark-cons-area-for-defvar<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">mark-cons-area-for-stack</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> stack/addr <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-area<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup stack-base eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop end<span style="color: #696969;">)</span>
  cell-size sub
  dup get mark-cons
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> mark-cons-area-for-stack<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">mark-cons-area</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>cons-area<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> currnet-mark max-mark eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
      sweep-cons-area
      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">var</span> currnet-mark<span style="color: #696969;">)</span> set<span style="color: #696969;">)</span>
  currnet-mark <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> add <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">var</span> currnet-mark<span style="color: #696969;">)</span> set
  defvar-record mark-cons-area-for-defvar
  stack-pointer
  mark-cons-area-for-stack<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf60beaf" class="outline-3">
<h3 id="orgf60beaf">cons</h3>
<div class="outline-text-3" id="text-orgf60beaf">
<ul class="org-ul">
<li><p><p></p><p>cons</p><p></p></p><p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"></p><p></p><p></p><p><colgroup></p><p><col  class="org-left" /></p><p></colgroup></p><p><tbody></p><p><tr></p><p><td class="org-left">mark</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">car</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">cdr</td></p><p></tr></p><p></tbody></p><p></table></p></li></ul>

<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">new-cons</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cons<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cons-pointer cons-area-top eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
      mark-cons-area
      cons-pointer/init
      cons-pointer/next-free
      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cons-pointer cons-area-top eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">string</span> <span style="color: #696969;">(</span>fatal error : cons-area is full<span style="color: #696969;">))</span> print-string
          newline bye<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> new-cons<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cons-pointer get currnet-mark eq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
      cons-pointer/next <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">tail-call</span> new-cons<span style="color: #696969;">))</span>
  cons-pointer
  cons-pointer/next end<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">set-car</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cell cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cons<span style="color: #696969;">)</span>
  tuck
  cell-size add
  set<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">set-cdr</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cell cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cons<span style="color: #696969;">)</span>
  tuck
  cell-size add
  cell-size add
  set<span style="color: #696969;">)</span>


<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">car</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cell<span style="color: #696969;">)</span>
  cell-size add
  get<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cdr</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cell<span style="color: #696969;">)</span>
  cell-size add
  cell-size add
  get<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons?</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cell <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bool<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup cons-area lt? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop false end<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> dup cons-area-top gteq? <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> drop false end<span style="color: #696969;">)</span>
  cons-area sub cons-size mod <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span> eq?<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">cons</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cdr-cell car-cell <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cons<span style="color: #696969;">)</span>
  new-cons set-car set-cdr<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org79bcc42" class="outline-3">
<h3 id="org79bcc42"><span class="done test">test</span> </h3>
<div class="outline-text-3" id="text-org79bcc42">
<div class="org-src-container">

<pre class="src src-jojo"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 0<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 1<span style="color: #696969;">)</span> cons
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">#</span> 2<span style="color: #696969;">)</span> cons
        dup car dot
        dup cdr car dot
        dup cdr cdr dot

        dup cons? dot
        dup cdr cons? dot
        dup car cons? dot
        dup cdr car cons? dot
        dup cdr cdr cons? dot
        dot

        currnet-mark
        dot<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">run</span> newline
        new-cons dot
        new-cons dot
        new-cons dot
        new-cons dot
        new-cons dot
        currnet-mark dot
        newline
        cons-area-report
        newline<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf73e2f2" class="outline-2">
<h2 id="orgf73e2f2">list</h2>
<div class="outline-text-2" id="text-orgf73e2f2">
<div class="org-src-container">

<pre class="src src-jojo"></pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
涕执我乎垂丧兮 懼余生之茫苦
</div>
</body>
</html>
