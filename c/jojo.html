<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-09-25 Mon 01:20 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>jojo</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="xieyuheng" />
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">jojo</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org75f71e6"><span class="done _todo_stack_">[todo-stack]</span> </a>
<ul>
<li><a href="#org5a3a197">before any movement, learn more about interpreter and compiler</a></li>
<li><a href="#orgf0b3eb8">[fix bug] gc_mark does not handle bindings of gene hash table</a></li>
<li><a href="#org64e277e">refactor the design of jojo</a></li>
<li><a href="#org8cf70c5">fix socket module</a></li>
<li><a href="#orge4df093">fix name_record</a></li>
<li><a href="#org50f3576">better jojo.h</a></li>
<li><a href="#org9f91fd1">better file io</a></li>
<li><a href="#org5cb68bd">time and sleep</a></li>
<li><a href="#org6c6f33f">report address info for debug</a></li>
<li><a href="#orgb43cede">expose address_jo_p and address_gp_p for debug</a></li>
<li><a href="#orga1c8294">fix debug_repl</a></li>
<li><a href="#orgeb85e2e">report_local_record</a></li>
<li><a href="#org7ea5f6">report_dynamic_local_record</a></li>
<li><a href="#orgae48987">better p_debug</a></li>
<li><a href="#orgdd49961">better p_step</a></li>
<li><a href="#org2b4d869">abstract the interface of jo</a></li>
<li><a href="#org87ae8a9">trace and untrace a jojo</a></li>
<li><a href="#org86363b2">delimited continuation</a></li>
<li><a href="#orgd958939">concurrent</a></li>
</ul>
</li>
<li><a href="#orgfa1812b"><span class="todo _note_">[note]</span> </a>
<ul>
<li><a href="#org78d521e">interface convention</a></li>
<li><a href="#orgfcb9610">important common sense</a></li>
<li><a href="#orga600bb1">threaded code interpreter</a></li>
<li><a href="#orge5ca70a">limits</a></li>
<li><a href="#orgf1ba0c5">input_stack &amp; output_stack</a></li>
</ul>
</li>
<li><a href="#orgb3902f3">header</a></li>
<li><a href="#org5cafebc">type</a></li>
<li><a href="#orgc85fc14">utility</a>
<ul>
<li><a href="#org8b5dc85">int</a></li>
<li><a href="#orga8e0584">char</a>
<ul>
<li><a href="#orgfa65884">char_space_p</a></li>
<li><a href="#orga4a3905">char_bar_ket_p</a></li>
<li><a href="#org62ec53">char_delimiter_p</a></li>
</ul>
</li>
<li><a href="#orgcd9cec7">char_to_nat</a></li>
<li><a href="#org933a6cc">report</a></li>
<li><a href="#org6eda0de">report_in_red</a></li>
<li><a href="#org40abeed">report_in_green</a></li>
<li><a href="#org7d80796">string</a>
<ul>
<li><a href="#org720033b">string_equal</a></li>
<li><a href="#orgebedd3d">nat_string_p</a></li>
<li><a href="#org79bd24a">int_string_p</a></li>
<li><a href="#orga8a8588">string_to_based_nat &amp; string_to_based_int &amp; string_to_int</a></li>
<li><a href="#orgda97236">string_count_member</a></li>
<li><a href="#org76227d2">string_member_p</a></li>
<li><a href="#orgd3f25c4">string_last_byte</a></li>
<li><a href="#org8f0f3e7">substring</a></li>
</ul>
</li>
<li><a href="#org7b39a2a">array</a>
<ul>
<li><a href="#orgf594cf7">array_len_dup</a></li>
<li><a href="#org55f76ac">array_len</a></li>
<li><a href="#org3754889">array_dup</a></li>
<li><a href="#orgbd3d147">array_equal_p</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1d400e7">debug</a></li>
<li><a href="#org1471fd0">jotable</a>
<ul>
<li><a href="#org501a37c">jotable_entry</a></li>
<li><a href="#orgc99497d">jo_bound_p</a></li>
<li><a href="#org249d8bc">string_to_sum</a></li>
<li><a href="#org4d74ac7">jotable_hash</a></li>
<li><a href="#orga7f712">jotable_insert</a></li>
<li><a href="#orgbf20af4">str2jo</a></li>
<li><a href="#orge6d9aa">jo2str</a></li>
<li><a href="#org58dc33f">literal jo</a></li>
<li><a href="#org268a421">name_record</a></li>
<li><a href="#orge9c798c">report_name_record</a></li>
<li><a href="#org1b15fa6">bind_name</a></li>
<li><a href="#org439bacb">rebind_name</a></li>
<li><a href="#org7333773">literal jo_array</a>
<ul>
<li><a href="#org6273fe0">generate_jo_array</a></li>
<li><a href="#org36a7295">macro</a></li>
</ul>
</li>
<li><a href="#org1438f0">jo_bar_ket_p</a></li>
<li><a href="#org22d4e12">jo_delimiter_p</a></li>
<li><a href="#orgbebd4d4">in_jotable_p</a></li>
</ul>
</li>
<li><a href="#orgdba784e">stack</a>
<ul>
<li><a href="#orgb1727db">stack_link</a></li>
<li><a href="#org9277888">stack</a></li>
<li><a href="#orgd67d791">new_stack</a></li>
<li><a href="#orga1410c">stack_free</a></li>
<li><a href="#org31d4d5a">stack_block_underflow_check</a></li>
<li><a href="#org50d1d73">stack_block_overflow_check</a></li>
<li><a href="#org86f12bd">stack_empty_p</a></li>
<li><a href="#org140436a">stack_length</a></li>
<li><a href="#orgb4a1139">pop</a></li>
<li><a href="#orgc44b4fd">tos</a></li>
<li><a href="#org7bec7e6">drop</a></li>
<li><a href="#orgfde77c2">push</a></li>
<li><a href="#orga99a313">stack_peek</a></li>
<li><a href="#org6cfff8b">stack_ref</a></li>
</ul>
</li>
<li><a href="#orgce830bf">input_stack</a>
<ul>
<li><a href="#org85143d7"><span class="todo _note_">[note]</span> </a></li>
<li><a href="#org566262e">input_stack_type</a></li>
<li><a href="#org2e799c0">input_stack_link</a></li>
<li><a href="#org9131bee">input_stack</a></li>
<li><a href="#org4278034">new_input_stack</a></li>
<li><a href="#orgdcdbeba">file_input_stack</a></li>
<li><a href="#org4bfff43">string_input_stack</a></li>
<li><a href="#org32acff6">terminal_input_stack</a></li>
<li><a href="#org86ed43c">input_stack_free</a></li>
<li><a href="#org83b2134">input_stack_block_underflow_check</a></li>
<li><a href="#org98145fd">input_stack_block_overflow_check</a></li>
<li><a href="#org28251ba">input_stack_empty_p</a></li>
<li><a href="#orgb529372">input_stack_pop</a></li>
<li><a href="#org330e7bd">input_stack_tos</a></li>
<li><a href="#org66cc024">input_stack_drop</a></li>
<li><a href="#orgbf443b3">input_stack_push</a></li>
</ul>
</li>
<li><a href="#orgdd09f5a">output_stack</a>
<ul>
<li><a href="#org2e99f1d"><span class="todo _note_">[note]</span> </a></li>
<li><a href="#org441f011">output_stack_type</a></li>
<li><a href="#org2840071">output_stack_link</a></li>
<li><a href="#orgf12b456">output_stack</a></li>
<li><a href="#org8bfed5a">new_output_stack</a></li>
<li><a href="#org372bfc0">file_output_stack</a></li>
<li><a href="#org4a76415">string_output_stack</a></li>
<li><a href="#orgc1dd3a6">terminal_output_stack</a></li>
<li><a href="#org527ae37">output_stack_free</a></li>
<li><a href="#org6ce296a">file_output_stack_flush</a></li>
<li><a href="#org504788">string_output_stack_collect</a></li>
<li><a href="#org873e27">output_stack_block_underflow_check</a></li>
<li><a href="#org726eef6">output_stack_block_overflow_check</a></li>
<li><a href="#org8ff301c">output_stack_empty_p</a></li>
<li><a href="#org5e92b67">output_stack_pop</a></li>
<li><a href="#org970bf4d">output_stack_tos</a></li>
<li><a href="#org3b72f5f">output_stack_drop</a></li>
<li><a href="#org929f04c">output_stack_push</a></li>
</ul>
</li>
<li><a href="#org5244668">ds &#x2013; data stack</a>
<ul>
<li><a href="#org673c5b5">ds</a></li>
</ul>
</li>
<li><a href="#orgce9bb06">rs &#x2013; return stack</a>
<ul>
<li><a href="#org4b01535">local</a></li>
<li><a href="#org9e84cf9">dynamic_local</a></li>
<li><a href="#org42f274a">rs</a></li>
</ul>
</li>
<li><a href="#org2c11914"><b>gc</b></a>
<ul>
<li><a href="#org3135fbb">struct gp</a></li>
<li><a href="#org6564da8">gr &#x2013; gc record</a></li>
<li><a href="#org6097b7b">gr_end_p</a></li>
<li><a href="#org84b5daf">init_gr</a></li>
<li><a href="#org63e33de">struct class</a></li>
<li><a href="#orgaf54d70">get &amp; set field</a></li>
<li><a href="#orgf57145f">class_index_to_field_name</a></li>
<li><a href="#org9d22fb3">class_field_name_to_index</a></li>
<li><a href="#orgffd96d1">get &amp; set gp field</a></li>
<li><a href="#org211e95f">get_field</a></li>
<li><a href="#org946e25b">ins_get_field</a></li>
<li><a href="#orgb53ddfd">ins_set_field</a></li>
<li><a href="#orgce519b7">mark_one_data</a></li>
<li><a href="#orged62c75">mark_gr</a></li>
<li><a href="#orgce4ed88">sweep_one_gp</a></li>
<li><a href="#orga6b4938">sweep_gr</a></li>
<li><a href="#orgb4c8458">run_gc</a></li>
<li><a href="#orgbdd7702">basic gc actors</a>
<ul>
<li><a href="#org948ced8">gc_ignore</a></li>
<li><a href="#org7f7816">gc_free</a></li>
<li><a href="#org6212279">gc_recur</a></li>
</ul>
</li>
<li><a href="#org5422af3">new_record_gp</a></li>
<li><a href="#org473c790">plus_atom</a></li>
<li><a href="#org3e69867">plus_data</a></li>
<li><a href="#orgadc0b4">plus_prim</a></li>
<li><a href="#org3fae0a7">p_tag</a></li>
<li><a href="#orgcee0d6f">p_eq_p</a></li>
<li><a href="#orgac337c4">p_new</a></li>
<li><a href="#orgc90bfc3">expose_gc</a></li>
</ul>
</li>
<li><a href="#org7d505a0">&lt;jojo&gt;</a>
<ul>
<li><a href="#orgb87f278">new_jojo_gp</a></li>
<li><a href="#org6ef244e">jojo_length</a></li>
<li><a href="#org41a0a3">p_new_jojo</a></li>
<li><a href="#orgb103745">gc_jojo</a></li>
<li><a href="#orgc026474">expose_jojo</a></li>
</ul>
</li>
<li><a href="#org17bc7eb">gene</a>
<ul>
<li><a href="#org9c7dc0a"><span class="todo _note_">[note]</span> dynamic dispatching</a></li>
<li><a href="#org295b58e">disp</a>
<ul>
<li><a href="#orga6f8a98">struct disp</a></li>
<li><a href="#orgf6edf77">new_disp</a></li>
<li><a href="#org909a7fa">disp_hash</a></li>
<li><a href="#org51832ed">disp_insert_entry</a></li>
<li><a href="#orgc8d164e">disp_insert</a></li>
<li><a href="#orgd3ba076">disp_find_entry</a></li>
<li><a href="#org17b6584">disp_find</a></li>
<li><a href="#orga431d67">disp_print_entry</a></li>
<li><a href="#orgf7ec8b7">disp_print</a></li>
</ul>
</li>
<li><a href="#org6a79d73">multi_disp</a>
<ul>
<li><a href="#org81066c9">struct multi_disp</a></li>
<li><a href="#orgaabb2f0">new_multi_disp</a></li>
<li><a href="#org2c2cd4d">multi_disp_hash</a></li>
<li><a href="#orgc705788">multi_disp_insert_entry</a></li>
<li><a href="#org432aeec">multi_disp_insert</a></li>
<li><a href="#org123ebdf">multi_disp_find_entry</a></li>
<li><a href="#org2247d0b">multi_disp_find</a></li>
<li><a href="#orgdd8cbb9">multi_disp_print_entry</a></li>
<li><a href="#orgd084185">multi_disp_print</a></li>
</ul>
</li>
<li><a href="#org6a30c">struct gene</a></li>
<li><a href="#orgc514e7f">plus_gene</a></li>
<li><a href="#orgb25a0d7">plus_disp</a></li>
<li><a href="#org594d739">plus_disp_default</a></li>
<li><a href="#orga54bf93">disp_exe</a></li>
<li><a href="#org3e9744a">multi_disp_exe</a></li>
<li><a href="#org324cbf2">p_gene_exe</a></li>
<li><a href="#org1a589be">p_prim_exe</a></li>
<li><a href="#orga94a734">p_jojo_exe</a></li>
<li><a href="#org347c99">p_data_predicate_exe</a></li>
<li><a href="#org746f0c4">p_default_exe</a></li>
<li><a href="#org97c292f">expose_gene</a></li>
</ul>
</li>
<li><a href="#org64682f9">exe &amp; jo_apply &amp; eval</a>
<ul>
<li><a href="#orgc32570f"><span class="todo _note_">[note]</span> </a></li>
<li><a href="#org727ab33">jo_apply</a></li>
<li><a href="#org95ef226">eval_one_step</a></li>
<li><a href="#orgeeefb31">eval</a></li>
</ul>
</li>
<li><a href="#org5a3d344"><b>ending</b></a>
<ul>
<li><a href="#orgee57e3d">p_end</a></li>
<li><a href="#org11af421">p_bye</a></li>
<li><a href="#org7aa86d2">p_nop</a></li>
<li><a href="#orgeb71699">expose_ending</a></li>
</ul>
</li>
<li><a href="#org19a6f2a"><b>stack</b></a>
<ul>
<li><a href="#orgc1f5b51">p_drop</a></li>
<li><a href="#orgef452d4">p_dup</a></li>
<li><a href="#org4ad7390">p_over</a></li>
<li><a href="#org71b75d7">p_tuck</a></li>
<li><a href="#orgf14da4d">p_swap</a></li>
<li><a href="#org1cc9d56">expose_stack</a></li>
</ul>
</li>
<li><a href="#org14567d9"><b>io</b></a>
<ul>
<li><a href="#org7b64768">reading_stack</a></li>
<li><a href="#org6111cfd">writing_stack</a></li>
<li><a href="#org433dc98">p_reading_stack_push</a></li>
<li><a href="#org60351ec">p_reading_stack_tos</a></li>
<li><a href="#orgf20cb31">p_reading_stack_pop</a></li>
<li><a href="#orge0f06a7">p_reading_stack_drop</a></li>
<li><a href="#orgbb81fd1">p_terminal_input_stack</a></li>
<li><a href="#org3f10d1f">p_input_stack_free</a></li>
<li><a href="#orga16f14a">p_input_stack_empty_p</a></li>
<li><a href="#org35a6e45">has_byte_p</a></li>
<li><a href="#org943065f">read_byte</a></li>
<li><a href="#org5eb22b3">p_read_byte</a></li>
<li><a href="#org1082ac0">byte_unread</a></li>
<li><a href="#org3aef233">byte_write</a></li>
<li><a href="#orga70ce26">p_byte_write</a></li>
<li><a href="#orgd95db0f">has_jo_p</a></li>
<li><a href="#org9970e03">p_has_jo_p</a></li>
<li><a href="#org10205bc">read_jo</a></li>
<li><a href="#org7ddd3cf">p_read_jo</a></li>
<li><a href="#org8f5c74d">string_unread</a></li>
<li><a href="#orgc2ac96d">p_string_unread</a></li>
<li><a href="#orgc1eb651">jo_unread</a></li>
<li><a href="#org6dcdd99">p_newline</a></li>
<li><a href="#orga96e386">p_space</a></li>
<li><a href="#orga8fad90">expose_io</a></li>
</ul>
</li>
<li><a href="#org28a54d7"><b>local</b></a>
<ul>
<li><a href="#org161928d">local_find</a></li>
<li><a href="#orge027548">ins_local</a></li>
<li><a href="#org1f594f3">set_local</a></li>
<li><a href="#org7252335">ins_set_local</a></li>
<li><a href="#orga33fefe">expose_local</a></li>
</ul>
</li>
<li><a href="#org1c058ec"><b>dynamic-local</b></a>
<ul>
<li><a href="#org2f48924">dynamic_local_find</a></li>
<li><a href="#org5213ec4">ins_dynamic_local</a></li>
<li><a href="#orge8dae45">set_dynamic_local</a></li>
<li><a href="#org9fc1eab">ins_set_dynamic_local</a></li>
<li><a href="#org23d819c">expose_dynamic_local</a></li>
</ul>
</li>
<li><a href="#orgdeda97"><b>compiler</b></a>
<ul>
<li><a href="#orga2b230">compiling_stack</a></li>
<li><a href="#orgb8edf44">emit</a></li>
<li><a href="#orgcecd9a6">emit_jojo_end</a></li>
<li><a href="#org19c55b9">about string pattern [syntax of jojo]</a>
<ul>
<li><a href="#orgcffa285">local_string_p</a></li>
<li><a href="#orgff4e122">set_local_string_p</a></li>
<li><a href="#org5ffd5b8">field_string_p</a></li>
<li><a href="#org9f3aa26">set_field_string_p</a></li>
<li><a href="#org69db9a9">tag_string_p</a></li>
</ul>
</li>
<li><a href="#orgee3684f">compile_jo</a></li>
<li><a href="#orgabb15bb">compile_until_meet_jo</a></li>
<li><a href="#org391f1fe">compile_until_meet_jo_or_jo</a></li>
<li><a href="#org3390f10">p_compile_until_round_ket</a></li>
<li><a href="#org6a8033d">compile_jojo_until_ket</a></li>
<li><a href="#orgc42ce52">expose_compiler</a></li>
</ul>
</li>
<li><a href="#org2a5f18e"><b>control</b></a>
<ul>
<li><a href="#orgfa571e3">k_ignore</a></li>
<li><a href="#orge12db62">ins_lit</a></li>
<li><a href="#org736f3ee">ins_jmp</a></li>
<li><a href="#orgbfd5f21">ins_jz</a></li>
<li><a href="#orgcbfa175">k_if</a></li>
<li><a href="#org29344b5">compile_maybe_square</a></li>
<li><a href="#orgec727c4">k_case</a></li>
<li><a href="#orgacaf5c1">k_cond</a></li>
<li><a href="#org87216b3">p_recur</a></li>
<li><a href="#orgcc13171">expose_control</a></li>
</ul>
</li>
<li><a href="#orgb9fc41e"><b>top</b></a>
<ul>
<li><a href="#org6a4ea86">test_flag</a></li>
<li><a href="#org70c611d">k_plus_data</a></li>
<li><a href="#org26f6e2b">k_arrow</a></li>
<li><a href="#orge5520f8">k_plus_jojo</a></li>
<li><a href="#orgf211582">expose_top</a></li>
</ul>
</li>
<li><a href="#org199376a"><b>repl</b></a>
<ul>
<li><a href="#orgfc26b66">local_env_print</a></li>
<li><a href="#orgdf32bce">data_print</a></li>
<li><a href="#org248c8a8">p_data_print</a></li>
<li><a href="#orgde700f9">jojo_print_one</a></li>
<li><a href="#org66ec0c3">jojo_print</a></li>
<li><a href="#orgbdf6a6b">p_print_ds</a></li>
<li><a href="#orgc09046f">print_return_point</a></li>
<li><a href="#orgfad9587">p_print_rs</a></li>
<li><a href="#org3f8a356">repl_flag</a></li>
<li><a href="#org30ef1a6">repl_one_step</a></li>
<li><a href="#org97c1a8a">repl</a></li>
<li><a href="#org8197579">debug_repl</a></li>
<li><a href="#org5ccd5b5">p_debug</a></li>
<li><a href="#org17507fd">to handle kernel signal</a>
<ul>
<li><a href="#org57c28c8"><span class="todo _note_">[note]</span> </a></li>
<li><a href="#orge64248">kernel_signal_handler</a></li>
<li><a href="#org59c2597">init_kernel_signal_handler</a></li>
</ul>
</li>
<li><a href="#orgccea3a5">expose_repl</a></li>
</ul>
</li>
<li><a href="#org5acd439">step</a>
<ul>
<li><a href="#orgbd0b760">report_one_step</a></li>
<li><a href="#org3c88594">eval_one_step_at_level</a></li>
<li><a href="#orgf8cc67c">p_step</a></li>
<li><a href="#orgced35e0">expose_step</a></li>
</ul>
</li>
<li><a href="#org3072416">&lt;bool&gt;</a>
<ul>
<li><a href="#orgb77bcbf">p_true</a></li>
<li><a href="#orgfcf31fa">p_false</a></li>
<li><a href="#org39cbc6f">p_not</a></li>
<li><a href="#orgbcf1a80">p_and</a></li>
<li><a href="#org96e8de6">p_or</a></li>
<li><a href="#org7247e4e">expose_bool</a></li>
</ul>
</li>
<li><a href="#org5f697ad">&lt;string&gt;</a>
<ul>
<li><a href="#org763a38a">new_string_gp</a></li>
<li><a href="#org144f78f">compile_string</a></li>
<li><a href="#org78a9eb">string_write</a></li>
<li><a href="#org64ead85">p_string_write</a></li>
<li><a href="#org8491b05">p_string_length</a></li>
<li><a href="#org5c69b41">p_string_ref</a></li>
<li><a href="#orge1e512">p_string_append</a></li>
<li><a href="#org7b62bc8">p_string_slice</a></li>
<li><a href="#orgbb7327e">p_string_empty_p</a></li>
<li><a href="#org780a7be">p_string_eq_p</a></li>
<li><a href="#org7256487">p_read_string</a></li>
<li><a href="#orgc02aef0">p_read_line</a></li>
<li><a href="#org447f054">p_string_to_jo</a></li>
<li><a href="#org5df19fa">expose_string</a></li>
</ul>
</li>
<li><a href="#orge146e9d">&lt;int&gt;</a>
<ul>
<li><a href="#orgb99e045">p_inc</a></li>
<li><a href="#org806b089">p_dec</a></li>
<li><a href="#org7f3506a">p_neg</a></li>
<li><a href="#org8892631">p_add</a></li>
<li><a href="#orge24957d">p_sub</a></li>
<li><a href="#org958fad">p_mul</a></li>
<li><a href="#org7f1cac4">p_div</a></li>
<li><a href="#org8364b5">p_mod</a></li>
<li><a href="#orgb2f1096">p_gt_p</a></li>
<li><a href="#orgbf41dbf">p_lt_p</a></li>
<li><a href="#orgbb09e24">p_gteq_p</a></li>
<li><a href="#org1aafce5">p_lteq_p</a></li>
<li><a href="#org17bcf5a">p_int_write</a></li>
<li><a href="#orga18686c">expose_int</a></li>
</ul>
</li>
<li><a href="#org99d716e">&lt;jo&gt;</a>
<ul>
<li><a href="#org88d89f8">special literal jo</a></li>
<li><a href="#orge9fad5b">p_jo_write</a></li>
<li><a href="#org262079e">p_jo_unread</a></li>
<li><a href="#orgb97919c">p_jo_apply</a></li>
<li><a href="#org6c0eff5">p_jo_to_int</a></li>
<li><a href="#orgb39ee5c">p_jo_to_byte</a></li>
<li><a href="#org907602c">p_int_jo_p</a></li>
<li><a href="#orgccd8afc">p_local_jo_p</a></li>
<li><a href="#org3cfac36">p_set_local_jo_p</a></li>
<li><a href="#org1d69b38">p_field_jo_p</a></li>
<li><a href="#orge833acc">p_set_field_jo_p</a></li>
<li><a href="#org317964f">p_tag_jo_p</a></li>
<li><a href="#org85ac8c1">underscore_string_p</a></li>
<li><a href="#org350f4d">p_underscore_jo_p</a></li>
<li><a href="#orge0e1f3c">p_get_local_jo_to_set_local_jo</a></li>
<li><a href="#org79f6a22">dynamic_local_string_p</a></li>
<li><a href="#orgcad49a4">set_dynamic_local_string_p</a></li>
<li><a href="#orgd02fd7e">p_dynamic_local_jo_p</a></li>
<li><a href="#org8e1a0ef">p_set_dynamic_local_jo_p</a></li>
<li><a href="#orgaa1d78a">p_jo_to_string</a></li>
<li><a href="#orga080dbf">p_jo_bound_p</a></li>
<li><a href="#orgf75fab6">p_jo_ref</a></li>
<li><a href="#orga27a990">expose_jo</a></li>
</ul>
</li>
<li><a href="#org2e532f0">&lt;address&gt;</a>
<ul>
<li><a href="#orga4ad3cd">p_compiling_stack_tos</a></li>
<li><a href="#org11f661f">p_compiling_stack_drop</a></li>
<li><a href="#org18393bb">p_compiling_stack_push</a></li>
<li><a href="#org17736b1">p_set_offset_to_here</a></li>
<li><a href="#org63385d8">p_tag_change</a></li>
<li><a href="#orgb74c8d1">p_allocate</a></li>
<li><a href="#org521e6b0">p_free</a></li>
<li><a href="#orgea2295b">p_set_cell</a></li>
<li><a href="#org19599dd">p_get_cell</a></li>
<li><a href="#orgddfd9d7">p_set_byte</a></li>
<li><a href="#org11eb1fb">p_get_byte</a></li>
<li><a href="#org30e67f6">expose_address</a></li>
</ul>
</li>
<li><a href="#org72906ca">&lt;array&gt;</a>
<ul>
<li><a href="#orgc65ca4f">new_array_gp</a></li>
<li><a href="#org122318a">p_new_array</a></li>
<li><a href="#orga648d86">p_array_length</a></li>
<li><a href="#orgfee2d19">p_array_ref</a></li>
<li><a href="#orgf34c0f6">p_array_set</a></li>
<li><a href="#orgd2d77e7">p_mark</a></li>
<li><a href="#org19bfe85">collect_find_length</a></li>
<li><a href="#org6e4a98d">p_collect</a></li>
<li><a href="#org9564b75">expose_array</a></li>
</ul>
</li>
<li><a href="#org5dbe836">&lt;closure&gt;</a>
<ul>
<li><a href="#orgc158cc7">gc_local_env</a></li>
<li><a href="#org9bfd202">current_local_record</a></li>
<li><a href="#org627b5dd">p_current_local_env</a></li>
<li><a href="#orgfdfa26a">set_local_record</a></li>
<li><a href="#org4a06e96">p_closure_exe</a></li>
<li><a href="#orgf62c099">k_closure</a></li>
<li><a href="#orgfd3795a">expose_closure</a></li>
</ul>
</li>
<li><a href="#org5bbd4c8">&lt;file&gt;</a>
<ul>
<li><a href="#orgba2f65c">p_error_number_print</a></li>
<li><a href="#org57184eb">path_open</a></li>
<li><a href="#orgff206b2">p_path_open_read</a></li>
<li><a href="#orgea84068">p_path_open_write</a></li>
<li><a href="#org918bcdd">p_path_open_read_and_write</a></li>
<li><a href="#orgb3ada7">p_path_open_create</a></li>
<li><a href="#org582db41">p_file_close</a></li>
<li><a href="#org572282a">p_file_read</a></li>
<li><a href="#org51a21ad">p_file_write</a></li>
<li><a href="#orga2da8b5">p_file_input_stack</a></li>
<li><a href="#org70d3c82">current_reading_dir</a></li>
<li><a href="#org6732990">p_current_reading_dir</a></li>
<li><a href="#orgdf7f67a">current_running_dir</a></li>
<li><a href="#org5f895fe">p_current_running_dir</a></li>
<li><a href="#orgd94f618">expose_file</a></li>
</ul>
</li>
<li><a href="#org22b34e6"><b>system</b></a>
<ul>
<li><a href="#orgdb26bae">p_cmd_number</a></li>
<li><a href="#org687ed95">p_index_to_cmd_string</a></li>
<li><a href="#org9e312e4">p_find_env_string</a></li>
<li><a href="#org6679f84">expose_system</a></li>
</ul>
</li>
<li><a href="#org97badbf"><b>lib</b></a>
<ul>
<li><a href="#org3eba553">TAG_LIB</a></li>
<li><a href="#orgce4dd17">p_lib_open</a></li>
<li><a href="#org3260f6a">p_lib_call</a></li>
<li><a href="#orgd458307">p_lib_set_cell</a></li>
<li><a href="#orgc59ab9f">expose_lib</a></li>
</ul>
</li>
<li><a href="#org93de330"><b>core</b></a>
<ul>
<li><a href="#org913bbb0">core_flag</a></li>
<li><a href="#orge29375f">load_core</a></li>
<li><a href="#orgd6fd36f">p_name_bind</a></li>
<li><a href="#org67f2801">p_name_rebind</a></li>
<li><a href="#orgfb64163">p_jo_emit</a></li>
<li><a href="#org69ace4a">p_emit_lit</a></li>
<li><a href="#org292992b">p_emit_zero</a></li>
<li><a href="#orga703a26">p_jo_emit_local</a></li>
<li><a href="#orga500774">p_jo_emit_set_local</a></li>
<li><a href="#orgebdc3dc">p_jo_emit_dynamic_local</a></li>
<li><a href="#org441d468">p_jo_emit_set_dynamic_local</a></li>
<li><a href="#org9bfb0a1">p_jo_emit_field</a></li>
<li><a href="#org1933416">p_jo_emit_set_field</a></li>
<li><a href="#org8371b98">p_emit_jz</a></li>
<li><a href="#org31676c">p_emit_jmp</a></li>
<li><a href="#orgf2ccfb6">p_name_bind_data</a></li>
<li><a href="#orgdd68094">p_name_bind_gene</a></li>
<li><a href="#org7e23312">p_name_bind_disp_to_jojo</a></li>
<li><a href="#orgc6a570f">p_name_bind_disp_defalut_to_jojo</a></li>
<li><a href="#orgb08ee32">p_name_bind_atom</a></li>
<li><a href="#orga0e0489">p_name_get</a></li>
<li><a href="#orgd4d22cf">p_class_to_tag</a></li>
<li><a href="#org85b60b8">p_cells_copy</a></li>
<li><a href="#org1ced0f4">expose_core</a></li>
</ul>
</li>
<li><a href="#org4990bab"><b>report</b></a>
<ul>
<li><a href="#orgef00ab2">report_local_record</a></li>
<li><a href="#org27b2fab">expose_report</a></li>
</ul>
</li>
<li><a href="#org343ad23"><b>play</b></a>
<ul>
<li><a href="#orgf8a7fb7">p1</a></li>
<li><a href="#org5380f39">expose_play</a></li>
</ul>
</li>
<li><a href="#orgb02a09b">init &amp; main</a>
<ul>
<li><a href="#orgaa4daf">init_system</a></li>
<li><a href="#org10ec9ef">init_jotable</a></li>
<li><a href="#orgd86cd77">init_literal_jo</a></li>
<li><a href="#org6b13392">init_stacks</a></li>
<li><a href="#org1f417d0">init_expose</a></li>
<li><a href="#org321a18b">main</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org75f71e6" class="outline-2">
<h2 id="org75f71e6"><span class="done _todo_stack_">[todo-stack]</span> </h2>
<div class="outline-text-2" id="text-org75f71e6">
</div><div id="outline-container-org5a3a197" class="outline-3">
<h3 id="org5a3a197">before any movement, learn more about interpreter and compiler</h3>
<div class="outline-text-3" id="text-org5a3a197">
<ul class="org-ul">
<li><p>currently, proper tail call is not handle well enough.</p></li></ul>
</div>
</div>

<div id="outline-container-orgf0b3eb8" class="outline-3">
<h3 id="orgf0b3eb8">[fix bug] gc_mark does not handle bindings of gene hash table</h3>
<div class="outline-text-3" id="text-orgf0b3eb8">
<ul class="org-ul">
<li><p>implement dispatching as jojo macro instead of implement it in c</p></li></ul>
</div>
</div>

<div id="outline-container-org64e277e" class="outline-3">
<h3 id="org64e277e">refactor the design of jojo</h3>
<div class="outline-text-3" id="text-org64e277e">
<ul class="org-ul">
<li><p>can we design a vm as the core ?</p><p>the vm would need :</p><p><ol class="org-ol"></p><p><li>jotable</li></p><p><li>gc &#x2013; and its interface</li></ol></p></li>

<li><p>the aim is still :</p><p><ol class="org-ol"></p><p><li>a dynamic-type-language</li></p><p><li>with simple interface to the underlying operating system</li></ol></p></li>

<li><p>before design a new version of jojo</p><p>we must first learn :</p><p><ol class="org-ol"></p><p><li>concurrency</li></p><p><li>parallelism</li></p><p><li>distributed computation</li></ol></p></li></ul>
</div>
</div>

<div id="outline-container-org8cf70c5" class="outline-3">
<h3 id="org8cf70c5">fix socket module</h3>
</div>

<div id="outline-container-orge4df093" class="outline-3">
<h3 id="orge4df093">fix name_record</h3>
<div class="outline-text-3" id="text-orge4df093">
<ul class="org-ul">
<li><p>name should not duplicate</p></li></ul>
</div>
</div>

<div id="outline-container-org50f3576" class="outline-3">
<h3 id="org50f3576">better jojo.h</h3>
</div>

<div id="outline-container-org9f91fd1" class="outline-3">
<h3 id="org9f91fd1">better file io</h3>
<div class="outline-text-3" id="text-org9f91fd1">
<ul class="org-ul">
<li><p>something like</p><p>with-output-to-string</p><p>with-output-to-file</p></li>

<li><p>with the help of &lt;input-stack&gt;</p><p>and the dynamic &lt;string&gt;</p></li></ul>
</div>
</div>

<div id="outline-container-org5cb68bd" class="outline-3">
<h3 id="org5cb68bd">time and sleep</h3>
</div>

<div id="outline-container-org6c6f33f" class="outline-3">
<h3 id="org6c6f33f">report address info for debug</h3>
</div>

<div id="outline-container-orgb43cede" class="outline-3">
<h3 id="orgb43cede">expose address_jo_p and address_gp_p for debug</h3>
</div>

<div id="outline-container-orga1c8294" class="outline-3">
<h3 id="orga1c8294">fix debug_repl</h3>
</div>

<div id="outline-container-orgeb85e2e" class="outline-3">
<h3 id="orgeb85e2e">report_local_record</h3>
</div>

<div id="outline-container-org7ea5f6" class="outline-3">
<h3 id="org7ea5f6">report_dynamic_local_record</h3>
</div>

<div id="outline-container-orgae48987" class="outline-3">
<h3 id="orgae48987">better p_debug</h3>
<div class="outline-text-3" id="text-orgae48987">
<ul class="org-ul">
<li><p>some call to p_debug can not return</p><p>this should be reported to user</p></li></ul>
</div>
</div>

<div id="outline-container-orgdd49961" class="outline-3">
<h3 id="orgdd49961">better p_step</h3>
</div>

<div id="outline-container-org2b4d869" class="outline-3">
<h3 id="org2b4d869">abstract the interface of jo</h3>
<div class="outline-text-3" id="text-org2b4d869">
<ul class="org-ul">
<li><p>currently jo_t is implemented as a pointer to struct</p><p>this fact should be abstracted away</p></li></ul>
</div>
</div>

<div id="outline-container-org87ae8a9" class="outline-3">
<h3 id="org87ae8a9">trace and untrace a jojo</h3>
</div>

<div id="outline-container-org86363b2" class="outline-3">
<h3 id="org86363b2">delimited continuation</h3>
<div class="outline-text-3" id="text-org86363b2">
<ul class="org-ul">
<li><p>to control rs [and ds]</p></li></ul>
</div>
</div>

<div id="outline-container-orgd958939" class="outline-3">
<h3 id="orgd958939">concurrent</h3>
<div class="outline-text-3" id="text-orgd958939">
<ul class="org-ul">
<li><p>use list to implement rs and ds in jojo</p><p>thus each group of stacks is a light weight process</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-orgfa1812b" class="outline-2">
<h2 id="orgfa1812b"><span class="todo _note_">[note]</span> </h2>
<div class="outline-text-2" id="text-orgfa1812b">
</div><div id="outline-container-org78d521e" class="outline-3">
<h3 id="org78d521e">interface convention</h3>
<div class="outline-text-3" id="text-org78d521e">
<ul class="org-ul">
<li><p>before trying to get something from somewhere,</p><p>first ask if it is there at all.</p></li>

<li><p>this convention can only be used</p><p>when condition race will not occur,</p><p>or when condition race is not important.</p></li></ul>
</div>
</div>

<div id="outline-container-orgfcb9610" class="outline-3">
<h3 id="orgfcb9610">important common sense</h3>
<div class="outline-text-3" id="text-orgfcb9610">
<ul class="org-ul">
<li><p>all programs are changings of state of machine</p></li>

<li><p>syntax-checker, type-checker, compiler are all special interpreters</p></li></ul>
</div>
</div>

<div id="outline-container-orga600bb1" class="outline-3">
<h3 id="orga600bb1">threaded code interpreter</h3>
<div class="outline-text-3" id="text-orga600bb1">
<ul class="org-ul">
<li><p>types of threaded code interpreter :</p><p><ol class="org-ol"></p><p><li>indirect threaded code</li></p><p><li>direct threaded code</li></p><p><li>token threaded code</li></p><p><li>subroutine threaded code</li></p><p><li>dynamic threaded code</p><p>[jotable] [symbol-hash-table [of lisp]]</li></ol></p></li>

<li><p>overhead of eval</p><p>base_pointer test [to be able to return to c function]</p></li></ul>
</div>
</div>

<div id="outline-container-orge5ca70a" class="outline-3">
<h3 id="orge5ca70a">limits</h3>
<div class="outline-text-3" id="text-orge5ca70a">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">name</th>
<th scope="col" class="org-left">length</th>
<th scope="col" class="org-left">unit</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">jojo_area</td>
<td class="org-left">64 * 1024</td>
<td class="org-left">jo_t</td>
</tr>

<tr>
<td class="org-left">jotable</td>
<td class="org-left">97 * 1024</td>
<td class="org-left">jotable_entry</td>
</tr>

<tr>
<td class="org-left">name_record</td>
<td class="org-left">16 * 1024</td>
<td class="org-left">jo_t</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">ds</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">dp</td>
</tr>

<tr>
<td class="org-left">rs</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">rp</td>
</tr>

<tr>
<td class="org-left">local_record</td>
<td class="org-left">16 * 1024</td>
<td class="org-left">local_point</td>
</tr>

<tr>
<td class="org-left">dynamic_local_record</td>
<td class="org-left">4 * 1024</td>
<td class="org-left">dynamic_local_point</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">compiling_stack</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">jo_t*</td>
</tr>

<tr>
<td class="org-left">reading_stack</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">input_stack</td>
</tr>

<tr>
<td class="org-left">writing_stack</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">output_stack</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf1ba0c5" class="outline-3">
<h3 id="orgf1ba0c5">input_stack &amp; output_stack</h3>
<div class="outline-text-3" id="text-orgf1ba0c5">
<ul class="org-ul">
<li><p>input_stack  push from high address to low address</p><p>pop  &#x2013; read</p><p>push &#x2013; unread</p></li>

<li><p>output_stack push from low address to high address</p><p>push &#x2013; write</p><p>pop  &#x2013; unwrite</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-orgb3902f3" class="outline-2">
<h2 id="orgb3902f3">header</h2>
<div class="outline-text-2" id="text-orgb3902f3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;sys/types.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;sys/stat.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;unistd.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;stdio.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;errno.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;string.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;fcntl.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;ctype.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;stdint.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;dlfcn.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;dirent.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;signal.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;limits.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;stdarg.h&gt;</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#include &lt;assert.h&gt;</span>
<span style="color: #a6e22e;">#include</span> <span style="color: #e6db74;">&lt;stdlib.h&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5cafebc" class="outline-2">
<h2 id="org5cafebc">type</h2>
<div class="outline-text-2" id="text-org5cafebc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">enum</span> { <span style="color: #ae81ff;">false</span>, <span style="color: #ae81ff;">true</span> } <span style="color: #66d9ef; font-weight: bold;">bool</span>;
<span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #66d9ef; font-weight: bold;">intptr_t</span> <span style="color: #66d9ef; font-weight: bold;">cell</span>;
<span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #66d9ef; font-weight: bold;">void</span> (* <span style="color: #66d9ef; font-weight: bold;">primitive_t</span>)();
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc85fc14" class="outline-2">
<h2 id="orgc85fc14">utility</h2>
<div class="outline-text-2" id="text-orgc85fc14">
</div><div id="outline-container-org8b5dc85" class="outline-3">
<h3 id="org8b5dc85">int</h3>
<div class="outline-text-3" id="text-org8b5dc85">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">max</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">a</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">b</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (a &lt; b) {
    <span style="color: #f92672; font-weight: bold;">return</span> b;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> a;
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">min</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">a</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">b</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (a &gt; b) {
    <span style="color: #f92672; font-weight: bold;">return</span> b;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> a;
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">power</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">a</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">n</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">result</span> = 1;
  <span style="color: #f92672; font-weight: bold;">while</span> (n &gt;= 1) {
    result = result * a;
    n--;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> result;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8e0584" class="outline-3">
<h3 id="orga8e0584">char</h3>
<div class="outline-text-3" id="text-orga8e0584">
</div><div id="outline-container-orgfa65884" class="outline-4">
<h4 id="orgfa65884">char_space_p</h4>
<div class="outline-text-4" id="text-orgfa65884">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">char_space_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> isspace(c);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga4a3905" class="outline-4">
<h4 id="orga4a3905">char_bar_ket_p</h4>
<div class="outline-text-4" id="text-orga4a3905">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">char_bar_ket_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> (c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'(</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">')</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'[</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">']</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'{</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'}</span><span style="color: #d33682; font-weight: bold;">'</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org62ec53" class="outline-4">
<h4 id="org62ec53">char_delimiter_p</h4>
<div class="outline-text-4" id="text-org62ec53">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">char_delimiter_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> (c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'(</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">')</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'[</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">']</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'{</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'}</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'"</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">',</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'`</span><span style="color: #d33682; font-weight: bold;">'</span> ||
          c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\''</span>);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd9cec7" class="outline-3">
<h3 id="orgcd9cec7">char_to_nat</h3>
<div class="outline-text-3" id="text-orgcd9cec7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">char_to_nat</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (c &gt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'0'</span> &amp;&amp; c &lt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'9</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> (c - <span style="color: #f8f8f0; background-color: #1b1d1e;">'0</span><span style="color: #d33682; font-weight: bold;">'</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (c &gt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'A'</span> &amp;&amp; c &lt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'Z</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> (c - <span style="color: #f8f8f0; background-color: #1b1d1e;">'A</span><span style="color: #d33682; font-weight: bold;">'</span>) + 10;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (c &gt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'a'</span> &amp;&amp; c &lt;= <span style="color: #f8f8f0; background-color: #1b1d1e;">'z</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> (c - <span style="color: #f8f8f0; background-color: #1b1d1e;">'a</span><span style="color: #d33682; font-weight: bold;">'</span>) + 10;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org933a6cc" class="outline-3">
<h3 id="org933a6cc">report</h3>
<div class="outline-text-3" id="text-org933a6cc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">format</span>, ...) {
  <span style="color: #66d9ef; font-weight: bold;">va_list</span> <span style="color: #fd971f;">arg_list</span>;
  va_start(arg_list, format);
  vdprintf(STDERR_FILENO, format, arg_list);
  va_end(arg_list);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6eda0de" class="outline-3">
<h3 id="org6eda0de">report_in_red</h3>
<div class="outline-text-3" id="text-org6eda0de">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report_in_red</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">format</span>, ...) {
  <span style="color: #66d9ef; font-weight: bold;">va_list</span> <span style="color: #fd971f;">arg_list</span>;
  va_start(arg_list, format);
  dprintf(STDERR_FILENO, <span style="color: #e6db74;">"\e[31m"</span>);
  vdprintf(STDERR_FILENO, format, arg_list);
  dprintf(STDERR_FILENO, <span style="color: #e6db74;">"\e[0m"</span>);
  va_end(arg_list);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org40abeed" class="outline-3">
<h3 id="org40abeed">report_in_green</h3>
<div class="outline-text-3" id="text-org40abeed">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report_in_green</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">format</span>, ...) {
  <span style="color: #66d9ef; font-weight: bold;">va_list</span> <span style="color: #fd971f;">arg_list</span>;
  va_start(arg_list, format);
  dprintf(STDERR_FILENO, <span style="color: #e6db74;">"\e[32m"</span>);
  vdprintf(STDERR_FILENO, format, arg_list);
  dprintf(STDERR_FILENO, <span style="color: #e6db74;">"\e[0m"</span>);
  va_end(arg_list);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d80796" class="outline-3">
<h3 id="org7d80796">string</h3>
<div class="outline-text-3" id="text-org7d80796">
</div><div id="outline-container-org720033b" class="outline-4">
<h4 id="org720033b">string_equal</h4>
<div class="outline-text-4" id="text-org720033b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">string_equal</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s1</span>, <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s2</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (strcmp(s1, s2) == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgebedd3d" class="outline-4">
<h4 id="orgebedd3d">nat_string_p</h4>
<div class="outline-text-4" id="text-orgebedd3d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">nat_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (str[i] != 0) {
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>isdigit(str[i])) {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
      }
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org79bd24a" class="outline-4">
<h4 id="org79bd24a">int_string_p</h4>
<div class="outline-text-4" id="text-org79bd24a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">int_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'-</span><span style="color: #d33682; font-weight: bold;">'</span> ||
      str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'+</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> nat_string_p(str + 1);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> nat_string_p(str);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8a8588" class="outline-4">
<h4 id="orga8a8588">string_to_based_nat &amp; string_to_based_int &amp; string_to_int</h4>
<div class="outline-text-4" id="text-orga8a8588">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_to_based_nat</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">base</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">result</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = strlen(str);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; len) {
    result = result + (char_to_nat(str[i]) * power(base, (len - i - 1)));
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> result;
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_to_based_int</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">base</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'-</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> - string_to_based_nat(str, base);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> string_to_based_nat(str, base);
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_to_int</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) { <span style="color: #f92672; font-weight: bold;">return</span> string_to_based_int(str, 10); }
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda97236" class="outline-4">
<h4 id="orgda97236">string_count_member</h4>
<div class="outline-text-4" id="text-orgda97236">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_count_member</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s</span>, <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">b</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (s[i] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (s[i] == b) {
      sum++;
    }
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> sum;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org76227d2" class="outline-4">
<h4 id="org76227d2">string_member_p</h4>
<div class="outline-text-4" id="text-org76227d2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">string_member_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s</span>, <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">b</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (s[i] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (s[i] == b) {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
    }
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd3f25c4" class="outline-4">
<h4 id="orgd3f25c4">string_last_byte</h4>
<div class="outline-text-4" id="text-orgd3f25c4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">string_last_byte</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (s[i+1] != 0) {
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> s[i];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f0f3e7" class="outline-4">
<h4 id="org8f0f3e7">substring</h4>
<div class="outline-text-4" id="text-org8f0f3e7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">substring</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">begin</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">end</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = strlen(str);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">buf</span> = strdup(str);
  buf[end] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  <span style="color: #f92672; font-weight: bold;">if</span> (begin == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> buf;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">s</span> = strdup(buf+begin);
    free(buf);
    <span style="color: #f92672; font-weight: bold;">return</span> s;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7b39a2a" class="outline-3">
<h3 id="org7b39a2a">array</h3>
<div class="outline-text-3" id="text-org7b39a2a">
</div><div id="outline-container-orgf594cf7" class="outline-4">
<h4 id="orgf594cf7">array_len_dup</h4>
<div class="outline-text-4" id="text-orgf594cf7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #a6e22e;">array_len_dup</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">src</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">p</span> = malloc(<span style="color: #66d9ef; font-weight: bold;">len</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  memcpy(p, src, <span style="color: #66d9ef; font-weight: bold;">len</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org55f76ac" class="outline-4">
<h4 id="org55f76ac">array_len</h4>
<div class="outline-text-4" id="text-org55f76ac">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">array_len</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">src</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (src[i] != 0) {
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> i;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3754889" class="outline-4">
<h4 id="org3754889">array_dup</h4>
<div class="outline-text-4" id="text-org3754889">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #a6e22e;">array_dup</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">src</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> array_len_dup(src, array_len(src) + 1);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd3d147" class="outline-4">
<h4 id="orgbd3d147">array_equal_p</h4>
<div class="outline-text-4" id="text-orgbd3d147">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">array_equal_p</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">a1</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">a2</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (a1[i] == a2[i]) {
      <span style="color: #f92672; font-weight: bold;">if</span> (a1[i] == 0) {
        <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
      }
      <span style="color: #f92672; font-weight: bold;">else</span> {
        <span style="color: #FF8888;">// </span><span style="color: #FF8888;">loop</span>
      }
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
    }
    i++;
  }
}
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org1d400e7" class="outline-2">
<h2 id="org1d400e7">debug</h2>
<div class="outline-text-2" id="text-org1d400e7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_debug</span>();
</pre>
</div>
</div>
</div>

<div id="outline-container-org1471fd0" class="outline-2">
<h2 id="org1471fd0">jotable</h2>
<div class="outline-text-2" id="text-org1471fd0">
</div><div id="outline-container-org501a37c" class="outline-3">
<h3 id="org501a37c">jotable_entry</h3>
<div class="outline-text-3" id="text-org501a37c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span> {
  <span style="color: #66d9ef; font-weight: bold;">char</span> *<span style="color: #fd971f;">key</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span> *<span style="color: #fd971f;">tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>;
};

<span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span>* <span style="color: #66d9ef; font-weight: bold;">jo_t</span>;

<span style="color: #FF8888;">// </span><span style="color: #FF8888;">prime table size</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">1000003   about 976 k</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">1000033</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">1000333</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">100003    about 97 k</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">100333</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">997</span>
<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">JOTABLE_SIZE</span> 100003
<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span> <span style="color: #fd971f;">jotable</span>[JOTABLE_SIZE];

<span style="color: #FF8888;">// </span><span style="color: #FF8888;">thus (jotable + index) is jo</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc99497d" class="outline-3">
<h3 id="orgc99497d">jo_bound_p</h3>
<div class="outline-text-3" id="text-orgc99497d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">jo_bound_p</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> jo-&gt;tag != 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org249d8bc" class="outline-3">
<h3 id="org249d8bc">string_to_sum</h3>
<div class="outline-text-3" id="text-org249d8bc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_to_sum</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">max_step</span> = 10;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; strlen(str)) {
    sum = sum + ((<span style="color: #66d9ef; font-weight: bold;">char</span>) str[i]) * (2 &lt;&lt; min(i, max_step));
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> sum;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d74ac7" class="outline-3">
<h3 id="org4d74ac7">jotable_hash</h3>
<div class="outline-text-3" id="text-org4d74ac7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">a hash an index into jotable</span>
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">jotable_hash</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">counter</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> (counter + sum) % JOTABLE_SIZE;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga7f712" class="outline-3">
<h3 id="orga7f712">jotable_insert</h3>
<div class="outline-text-3" id="text-orga7f712">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_debug</span>();

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">jotable_insert</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">key</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">in C : [string] -&gt; [jo]</span>
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span> = string_to_sum(key);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">counter</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = jotable_hash(sum, counter);
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = (jotable + index);
    <span style="color: #f92672; font-weight: bold;">if</span> (jo-&gt;key == 0) {
      key = strdup(key);
      jo-&gt;key = key;
      <span style="color: #f92672; font-weight: bold;">return</span> jo;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_equal(key, jo-&gt;key)) {
      <span style="color: #f92672; font-weight: bold;">return</span> jo;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (counter == JOTABLE_SIZE) {
      report(<span style="color: #e6db74;">"- jotable_insert fail\n"</span>);
      report(<span style="color: #e6db74;">"  the jotable is filled\n"</span>);
      p_debug();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      counter++;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf20af4" class="outline-3">
<h3 id="orgbf20af4">str2jo</h3>
<div class="outline-text-3" id="text-orgbf20af4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">str2jo</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> jotable_insert(str);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge6d9aa" class="outline-3">
<h3 id="orge6d9aa">jo2str</h3>
<div class="outline-text-3" id="text-orge6d9aa">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">jo2str</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> jo-&gt;key;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org58dc33f" class="outline-3">
<h3 id="org58dc33f">literal jo</h3>
<div class="outline-text-3" id="text-org58dc33f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">EMPTY_JO</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_PRIM</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_JOJO</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_CLOSURE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_ADDRESS</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_CLASS</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_LOCAL_ENV</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_BOOL</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_INT</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_BYTE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_STRING</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_ARRAY</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_JO</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_MARK</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_UNINITIALISED_FIELD_PLACE_HOLDER</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_FILE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_INPUT_STACK</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_DATA_PREDICATE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_DATA_CONSTRUCTOR</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_GENE</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ROUND_BAR</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ROUND_KET</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">SQUARE_BAR</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">SQUARE_KET</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">FLOWER_BAR</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">FLOWER_KET</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">DOUBLEQUOTE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">SINGLEQUOTE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">BACKQUOTE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">COMMA</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_LIT</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_LOCAL</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_SET_LOCAL</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_DYNAMIC_LOCAL</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_SET_DYNAMIC_LOCAL</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_FIELD</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_SET_FIELD</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_JMP</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_INS_JZ</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_NULL</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_THEN</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_ELSE</span>;

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_APPLY</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_EXE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_END</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_RECUR</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_CLOSURE</span>;
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">JO_CURRENT_LOCAL_ENV</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org268a421" class="outline-3">
<h3 id="org268a421">name_record</h3>
<div class="outline-text-3" id="text-org268a421">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name_record</span>[16 * 1024];
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">name_record_counter</span> = 0;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9c798c" class="outline-3">
<h3 id="orge9c798c">report_name_record</h3>
<div class="outline-text-3" id="text-orge9c798c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report_name_record</span>() {
  report(<span style="color: #e6db74;">"- name_record :\n"</span>);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; name_record_counter) {
    report(<span style="color: #e6db74;">"  %s\n"</span>, jo2str(name_record[i]));
    i++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b15fa6" class="outline-3">
<h3 id="org1b15fa6">bind_name</h3>
<div class="outline-text-3" id="text-org1b15fa6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #fd971f;">core_flag</span> = <span style="color: #ae81ff;">false</span>;
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">bind_name</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>,
               <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
               <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (jo_bound_p(name) &amp;&amp; <span style="color: #960050;">!</span>core_flag) {
    report(<span style="color: #e6db74;">"- bind_name can not rebind\n"</span>);
    report(<span style="color: #e6db74;">"  name : %s\n"</span>, jo2str(name));
    report(<span style="color: #e6db74;">"  tag : %s\n"</span>, jo2str(tag));
    report(<span style="color: #e6db74;">"  data : %ld\n"</span>, data);
    report(<span style="color: #e6db74;">"  it has been bound as a %s\n"</span>, jo2str(name-&gt;tag));
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  name_record[name_record_counter] = name;
  name_record_counter++;
  name_record[name_record_counter] = 0;

  name-&gt;tag = tag;
  name-&gt;data = data;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org439bacb" class="outline-3">
<h3 id="org439bacb">rebind_name</h3>
<div class="outline-text-3" id="text-org439bacb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">rebind_name</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>,
                 <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
                 <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  name-&gt;tag = tag;
  name-&gt;data = data;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7333773" class="outline-3">
<h3 id="org7333773">literal jo_array</h3>
<div class="outline-text-3" id="text-org7333773">
</div><div id="outline-container-org6273fe0" class="outline-4">
<h4 id="org6273fe0">generate_jo_array</h4>
<div class="outline-text-4" id="text-org6273fe0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #a6e22e;">generate_jo_array</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>*<span style="color: #fd971f;">ss</span>[]) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (ss[len] != 0) {
    len++;
  }
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">js</span> = malloc((len + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(jo_t));
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; len) {
    js[i] = str2jo(ss[i]);
    i++;
  }
  js[i] = 0;
  <span style="color: #f92672; font-weight: bold;">return</span> js;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org36a7295" class="outline-4">
<h4 id="org36a7295">macro</h4>
<div class="outline-text-4" id="text-org36a7295">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">J0</span> (<span style="color: #66d9ef; font-weight: bold;">char</span>*[]){0}
<span style="color: #a6e22e;">#define</span> <span style="color: #a6e22e;">J</span>(...) generate_jo_array((<span style="color: #66d9ef; font-weight: bold;">char</span>*[]){__VA_ARGS__, 0})
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1438f0" class="outline-3">
<h3 id="org1438f0">jo_bar_ket_p</h3>
<div class="outline-text-3" id="text-org1438f0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">jo_bar_ket_p</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(jo);
  <span style="color: #f92672; font-weight: bold;">if</span> (strlen(str) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> char_bar_ket_p(str[0]);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org22d4e12" class="outline-3">
<h3 id="org22d4e12">jo_delimiter_p</h3>
<div class="outline-text-3" id="text-org22d4e12">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">jo_delimiter_p</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(jo);
  <span style="color: #f92672; font-weight: bold;">if</span> (strlen(str) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> char_delimiter_p(str[0]);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbebd4d4" class="outline-3">
<h3 id="orgbebd4d4">in_jotable_p</h3>
<div class="outline-text-3" id="text-orgbebd4d4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">in_jotable_p</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">x</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = x;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">offset</span> = ((<span style="color: #66d9ef; font-weight: bold;">cell</span>)jo - (<span style="color: #66d9ef; font-weight: bold;">cell</span>)jotable);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">unit</span> = (<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span>));
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- in_jotable_p\n");</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  offset : %ld\n", offset);</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  unit : %ld\n", unit);</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  result : %ld\n", offset % unit);</span>
  <span style="color: #f92672; font-weight: bold;">if</span> (offset &lt;= 0) { <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>; }
  <span style="color: #f92672; font-weight: bold;">else</span> { <span style="color: #f92672; font-weight: bold;">return</span> offset % unit == 0; }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdba784e" class="outline-2">
<h2 id="orgdba784e">stack</h2>
<div class="outline-text-2" id="text-orgdba784e">
</div><div id="outline-container-orgb1727db" class="outline-3">
<h3 id="orgb1727db">stack_link</h3>
<div class="outline-text-3" id="text-orgb1727db">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span> {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">link</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org9277888" class="outline-3">
<h3 id="org9277888">stack</h3>
<div class="outline-text-3" id="text-org9277888">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span> {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">name</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">pointer</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">link</span>;
};

<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">STACK_BLOCK_SIZE</span> 1024
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#define STACK_BLOCK_SIZE 1 // for testing</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd67d791" class="outline-3">
<h3 id="orgd67d791">new_stack</h3>
<div class="outline-text-3" id="text-orgd67d791">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #a6e22e;">new_stack</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">name</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>));
  stack-&gt;name = name;
  stack-&gt;pointer = 0;
  stack-&gt;stack = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(cell) * STACK_BLOCK_SIZE);
  stack-&gt;link = 0;
  <span style="color: #f92672; font-weight: bold;">return</span> stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga1410c" class="outline-3">
<h3 id="orga1410c">stack_free</h3>
<div class="outline-text-3" id="text-orga1410c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">stack_free_link</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    stack_free_link(link-&gt;link);
    free(link-&gt;stack);
    free(link);
  }
}

<span style="color: #FF8888;">// </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">stack-&gt;name is not freed</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">stack_free</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  stack_free_link(stack-&gt;link);
  free(stack-&gt;stack);
  free(stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org31d4d5a" class="outline-3">
<h3 id="org31d4d5a">stack_block_underflow_check</h3>
<div class="outline-text-3" id="text-org31d4d5a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not pop</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for stack-&gt;pointer can not decrease under 0</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">stack_block_underflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (stack-&gt;pointer &gt; 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (stack-&gt;link != 0) {
    free(stack-&gt;stack);
    stack-&gt;stack = stack-&gt;link-&gt;stack;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">old_link</span> = stack-&gt;link;
    stack-&gt;link = stack-&gt;link-&gt;link;
    free(old_link);
    stack-&gt;pointer = STACK_BLOCK_SIZE;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  %s underflow\n"</span>, stack-&gt;name);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org50d1d73" class="outline-3">
<h3 id="org50d1d73">stack_block_overflow_check</h3>
<div class="outline-text-3" id="text-org50d1d73">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not push</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for stack-&gt;pointer can not increase over STACK_BLOCK_SIZE</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">stack_block_overflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (stack-&gt;pointer &lt; STACK_BLOCK_SIZE) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">new_link</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>));
    new_link-&gt;stack = stack-&gt;stack;
    new_link-&gt;link = stack-&gt;link;
    stack-&gt;link = new_link;
    stack-&gt;stack = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(cell) * STACK_BLOCK_SIZE);
    stack-&gt;pointer = 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org86f12bd" class="outline-3">
<h3 id="org86f12bd">stack_empty_p</h3>
<div class="outline-text-3" id="text-org86f12bd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">stack_empty_p</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span>
    stack-&gt;pointer == 0 &amp;&amp;
    stack-&gt;link == 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org140436a" class="outline-3">
<h3 id="org140436a">stack_length</h3>
<div class="outline-text-3" id="text-org140436a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">stack_length_link</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> sum;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> stack_length_link(sum + STACK_BLOCK_SIZE, link-&gt;link);
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">stack_length</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_length_link(stack-&gt;pointer, stack-&gt;link);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4a1139" class="outline-3">
<h3 id="orgb4a1139">pop</h3>
<div class="outline-text-3" id="text-orgb4a1139">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">pop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  stack_block_underflow_check(stack);
  stack-&gt;pointer--;
  <span style="color: #f92672; font-weight: bold;">return</span> stack-&gt;stack[stack-&gt;pointer];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc44b4fd" class="outline-3">
<h3 id="orgc44b4fd">tos</h3>
<div class="outline-text-3" id="text-orgc44b4fd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">tos</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  stack_block_underflow_check(stack);
  <span style="color: #f92672; font-weight: bold;">return</span> stack-&gt;stack[stack-&gt;pointer - 1];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7bec7e6" class="outline-3">
<h3 id="org7bec7e6">drop</h3>
<div class="outline-text-3" id="text-org7bec7e6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">drop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>) {
  stack_block_underflow_check(stack);
  stack-&gt;pointer--;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfde77c2" class="outline-3">
<h3 id="orgfde77c2">push</h3>
<div class="outline-text-3" id="text-orgfde77c2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">push</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  stack_block_overflow_check(stack);
  stack-&gt;stack[stack-&gt;pointer] = data;
  stack-&gt;pointer++;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga99a313" class="outline-3">
<h3 id="orga99a313">stack_peek</h3>
<div class="outline-text-3" id="text-orga99a313">
<ul class="org-ul">
<li><p>peek start from index 1</p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">stack_peek_link</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack_link</span>* <span style="color: #fd971f;">link</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (index &lt; STACK_BLOCK_SIZE) {
    <span style="color: #f92672; font-weight: bold;">return</span> link-&gt;stack[STACK_BLOCK_SIZE - index];
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> stack_peek_link(link-&gt;link, index - STACK_BLOCK_SIZE);
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">stack_peek</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (index &lt;= stack-&gt;pointer) {
    <span style="color: #f92672; font-weight: bold;">return</span> stack-&gt;stack[stack-&gt;pointer - index];
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> stack_peek_link(stack-&gt;link, index - stack-&gt;pointer);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6cfff8b" class="outline-3">
<h3 id="org6cfff8b">stack_ref</h3>
<div class="outline-text-3" id="text-org6cfff8b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">stack_ref</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">stack</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_peek(stack, stack_length(stack) - index);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce830bf" class="outline-2">
<h2 id="orgce830bf">input_stack</h2>
<div class="outline-text-2" id="text-orgce830bf">
</div><div id="outline-container-org85143d7" class="outline-3">
<h3 id="org85143d7"><span class="todo _note_">[note]</span> </h3>
<div class="outline-text-3" id="text-org85143d7">
<ul class="org-ul">
<li><p>free input_stack will not close the file.</p></li></ul>
</div>
</div>

<div id="outline-container-org566262e" class="outline-3">
<h3 id="org566262e">input_stack_type</h3>
<div class="outline-text-3" id="text-org566262e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">enum</span> {
  <span style="color: #fd971f;">INPUT_STACK_REGULAR_FILE</span>,
  <span style="color: #fd971f;">INPUT_STACK_STRING</span>,
  <span style="color: #fd971f;">INPUT_STACK_TERMINAL</span>,
} <span style="color: #66d9ef; font-weight: bold;">input_stack_type</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e799c0" class="outline-3">
<h3 id="org2e799c0">input_stack_link</h3>
<div class="outline-text-3" id="text-org2e799c0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span> {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">end_pointer</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>* <span style="color: #fd971f;">link</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org9131bee" class="outline-3">
<h3 id="org9131bee">input_stack</h3>
<div class="outline-text-3" id="text-org9131bee">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span> {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">pointer</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">end_pointer</span>;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>* <span style="color: #fd971f;">link</span>;
  <span style="color: #66d9ef; font-weight: bold;">input_stack_type</span> <span style="color: #fd971f;">type</span>;
  <span style="color: #f92672; font-weight: bold;">union</span> {
    <span style="color: #66d9ef; font-weight: bold;">int</span>   <span style="color: #fd971f;">file</span>;
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">string</span>;
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">int   terminal;</span>
  };
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">string_pointer</span>;
};

<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">INPUT_STACK_BLOCK_SIZE</span> (4 * 1024)
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#define INPUT_STACK_BLOCK_SIZE 1 // for testing</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4278034" class="outline-3">
<h3 id="org4278034">new_input_stack</h3>
<div class="outline-text-3" id="text-org4278034">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #a6e22e;">new_input_stack</span>(<span style="color: #66d9ef; font-weight: bold;">input_stack_type</span> <span style="color: #fd971f;">input_stack_type</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>));
  input_stack-&gt;pointer = INPUT_STACK_BLOCK_SIZE;
  input_stack-&gt;end_pointer = INPUT_STACK_BLOCK_SIZE;
  input_stack-&gt;stack = malloc(INPUT_STACK_BLOCK_SIZE);
  input_stack-&gt;link = 0;
  input_stack-&gt;type = input_stack_type;
  <span style="color: #f92672; font-weight: bold;">return</span> input_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdcdbeba" class="outline-3">
<h3 id="orgdcdbeba">file_input_stack</h3>
<div class="outline-text-3" id="text-orgdcdbeba">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #a6e22e;">file_input_stack</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">file</span>) {
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">file_flag</span> = fcntl(file, F_GETFL);
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">access_mode</span> = file_flag &amp; O_ACCMODE;
  <span style="color: #f92672; font-weight: bold;">if</span> (file_flag == -1) {
    report(<span style="color: #e6db74;">"- file_input_stack fail\n"</span>);
    perror(<span style="color: #e6db74;">"  fcntl error "</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span> = new_input_stack(INPUT_STACK_REGULAR_FILE);
  input_stack-&gt;file = file;
  <span style="color: #f92672; font-weight: bold;">return</span> input_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bfff43" class="outline-3">
<h3 id="org4bfff43">string_input_stack</h3>
<div class="outline-text-3" id="text-org4bfff43">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #a6e22e;">string_input_stack</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">string</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span> = new_input_stack(INPUT_STACK_STRING);
  input_stack-&gt;string = string;
  input_stack-&gt;string_pointer = 0;
  <span style="color: #f92672; font-weight: bold;">return</span> input_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org32acff6" class="outline-3">
<h3 id="org32acff6">terminal_input_stack</h3>
<div class="outline-text-3" id="text-org32acff6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #a6e22e;">terminal_input_stack</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span> = new_input_stack(INPUT_STACK_TERMINAL);
  <span style="color: #f92672; font-weight: bold;">return</span> input_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org86ed43c" class="outline-3">
<h3 id="org86ed43c">input_stack_free</h3>
<div class="outline-text-3" id="text-org86ed43c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_free_link</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    input_stack_free_link(link-&gt;link);
    free(link-&gt;stack);
    free(link);
  }
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_free</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  input_stack_free_link(input_stack-&gt;link);
  free(input_stack-&gt;stack);
  free(input_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org83b2134" class="outline-3">
<h3 id="org83b2134">input_stack_block_underflow_check</h3>
<div class="outline-text-3" id="text-org83b2134">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not pop</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for input_stack-&gt;pointer can not increase over input_stack-&gt;end_pointer</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_block_underflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;pointer &lt; input_stack-&gt;end_pointer) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;link != 0) {
    free(input_stack-&gt;stack);
    input_stack-&gt;stack = input_stack-&gt;link-&gt;stack;
    input_stack-&gt;end_pointer = input_stack-&gt;link-&gt;end_pointer;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>* <span style="color: #fd971f;">old_link</span> = input_stack-&gt;link;
    input_stack-&gt;link = input_stack-&gt;link-&gt;link;
    free(old_link);
    input_stack-&gt;pointer = 0;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_REGULAR_FILE) {
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = read(input_stack-&gt;file,
                              input_stack-&gt;stack,
                              INPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == 0) {
      report(<span style="color: #e6db74;">"- input_stack_block_underflow_check fail\n"</span>);
      report(<span style="color: #e6db74;">"  input_stack underflow\n"</span>);
      report(<span style="color: #e6db74;">"  meet end-of-file when reading a regular_file\n"</span>);
      report(<span style="color: #e6db74;">"  file descriptor : %ld\n"</span>, input_stack-&gt;file);
      p_debug();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      input_stack-&gt;pointer = 0;
      input_stack-&gt;end_pointer = real_bytes;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_STRING) {
    <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">byte</span> = input_stack-&gt;string[input_stack-&gt;string_pointer];
    <span style="color: #f92672; font-weight: bold;">if</span> (byte == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
      report(<span style="color: #e6db74;">"- input_stack_block_underflow_check fail\n"</span>);
      report(<span style="color: #e6db74;">"  input_stack underflow\n"</span>);
      report(<span style="color: #e6db74;">"  meet end-of-string when reading a string\n"</span>);
      p_debug();
    }
    input_stack-&gt;string_pointer++;
    input_stack-&gt;end_pointer = INPUT_STACK_BLOCK_SIZE;
    input_stack-&gt;pointer = INPUT_STACK_BLOCK_SIZE - 1;
    input_stack-&gt;stack[input_stack-&gt;pointer] = byte;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_TERMINAL) {
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = read(STDIN_FILENO,
                              input_stack-&gt;stack,
                              INPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == 0) {
      report(<span style="color: #e6db74;">"- input_stack_block_underflow_check fail\n"</span>);
      report(<span style="color: #e6db74;">"  input_stack underflow\n"</span>);
      report(<span style="color: #e6db74;">"  meet end-of-file when reading from terminal\n"</span>);
      p_debug();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      input_stack-&gt;pointer = 0;
      input_stack-&gt;end_pointer = real_bytes;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
  }

  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- input_stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  meet unknow stack type\n"</span>);
    report(<span style="color: #e6db74;">"  stack type number : %ld\n"</span>, input_stack-&gt;type);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org98145fd" class="outline-3">
<h3 id="org98145fd">input_stack_block_overflow_check</h3>
<div class="outline-text-3" id="text-org98145fd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not push</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for input_stack-&gt;pointer can not decrease under 0</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_block_overflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;pointer &gt; 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>* <span style="color: #fd971f;">new_link</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack_link</span>));
    new_link-&gt;stack = input_stack-&gt;stack;
    new_link-&gt;link = input_stack-&gt;link;
    new_link-&gt;end_pointer = input_stack-&gt;end_pointer;
    input_stack-&gt;link = new_link;
    input_stack-&gt;stack = malloc(INPUT_STACK_BLOCK_SIZE);
    input_stack-&gt;pointer = INPUT_STACK_BLOCK_SIZE;
    input_stack-&gt;end_pointer = INPUT_STACK_BLOCK_SIZE;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org28251ba" class="outline-3">
<h3 id="org28251ba">input_stack_empty_p</h3>
<div class="outline-text-3" id="text-org28251ba">
<ul class="org-ul">
<li><p><p></p><p>note the semantic of 'input_stack_empty_p'.</p><p></p></p><p></p><p><p></p><p>when one asks 'input_stack_empty_p',</p><p>there is already one byte readed from the input_stack,</p><p>and then unreaded.</p><p></p></p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">input_stack_empty_p</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;pointer != input_stack-&gt;end_pointer ||
      input_stack-&gt;link != 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_REGULAR_FILE) {
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = read(input_stack-&gt;file,
                              input_stack-&gt;stack,
                              INPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == 0) {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      input_stack-&gt;pointer = 0;
      input_stack-&gt;end_pointer = real_bytes;
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_STRING) {
    <span style="color: #f92672; font-weight: bold;">return</span> input_stack-&gt;string[input_stack-&gt;string_pointer] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (input_stack-&gt;type == INPUT_STACK_TERMINAL) {
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = read(STDIN_FILENO,
                              input_stack-&gt;stack,
                              INPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == 0) {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      input_stack-&gt;pointer = 0;
      input_stack-&gt;end_pointer = real_bytes;
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- input_stack_empty_p fail\n"</span>);
    report(<span style="color: #e6db74;">"  meet unknow input_stack type\n"</span>);
    report(<span style="color: #e6db74;">"  type code : %ld\n"</span>, input_stack-&gt;type);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb529372" class="outline-3">
<h3 id="orgb529372">input_stack_pop</h3>
<div class="outline-text-3" id="text-orgb529372">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">input_stack_pop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  input_stack_block_underflow_check(input_stack);
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">byte</span> = input_stack-&gt;stack[input_stack-&gt;pointer];
  input_stack-&gt;pointer++;
  <span style="color: #f92672; font-weight: bold;">return</span> byte;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org330e7bd" class="outline-3">
<h3 id="org330e7bd">input_stack_tos</h3>
<div class="outline-text-3" id="text-org330e7bd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">input_stack_tos</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  input_stack_block_underflow_check(input_stack);
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">byte</span> = input_stack-&gt;stack[input_stack-&gt;pointer];
  <span style="color: #f92672; font-weight: bold;">return</span> byte;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org66cc024" class="outline-3">
<h3 id="org66cc024">input_stack_drop</h3>
<div class="outline-text-3" id="text-org66cc024">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_drop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  input_stack_block_underflow_check(input_stack);
  input_stack-&gt;pointer++;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf443b3" class="outline-3">
<h3 id="orgbf443b3">input_stack_push</h3>
<div class="outline-text-3" id="text-orgbf443b3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">input_stack_push</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>, <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">byte</span>) {
  input_stack_block_overflow_check(input_stack);
  input_stack-&gt;pointer--;
  input_stack-&gt;stack[input_stack-&gt;pointer] = byte;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdd09f5a" class="outline-2">
<h2 id="orgdd09f5a">output_stack</h2>
<div class="outline-text-2" id="text-orgdd09f5a">
</div><div id="outline-container-org2e99f1d" class="outline-3">
<h3 id="org2e99f1d"><span class="todo _note_">[note]</span> </h3>
<div class="outline-text-3" id="text-org2e99f1d">
<ul class="org-ul">
<li><p>I will not seek the real file during pop and push.</p><p>and no undo for the terminal.</p></li>

<li><p>output to</p><p><ol class="org-ol"></p><p><li>file     &#x2013; the aim is to flush bytes to file</li></p><p><li>string   &#x2013; the aim is to collect bytes to string</li></p><p><li>terminal &#x2013; byte are directly printed to the terminal</li></ol></p></li>

<li><p>flush to file or collect to string</p><p>will not free the output_stack.</p></li>

<li><p>free output_stack will not close the file.</p></li></ul>
</div>
</div>

<div id="outline-container-org441f011" class="outline-3">
<h3 id="org441f011">output_stack_type</h3>
<div class="outline-text-3" id="text-org441f011">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">enum</span> {
  <span style="color: #fd971f;">OUTPUT_STACK_REGULAR_FILE</span>,
  <span style="color: #fd971f;">OUTPUT_STACK_STRING</span>,
  <span style="color: #fd971f;">OUTPUT_STACK_TERMINAL</span>,
} <span style="color: #66d9ef; font-weight: bold;">output_stack_type</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2840071" class="outline-3">
<h3 id="org2840071">output_stack_link</h3>
<div class="outline-text-3" id="text-org2840071">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span> {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf12b456" class="outline-3">
<h3 id="orgf12b456">output_stack</h3>
<div class="outline-text-3" id="text-orgf12b456">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span> {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">pointer</span>;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">stack</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>;
  <span style="color: #66d9ef; font-weight: bold;">output_stack_type</span> <span style="color: #fd971f;">type</span>;
  <span style="color: #f92672; font-weight: bold;">union</span> {
    <span style="color: #66d9ef; font-weight: bold;">int</span>   <span style="color: #fd971f;">file</span>; <span style="color: #FF8888;">// </span><span style="color: #FF8888;">with cache</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">char* string;</span>
    <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">generate string</span>
    <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">instead of output to pre-allocated buffer</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">int   terminal; // no cache</span>
  };
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">string_pointer</span>;
};

<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">OUTPUT_STACK_BLOCK_SIZE</span> (4 * 1024)
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#define OUTPUT_STACK_BLOCK_SIZE 1 // for testing</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8bfed5a" class="outline-3">
<h3 id="org8bfed5a">new_output_stack</h3>
<div class="outline-text-3" id="text-org8bfed5a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #a6e22e;">new_output_stack</span>(<span style="color: #66d9ef; font-weight: bold;">output_stack_type</span> <span style="color: #fd971f;">output_stack_type</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>));
  output_stack-&gt;pointer = 0;
  output_stack-&gt;stack = malloc(OUTPUT_STACK_BLOCK_SIZE);
  output_stack-&gt;link = 0;
  output_stack-&gt;type = output_stack_type;
  <span style="color: #f92672; font-weight: bold;">return</span> output_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org372bfc0" class="outline-3">
<h3 id="org372bfc0">file_output_stack</h3>
<div class="outline-text-3" id="text-org372bfc0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #a6e22e;">file_output_stack</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">file</span>) {
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">file_flag</span> = fcntl(file, F_GETFL);
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">access_mode</span> = file_flag &amp; O_ACCMODE;
  <span style="color: #f92672; font-weight: bold;">if</span> (file_flag == -1) {
    report(<span style="color: #e6db74;">"- file_output_stack fail\n"</span>);
    perror(<span style="color: #e6db74;">"  fcntl error "</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (access_mode == O_WRONLY || access_mode == O_RDWR) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span> = new_output_stack(OUTPUT_STACK_REGULAR_FILE);
    output_stack-&gt;file = file;
    <span style="color: #f92672; font-weight: bold;">return</span> output_stack;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- file_output_stack fail\n"</span>);
    report(<span style="color: #e6db74;">"  file_output_stack fail\n"</span>);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a76415" class="outline-3">
<h3 id="org4a76415">string_output_stack</h3>
<div class="outline-text-3" id="text-org4a76415">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #a6e22e;">string_output_stack</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span> = new_output_stack(OUTPUT_STACK_STRING);
  <span style="color: #f92672; font-weight: bold;">return</span> output_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1dd3a6" class="outline-3">
<h3 id="orgc1dd3a6">terminal_output_stack</h3>
<div class="outline-text-3" id="text-orgc1dd3a6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #a6e22e;">terminal_output_stack</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span> = new_output_stack(OUTPUT_STACK_TERMINAL);
  <span style="color: #f92672; font-weight: bold;">return</span> output_stack;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org527ae37" class="outline-3">
<h3 id="org527ae37">output_stack_free</h3>
<div class="outline-text-3" id="text-org527ae37">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_free_link</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    output_stack_free_link(link-&gt;link);
    free(link-&gt;stack);
    free(link);
  }
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_free</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  output_stack_free_link(output_stack-&gt;link);
  free(output_stack-&gt;stack);
  free(output_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ce296a" class="outline-3">
<h3 id="org6ce296a">file_output_stack_flush</h3>
<div class="outline-text-3" id="text-org6ce296a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">file_output_stack_flush_link</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">file</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    file_output_stack_flush_link(file, link-&gt;link);
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = write(file,
                               link-&gt;stack,
                               OUTPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes != OUTPUT_STACK_BLOCK_SIZE) {
      report(<span style="color: #e6db74;">"- file_output_stack_flush_link fail\n"</span>);
      report(<span style="color: #e6db74;">"  file descriptor : %ld\n"</span>, file);
      perror(<span style="color: #e6db74;">"  write error : "</span>);
      p_debug();
    }
  }
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">file_output_stack_flush</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  file_output_stack_flush_link(output_stack-&gt;file,
                               output_stack-&gt;link);
  <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = write(output_stack-&gt;file,
                             output_stack-&gt;stack,
                             output_stack-&gt;pointer);
  <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes != output_stack-&gt;pointer) {
    report(<span style="color: #e6db74;">"- file_output_stack_flush fail\n"</span>);
    report(<span style="color: #e6db74;">"  file descriptor : %ld\n"</span>, output_stack-&gt;file);
    perror(<span style="color: #e6db74;">"  write error : "</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    output_stack_free_link(output_stack-&gt;link);
    output_stack-&gt;link = 0;
    output_stack-&gt;pointer = 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org504788" class="outline-3">
<h3 id="org504788">string_output_stack_collect</h3>
<div class="outline-text-3" id="text-org504788">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_output_stack_length_link</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> sum;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span>
      OUTPUT_STACK_BLOCK_SIZE +
      string_output_stack_length_link(sum, link-&gt;link);
  }
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">string_output_stack_length</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span> = strlen(output_stack-&gt;stack);
  <span style="color: #f92672; font-weight: bold;">return</span> string_output_stack_length_link(sum, output_stack-&gt;link);
}


<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">string_output_stack_collect_link</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">buffer</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">link</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (link == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> buffer;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    buffer = string_output_stack_collect_link(buffer, link-&gt;link);
    memcpy(buffer, link-&gt;stack, OUTPUT_STACK_BLOCK_SIZE);
    <span style="color: #f92672; font-weight: bold;">return</span> buffer + OUTPUT_STACK_BLOCK_SIZE;
  }
}

<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">string_output_stack_collect</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">string</span> = malloc(1 + string_output_stack_length(output_stack));
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">buffer</span> = string;
  buffer = string_output_stack_collect_link(buffer, output_stack-&gt;link);
  memcpy(buffer, output_stack-&gt;stack, output_stack-&gt;pointer);
  buffer[output_stack-&gt;pointer] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  <span style="color: #f92672; font-weight: bold;">return</span> string;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org873e27" class="outline-3">
<h3 id="org873e27">output_stack_block_underflow_check</h3>
<div class="outline-text-3" id="text-org873e27">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not pop</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for output_stack-&gt;pointer can not decrease under 0</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_block_underflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;pointer &gt; 0) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;link != 0) {
    free(output_stack-&gt;stack);
    output_stack-&gt;stack = output_stack-&gt;link-&gt;stack;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">old_link</span> = output_stack-&gt;link;
    output_stack-&gt;link = output_stack-&gt;link-&gt;link;
    free(old_link);
    output_stack-&gt;pointer = OUTPUT_STACK_BLOCK_SIZE;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_REGULAR_FILE) {
    report(<span style="color: #e6db74;">"- output_stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  output_stack underflow\n"</span>);
    report(<span style="color: #e6db74;">"  when writing a regular_file\n"</span>);
    report(<span style="color: #e6db74;">"  file descriptor : %ld\n"</span>, output_stack-&gt;file);
    p_debug();
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_STRING) {
    report(<span style="color: #e6db74;">"- output_stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  output_stack underflow\n"</span>);
    report(<span style="color: #e6db74;">"  when writing a string\n"</span>);
    p_debug();
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_TERMINAL) {
    report(<span style="color: #e6db74;">"- output_stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  output_stack underflow\n"</span>);
    report(<span style="color: #e6db74;">"  when writing to terminal\n"</span>);
    p_debug();
  }

  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- output_stack_block_underflow_check fail\n"</span>);
    report(<span style="color: #e6db74;">"  meet unknow stack type\n"</span>);
    report(<span style="color: #e6db74;">"  stack type number : %ld\n"</span>, output_stack-&gt;type);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org726eef6" class="outline-3">
<h3 id="org726eef6">output_stack_block_overflow_check</h3>
<div class="outline-text-3" id="text-org726eef6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">can not push</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">for output_stack-&gt;pointer can not increase over OUTPUT_STACK_BLOCK_SIZE</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_block_overflow_check</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;pointer &lt; OUTPUT_STACK_BLOCK_SIZE) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>* <span style="color: #fd971f;">new_link</span> =
      malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack_link</span>));
    new_link-&gt;stack = output_stack-&gt;stack;
    new_link-&gt;link = output_stack-&gt;link;
    output_stack-&gt;link = new_link;
    output_stack-&gt;stack = malloc(OUTPUT_STACK_BLOCK_SIZE);
    output_stack-&gt;pointer = 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8ff301c" class="outline-3">
<h3 id="org8ff301c">output_stack_empty_p</h3>
<div class="outline-text-3" id="text-org8ff301c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">output_stack_empty_p</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;pointer != 0 ||
      output_stack-&gt;link != 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_REGULAR_FILE) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_STRING) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_TERMINAL) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- output_stack_empty_p fail\n"</span>);
    report(<span style="color: #e6db74;">"  meet unknow output_stack type\n"</span>);
    report(<span style="color: #e6db74;">"  type code : %ld\n"</span>, output_stack-&gt;type);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e92b67" class="outline-3">
<h3 id="org5e92b67">output_stack_pop</h3>
<div class="outline-text-3" id="text-org5e92b67">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">output_stack_pop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  output_stack_block_underflow_check(output_stack);
  output_stack-&gt;pointer--;
  <span style="color: #f92672; font-weight: bold;">return</span> output_stack-&gt;stack[output_stack-&gt;pointer];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org970bf4d" class="outline-3">
<h3 id="org970bf4d">output_stack_tos</h3>
<div class="outline-text-3" id="text-org970bf4d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">output_stack_tos</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  output_stack_block_underflow_check(output_stack);
  <span style="color: #f92672; font-weight: bold;">return</span> output_stack-&gt;stack[output_stack-&gt;pointer - 1];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b72f5f" class="outline-3">
<h3 id="org3b72f5f">output_stack_drop</h3>
<div class="outline-text-3" id="text-org3b72f5f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_drop</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>) {
  output_stack_block_underflow_check(output_stack);
  output_stack-&gt;pointer--;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org929f04c" class="outline-3">
<h3 id="org929f04c">output_stack_push</h3>
<div class="outline-text-3" id="text-org929f04c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">output_stack_push</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">output_stack</span>* <span style="color: #fd971f;">output_stack</span>, <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">b</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (output_stack-&gt;type == OUTPUT_STACK_TERMINAL) {
    <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buffer</span>[1];
    buffer[0] = b;
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = write(STDOUT_FILENO, buffer, 1);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes != 1) {
      report(<span style="color: #e6db74;">"- output_stack_push fail\n"</span>);
      perror(<span style="color: #e6db74;">"  write error : "</span>);
      p_debug();
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    output_stack_block_overflow_check(output_stack);
    output_stack-&gt;stack[output_stack-&gt;pointer] = b;
    output_stack-&gt;pointer++;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5244668" class="outline-2">
<h2 id="org5244668">ds &#x2013; data stack</h2>
<div class="outline-text-2" id="text-org5244668">
</div><div id="outline-container-org673c5b5" class="outline-3">
<h3 id="org673c5b5">ds</h3>
<div class="outline-text-3" id="text-org673c5b5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">t</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">d</span>;
};

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">ds</span>;

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #a6e22e;">ds_pop</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">p</span>;
  p.t = pop(ds);
  p.d = pop(ds);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ds_drop</span>() {
  drop(ds);
  drop(ds);
}

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #a6e22e;">ds_tos</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">p</span>;
  p.t = pop(ds);
  p.d = pop(ds);
  push(ds, p.d);
  push(ds, p.t);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">ds_empty_p</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_empty_p(ds);
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ds_push</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  push(ds, data);
  push(ds, tag);
}

<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">ds_peek_tag</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_peek(ds, (<span style="color: #66d9ef; font-weight: bold;">index</span>*2) - 1);
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">ds_peek_data</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_peek(ds, (<span style="color: #66d9ef; font-weight: bold;">index</span>*2));
}

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #a6e22e;">ds_ref</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">p</span>;
  p.t = stack_ref(ds, <span style="color: #66d9ef; font-weight: bold;">index</span>*2 + 1);
  p.d = stack_ref(ds, <span style="color: #66d9ef; font-weight: bold;">index</span>*2 + 0);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">ds_length</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_length(ds) / 2;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce9bb06" class="outline-2">
<h2 id="orgce9bb06">rs &#x2013; return stack</h2>
<div class="outline-text-2" id="text-orgce9bb06">
</div><div id="outline-container-org4b01535" class="outline-3">
<h3 id="org4b01535">local</h3>
<div class="outline-text-3" id="text-org4b01535">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">local_tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">local_data</span>;
};

<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">LOCAL_RECORD_SIZE</span> (16 * 1024)
<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span> <span style="color: #fd971f;">local_record</span>[LOCAL_RECORD_SIZE];
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">current_local_counter</span> = 0;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e84cf9" class="outline-3">
<h3 id="org9e84cf9">dynamic_local</h3>
<div class="outline-text-3" id="text-org9e84cf9">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dynamic_local</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">dynamic_local_tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">dynamic_local_data</span>;
};

<span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">DYNAMIC_LOCAL_RECORD_SIZE</span> (4 * 1024)
<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dynamic_local</span> <span style="color: #fd971f;">dynamic_local_record</span>[DYNAMIC_LOCAL_RECORD_SIZE];
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">current_dynamic_local_counter</span> = 0;
</pre>
</div>
</div>
</div>

<div id="outline-container-org42f274a" class="outline-3">
<h3 id="org42f274a">rs</h3>
<div class="outline-text-3" id="text-org42f274a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">j</span>;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>  <span style="color: #fd971f;">t</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>  <span style="color: #fd971f;">d</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>  <span style="color: #fd971f;">l</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>  <span style="color: #fd971f;">y</span>;
};

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">rs</span>;

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #a6e22e;">rs_pop</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span>;
  p.j = pop(rs);
  p.t = pop(rs);
  p.d = pop(rs);
  p.l = pop(rs);
  p.y = pop(rs);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">rs_drop</span>() {
  drop(rs);
  drop(rs);
  drop(rs);
  drop(rs);
  drop(rs);
}

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #a6e22e;">rs_tos</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span>;
  p.j = stack_peek(rs, 1);
  p.t = stack_peek(rs, 2);
  p.d = stack_peek(rs, 3);
  p.l = stack_peek(rs, 4);
  p.y = stack_peek(rs, 5);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">rs_empty_p</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_empty_p(rs);
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">rs_push</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>,
             <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
             <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>,
             <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">local_counter</span>,
             <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">dynamic_local_counter</span>) {
  push(rs, dynamic_local_counter);
  push(rs, local_counter);
  push(rs, data);
  push(rs, tag);
  push(rs, jojo);
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">rs_length</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> stack_length(rs) / 5;
}

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #a6e22e;">rs_ref</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span>;
  p.j = stack_ref(rs, <span style="color: #66d9ef; font-weight: bold;">index</span>*5 + 4);
  p.t = stack_ref(rs, <span style="color: #66d9ef; font-weight: bold;">index</span>*5 + 3);
  p.d = stack_ref(rs, <span style="color: #66d9ef; font-weight: bold;">index</span>*5 + 2);
  p.l = stack_ref(rs, <span style="color: #66d9ef; font-weight: bold;">index</span>*5 + 1);
  p.y = stack_ref(rs, <span style="color: #66d9ef; font-weight: bold;">index</span>*5 + 0);
  <span style="color: #f92672; font-weight: bold;">return</span> p;
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">rs_inc</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = pop(rs);
  push(rs, jojo + 1);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2c11914" class="outline-2">
<h2 id="org2c11914"><b>gc</b></h2>
<div class="outline-text-2" id="text-org2c11914">
</div><div id="outline-container-org3135fbb" class="outline-3">
<h3 id="org3135fbb">struct gp</h3>
<div class="outline-text-3" id="text-org3135fbb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">enum</span> {
  <span style="color: #fd971f;">GC_MARK_FREE</span>,
  <span style="color: #fd971f;">GC_MARK_USING</span>,
} <span style="color: #66d9ef; font-weight: bold;">gc_mark_t</span>;

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span> { <span style="color: #FF8888;">// </span><span style="color: #FF8888;">gc point</span>
  <span style="color: #66d9ef; font-weight: bold;">gc_mark_t</span> <span style="color: #fd971f;">mark</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">p</span>; <span style="color: #FF8888;">// </span><span style="color: #FF8888;">actual data point</span>
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org6564da8" class="outline-3">
<h3 id="org6564da8">gr &#x2013; gc record</h3>
<div class="outline-text-3" id="text-org6564da8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">GR_SIZE</span> 64 * 1024
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#define GR_SIZE 1024</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">#define GR_SIZE 3 // for testing</span>

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span> <span style="color: #fd971f;">gr</span>[GR_SIZE];
<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gr_pointer</span> = gr;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6097b7b" class="outline-3">
<h3 id="org6097b7b">gr_end_p</h3>
<div class="outline-text-3" id="text-org6097b7b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">gr_end_p</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> gr_pointer &gt;= (gr + GR_SIZE);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org84b5daf" class="outline-3">
<h3 id="org84b5daf">init_gr</h3>
<div class="outline-text-3" id="text-org84b5daf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_gr</span>() {
  bzero(gr, <span style="color: #66d9ef; font-weight: bold;">GR_SIZE</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org63e33de" class="outline-3">
<h3 id="org63e33de">struct class</h3>
<div class="outline-text-3" id="text-org63e33de">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #f92672; font-weight: bold;">enum</span> {
  <span style="color: #fd971f;">GC_STATE_MARKING</span>,
  <span style="color: #fd971f;">GC_STATE_SWEEPING</span>,
} <span style="color: #66d9ef; font-weight: bold;">gc_state_t</span>;

<span style="color: #f92672; font-weight: bold;">typedef</span> <span style="color: #66d9ef; font-weight: bold;">void</span> (* <span style="color: #66d9ef; font-weight: bold;">gc_actor_t</span>)(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span>, cell);

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">class_name</span>;
  <span style="color: #66d9ef; font-weight: bold;">gc_actor_t</span> <span style="color: #fd971f;">gc_actor</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">fields_number</span>;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">fields</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf54d70" class="outline-3">
<h3 id="orgaf54d70">get &amp; set field</h3>
<div class="outline-text-3" id="text-orgaf54d70">
<ul class="org-ul">
<li><p>to abstract the order of tag and data in memory.</p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">get_field_tag</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> fields[field_index*2+1];
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_field_tag</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>) {
  fields[field_index*2+1] = tag;
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">get_field_data</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> fields[field_index*2];
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_field_data</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  fields[field_index*2] = data;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf57145f" class="outline-3">
<h3 id="orgf57145f">class_index_to_field_name</h3>
<div class="outline-text-3" id="text-orgf57145f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">assume exist</span>
<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">class_index_to_field_name</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> class-&gt;fields[index];
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d22fb3" class="outline-3">
<h3 id="org9d22fb3">class_field_name_to_index</h3>
<div class="outline-text-3" id="text-org9d22fb3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">assume exist</span>
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">class_field_name_to_index</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">field_name</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; class-&gt;fields_number) {
    <span style="color: #f92672; font-weight: bold;">if</span> (class-&gt;fields[i] == field_name) { <span style="color: #f92672; font-weight: bold;">return</span> i; }
    i++;
  }
  report(<span style="color: #e6db74;">"- class_field_name_to_index fail\n"</span>);
  report(<span style="color: #e6db74;">"  field_name : %s\n"</span>, jo2str(field_name));
  report(<span style="color: #e6db74;">"  class_name : %s\n"</span>, jo2str(class-&gt;class_name));
  p_debug();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffd96d1" class="outline-3">
<h3 id="orgffd96d1">get &amp; set gp field</h3>
<div class="outline-text-3" id="text-orgffd96d1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">get_gp_field_tag</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span> = gp-&gt;p;
  <span style="color: #f92672; font-weight: bold;">return</span> get_field_tag(fields, field_index);
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_gp_field_tag</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>,
                      <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>,
                      <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span> = gp-&gt;p;
  set_field_tag(fields, field_index, tag);
}

<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">get_gp_field_data</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span> = gp-&gt;p;
  <span style="color: #f92672; font-weight: bold;">return</span> get_field_data(fields, field_index);
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_gp_field_data</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>,
                       <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">field_index</span>,
                       <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span> = gp-&gt;p;
  set_field_data(fields, field_index, data);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org211e95f" class="outline-3">
<h3 id="org211e95f">get_field</h3>
<div class="outline-text-3" id="text-org211e95f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #a6e22e;">get_field</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">class_tag</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = class_tag-&gt;data;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = class_field_name_to_index(class, name);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span> = get_gp_field_tag(gp, index);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span> = get_gp_field_data(gp, index);

  <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_UNINITIALISED_FIELD_PLACE_HOLDER) {
    ds_push(class_tag, gp);
    report(<span style="color: #e6db74;">"- get_field fail\n"</span>);
    report(<span style="color: #e6db74;">"  field is uninitialised\n"</span>);
    report(<span style="color: #e6db74;">"  field_name : %s\n"</span>, jo2str(name));
    report(<span style="color: #e6db74;">"  class_name : %s\n"</span>, jo2str(class-&gt;class_name));
    report(<span style="color: #e6db74;">"  see top of ds for the data\n"</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span>;
    a.t = tag;
    a.d = data;
    <span style="color: #f92672; font-weight: bold;">return</span> a;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org946e25b" class="outline-3">
<h3 id="org946e25b">ins_get_field</h3>
<div class="outline-text-3" id="text-org946e25b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_get_field</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = a.t-&gt;data;

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = class_field_name_to_index(class, name);

  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span> = get_gp_field_tag(a.d, index);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span> = get_gp_field_data(a.d, index);
  <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_UNINITIALISED_FIELD_PLACE_HOLDER) {
    ds_push(a.t, a.d);
    report(<span style="color: #e6db74;">"- ins_get_field fail\n"</span>);
    report(<span style="color: #e6db74;">"  field is uninitialised\n"</span>);
    report(<span style="color: #e6db74;">"  field_name : %s\n"</span>, jo2str(name));
    report(<span style="color: #e6db74;">"  class_name : %s\n"</span>, jo2str(class-&gt;class_name));
    report(<span style="color: #e6db74;">"  see top of ds for the data\n"</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(tag, data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb53ddfd" class="outline-3">
<h3 id="orgb53ddfd">ins_set_field</h3>
<div class="outline-text-3" id="text-orgb53ddfd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_set_field</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = a.t-&gt;data;

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = class_field_name_to_index(class, name);

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  set_gp_field_tag(a.d, index, b.t);
  set_gp_field_data(a.d, index, b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce519b7" class="outline-3">
<h3 id="orgce519b7">mark_one_data</h3>
<div class="outline-text-3" id="text-orgce519b7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">mark_one_data</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- mark_one_data begin\n");</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">if (!in_jotable_p(tag)) { report("  bad-tag : %ld\n", tag); }</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">else { report("  tag : %s\n", jo2str(tag)); }</span>

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = tag-&gt;data;
  class-&gt;gc_actor(GC_STATE_MARKING, data);

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- mark_one_data end\n");</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orged62c75" class="outline-3">
<h3 id="orged62c75">mark_gr</h3>
<div class="outline-text-3" id="text-orged62c75">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">mark_gr</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">prepare</span>
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; GR_SIZE) {
    gr[i].mark = GC_MARK_FREE;
    i++;
  }

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">name_record as root</span>
  i = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; name_record_counter) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = name_record[i];
    mark_one_data(name-&gt;tag, name-&gt;data);
    i++;
  }

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">ds as root</span>
  i = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; ds_length()) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_ref(i);
    mark_one_data(a.t, a.d);
    i++;
  }

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">local_record as root</span>
  i = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; current_local_counter) {
    mark_one_data(local_record[i].local_tag,
                  local_record[i].local_data);
    i++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce4ed88" class="outline-3">
<h3 id="orgce4ed88">sweep_one_gp</h3>
<div class="outline-text-3" id="text-orgce4ed88">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">sweep_one_gp</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gp-&gt;mark == GC_MARK_USING) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    gp-&gt;class-&gt;gc_actor(GC_STATE_SWEEPING, gp);
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga6b4938" class="outline-3">
<h3 id="orga6b4938">sweep_gr</h3>
<div class="outline-text-3" id="text-orga6b4938">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">sweep_gr</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; GR_SIZE) {
    sweep_one_gp(gr + i);
    i++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4c8458" class="outline-3">
<h3 id="orgb4c8458">run_gc</h3>
<div class="outline-text-3" id="text-orgb4c8458">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">run_gc</span>() {
  mark_gr();
  sweep_gr();
}

<span style="color: #FF8888;">// </span><span style="color: #FF8888;">void run_gc() {</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">report("- run_gc()\n");</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">mark_gr();</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">report("- after mark_gr()\n");</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">sweep_gr();</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">report("- after sweep_gr()\n");</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">sleep(1);</span>
<span style="color: #FF8888;">// </span><span style="color: #FF8888;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbdd7702" class="outline-3">
<h3 id="orgbdd7702">basic gc actors</h3>
<div class="outline-text-3" id="text-orgbdd7702">
</div><div id="outline-container-org948ced8" class="outline-4">
<h4 id="org948ced8">gc_ignore</h4>
<div class="outline-text-4" id="text-org948ced8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">gc_ignore</span>(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span> <span style="color: #fd971f;">gc_state</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_MARKING) {
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_SWEEPING) {
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f7816" class="outline-4">
<h4 id="org7f7816">gc_free</h4>
<div class="outline-text-4" id="text-org7f7816">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">gc_free</span>(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span> <span style="color: #fd971f;">gc_state</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_MARKING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_red("- gc_free : GC_STATE_MARKING\n");</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">sleep(1);</span>
    gp-&gt;mark = GC_MARK_USING;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_SWEEPING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_green("- gc_free : GC_STATE_SWEEPING\n");</span>
    free(gp-&gt;p);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6212279" class="outline-4">
<h4 id="org6212279">gc_recur</h4>
<div class="outline-text-4" id="text-org6212279">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">gc_recur</span>(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span> <span style="color: #fd971f;">gc_state</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_MARKING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_red("- gc_recur : GC_STATE_MARKING\n");</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">sleep(1);</span>
    <span style="color: #f92672; font-weight: bold;">if</span> (gp-&gt;mark == GC_MARK_USING) { <span style="color: #f92672; font-weight: bold;">return</span>; }
    gp-&gt;mark = GC_MARK_USING;
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">fields_number</span> = gp-&gt;class-&gt;fields_number;
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
    <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; fields_number) {
      mark_one_data(get_gp_field_tag(gp, i),
                    get_gp_field_data(gp, i));
      i++;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_SWEEPING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_green("- gc_recur : GC_STATE_SWEEPING\n");</span>
    free(gp-&gt;p);
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5422af3" class="outline-3">
<h3 id="org5422af3">new_record_gp</h3>
<div class="outline-text-3" id="text-org5422af3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">next_free_record_gp</span>() {
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #960050;">!</span>gr_end_p() &amp;&amp;
         gr_pointer-&gt;mark != GC_MARK_FREE) {
    gr_pointer++;
  }
}

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #a6e22e;">new_record_gp</span>() {
  next_free_record_gp();
  <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>gr_end_p()) {
    <span style="color: #f92672; font-weight: bold;">return</span> gr_pointer++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    run_gc();
    gr_pointer = gr;
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>gr_end_p()) {
      <span style="color: #f92672; font-weight: bold;">return</span> gr_pointer++;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      report(<span style="color: #e6db74;">"- new_record_gp fail\n"</span>);
      report(<span style="color: #e6db74;">"  after gc, the gr is still filled\n"</span>);
      report(<span style="color: #e6db74;">"  GR_SIZE : %ld\n"</span>, GR_SIZE);
      <span style="color: #f92672; font-weight: bold;">return</span> 0;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org473c790" class="outline-3">
<h3 id="org473c790">plus_atom</h3>
<div class="outline-text-3" id="text-org473c790">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_atom</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">class_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">gc_actor_t</span> <span style="color: #fd971f;">gc_actor</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>));
  class-&gt;class_name = str2jo(class_name);
  class-&gt;gc_actor = gc_actor;

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_class_name</span> = strlen(class_name);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_constructor_name</span> = length_of_class_name -2;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_predicate_name</span> = length_of_class_name -1;

  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(class_name);
  bind_name(name, TAG_CLASS, class);

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(class_name, 1, length_of_class_name -1);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">data_constructor_name</span> = str2jo(tmp);
  free(tmp);

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp2</span> = malloc(1 + length_of_predicate_name);
  tmp2[0] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  strcat(tmp2, jo2str(data_constructor_name));
  strcat(tmp2, <span style="color: #e6db74;">"?"</span>);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">data_predicate_name</span> = str2jo(tmp2);
  free(tmp2);

  bind_name(data_predicate_name, TAG_DATA_PREDICATE, class);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3e69867" class="outline-3">
<h3 id="org3e69867">plus_data</h3>
<div class="outline-text-3" id="text-org3e69867">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">argument 'fields' is shared</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_data</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">class_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">fields</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>));
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(class_name);

  class-&gt;class_name = name;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (fields[i] != 0) {
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">if</span> (i == 0) {
    class-&gt;gc_actor = gc_ignore;
    class-&gt;fields_number = i;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    class-&gt;gc_actor = gc_recur;
    class-&gt;fields_number = i;
    class-&gt;fields = fields;
  }

  bind_name(name, TAG_CLASS, class);

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_class_name</span> = strlen(class_name);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_constructor_name</span> = length_of_class_name -2;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length_of_predicate_name</span> = length_of_class_name -1;

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(class_name, 1, length_of_class_name -1);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">data_constructor_name</span> = str2jo(tmp);
  free(tmp);

  bind_name(data_constructor_name, TAG_DATA_CONSTRUCTOR, class);

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp2</span> = malloc(1 + length_of_predicate_name);
  tmp2[0] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  strcat(tmp2, jo2str(data_constructor_name));
  strcat(tmp2, <span style="color: #e6db74;">"?"</span>);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">data_predicate_name</span> = str2jo(tmp2);
  free(tmp2);

  bind_name(data_predicate_name, TAG_DATA_PREDICATE, class);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgadc0b4" class="outline-3">
<h3 id="orgadc0b4">plus_prim</h3>
<div class="outline-text-3" id="text-orgadc0b4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_prim</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">function_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">primitive_t</span> <span style="color: #fd971f;">fun</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(function_name);
  bind_name(name, TAG_PRIM, fun);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fae0a7" class="outline-3">
<h3 id="org3fae0a7">p_tag</h3>
<div class="outline-text-3" id="text-org3fae0a7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_tag</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_JO, a.t);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcee0d6f" class="outline-3">
<h3 id="orgcee0d6f">p_eq_p</h3>
<div class="outline-text-3" id="text-orgcee0d6f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_eq_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, (b.t == a.t) &amp;&amp; (b.d == a.d));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgac337c4" class="outline-3">
<h3 id="orgac337c4">p_new</h3>
<div class="outline-text-3" id="text-orgac337c4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_new</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">fields_number</span> = class-&gt;fields_number;

  <span style="color: #f92672; font-weight: bold;">if</span> (fields_number == 0) {
    ds_push(class-&gt;class_name, 0);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = new_record_gp();
    gp-&gt;class = class;

    <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">fields</span> = malloc(<span style="color: #66d9ef; font-weight: bold;">fields_number</span>*2*<span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
    <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; fields_number) {
      <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
      set_field_tag(fields, (fields_number - (i+1)), a.t);
      set_field_data(fields, (fields_number - (i+1)), a.d);
      i++;
    }
    gp-&gt;p = fields;

    ds_push(class-&gt;class_name, gp);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc90bfc3" class="outline-3">
<h3 id="orgc90bfc3">expose_gc</h3>
<div class="outline-text-3" id="text-orgc90bfc3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_gc</span>() {
  init_gr();

  plus_prim(<span style="color: #e6db74;">"ins/field"</span>, ins_get_field);
  plus_prim(<span style="color: #e6db74;">"ins/set-field"</span>, ins_set_field);

  plus_atom(<span style="color: #e6db74;">"&lt;class&gt;"</span>, gc_ignore);

  plus_atom(<span style="color: #e6db74;">"&lt;byte&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;int&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;jo&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;string&gt;"</span>, gc_free);
  plus_atom(<span style="color: #e6db74;">"&lt;gene&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;uninitialised-field-place-holder&gt;"</span>, gc_ignore);

  plus_atom(<span style="color: #e6db74;">"&lt;prim&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;address&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;data-constructor&gt;"</span>, gc_ignore);
  plus_atom(<span style="color: #e6db74;">"&lt;data-predicate&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"gc-ignore"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"tag"</span>, p_tag);
  plus_prim(<span style="color: #e6db74;">"eq?"</span>, p_eq_p);

  plus_prim(<span style="color: #e6db74;">"new"</span>, p_new);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7d505a0" class="outline-2">
<h2 id="org7d505a0">&lt;jojo&gt;</h2>
<div class="outline-text-2" id="text-org7d505a0">
</div><div id="outline-container-orgb87f278" class="outline-3">
<h3 id="orgb87f278">new_jojo_gp</h3>
<div class="outline-text-3" id="text-orgb87f278">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #a6e22e;">new_jojo_gp</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = TAG_JOJO-&gt;data;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = new_record_gp();
  gp-&gt;class = class;
  gp-&gt;p = jojo;
  <span style="color: #f92672; font-weight: bold;">return</span> gp;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ef244e" class="outline-3">
<h3 id="org6ef244e">jojo_length</h3>
<div class="outline-text-3" id="text-org6ef244e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">jojo_length</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (jojo[i] == JO_END &amp;&amp; jojo[i+1] == 0) {<span style="color: #f92672; font-weight: bold;">return</span> i+2;}
    i++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org41a0a3" class="outline-3">
<h3 id="org41a0a3">p_new_jojo</h3>
<div class="outline-text-3" id="text-org41a0a3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_new_jojo</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">new_jojo</span> = array_len_dup(jojo, jojo_length(jojo));
  ds_push(TAG_JOJO, new_jojo_gp(new_jojo));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb103745" class="outline-3">
<h3 id="orgb103745">gc_jojo</h3>
<div class="outline-text-3" id="text-orgb103745">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">gc_jojo</span>(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span> <span style="color: #fd971f;">gc_state</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_MARKING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_red("- gc_jojo : GC_STATE_MARKING\n");</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">sleep(1);</span>
    <span style="color: #f92672; font-weight: bold;">if</span> (gp-&gt;mark == GC_MARK_USING) { <span style="color: #f92672; font-weight: bold;">return</span>; }
    gp-&gt;mark = GC_MARK_USING;
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = gp-&gt;p;
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
    <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
      <span style="color: #f92672; font-weight: bold;">if</span> (jojo[i] == JO_END &amp;&amp; jojo[i+1] == 0) { <span style="color: #f92672; font-weight: bold;">return</span>; }
      <span style="color: #f92672; font-weight: bold;">if</span> (jojo[i] == JO_INS_LIT &amp;&amp; in_jotable_p(jojo[i+1])) {
        mark_one_data(jojo[i+1],
                      jojo[i+2]);
        i++;
        i++;
        i++;
      }
      <span style="color: #f92672; font-weight: bold;">else</span> {
        i++;
      }
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_SWEEPING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_green("- gc_jojo : GC_STATE_SWEEPING\n");</span>
    free(gp-&gt;p);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc026474" class="outline-3">
<h3 id="orgc026474">expose_jojo</h3>
<div class="outline-text-3" id="text-orgc026474">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_jojo</span>() {
  plus_atom(<span style="color: #e6db74;">"&lt;jojo&gt;"</span>, gc_jojo);

  plus_prim(<span style="color: #e6db74;">"new-jojo"</span>, p_new_jojo);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org17bc7eb" class="outline-2">
<h2 id="org17bc7eb">gene</h2>
<div class="outline-text-2" id="text-org17bc7eb">
</div><div id="outline-container-org9c7dc0a" class="outline-3">
<h3 id="org9c7dc0a"><span class="todo _note_">[note]</span> dynamic dispatching</h3>
<div class="outline-text-3" id="text-org9c7dc0a">
<ul class="org-ul">
<li><p>for a gene function</p><p>fixed number of tags of specified arguments</p><p>are used to find the absolute function</p></li></ul>
</div>
</div>

<div id="outline-container-org295b58e" class="outline-3">
<h3 id="org295b58e">disp</h3>
<div class="outline-text-3" id="text-org295b58e">
</div><div id="outline-container-orga6f8a98" class="outline-4">
<h4 id="orga6f8a98">struct disp</h4>
<div class="outline-text-4" id="text-orga6f8a98">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">rest</span>;
};

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span> {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">table</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">size</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6edf77" class="outline-4">
<h4 id="orgf6edf77">new_disp</h4>
<div class="outline-text-4" id="text-orgf6edf77">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #a6e22e;">new_disp</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">size</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>));
  disp-&gt;size = size;
  disp-&gt;table = malloc(<span style="color: #66d9ef; font-weight: bold;">size</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>));
  bzero(disp-&gt;table, <span style="color: #66d9ef; font-weight: bold;">size</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>));
  <span style="color: #f92672; font-weight: bold;">return</span> disp;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org909a7fa" class="outline-4">
<h4 id="org909a7fa">disp_hash</h4>
<div class="outline-text-4" id="text-org909a7fa">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">disp_hash</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">return (((key - jotable) &gt;&gt; 1)</span>
  <span style="color: #FF8888;">//         </span><span style="color: #FF8888;">% (disp-&gt;size - 1)) + 1;</span>
  <span style="color: #f92672; font-weight: bold;">return</span> ((key - jotable)
          % (disp-&gt;size - 1)) + 1;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org51832ed" class="outline-4">
<h4 id="org51832ed">disp_insert_entry</h4>
<div class="outline-text-4" id="text-org51832ed">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">disp_insert_entry</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span>,
                       <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>,
                       <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
                       <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (0 == disp_entry-&gt;key) {
    disp_entry-&gt;key = key;
    disp_entry-&gt;tag = tag;
    disp_entry-&gt;data = data;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (key == disp_entry-&gt;key) {
    disp_entry-&gt;tag = tag;
    disp_entry-&gt;data = data;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;rest == 0) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry_new</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>));
    bzero(disp_entry_new, <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>));
    disp_entry-&gt;rest = disp_entry_new;
    disp_insert_entry(disp_entry_new, key, tag, data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    disp_insert_entry(disp_entry-&gt;rest, key, tag, data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc8d164e" class="outline-4">
<h4 id="orgc8d164e">disp_insert</h4>
<div class="outline-text-4" id="text-orgc8d164e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">disp_insert</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = disp_hash(disp, key);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span> = disp-&gt;table + index;
  disp_insert_entry(disp_entry, key, tag, data);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd3ba076" class="outline-4">
<h4 id="orgd3ba076">disp_find_entry</h4>
<div class="outline-text-4" id="text-orgd3ba076">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #a6e22e;">disp_find_entry</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span>,
                                   <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (key == disp_entry-&gt;key) {
    <span style="color: #f92672; font-weight: bold;">return</span> disp_entry;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;rest != 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> disp_find_entry(disp_entry-&gt;rest, key);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org17b6584" class="outline-4">
<h4 id="org17b6584">disp_find</h4>
<div class="outline-text-4" id="text-org17b6584">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #a6e22e;">disp_find</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span>,
                             <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">key</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = disp_hash(disp, key);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span> = disp-&gt;table + index;
  <span style="color: #f92672; font-weight: bold;">return</span> disp_find_entry(disp_entry, key);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga431d67" class="outline-4">
<h4 id="orga431d67">disp_print_entry</h4>
<div class="outline-text-4" id="text-orga431d67">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">disp_print_entry</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;key != 0) {
    report(<span style="color: #e6db74;">"{%s = %s %ld} "</span>,
           jo2str(disp_entry-&gt;key),
           jo2str(disp_entry-&gt;tag),
           disp_entry-&gt;data);
  }
  <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;rest != 0) {
    disp_print_entry(disp_entry-&gt;rest);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7ec8b7" class="outline-4">
<h4 id="orgf7ec8b7">disp_print</h4>
<div class="outline-text-4" id="text-orgf7ec8b7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">disp_print</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span>) {
  report(<span style="color: #e6db74;">"- disp_print\n"</span>);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; disp-&gt;size) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span> = disp-&gt;table + i;
    <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;key != 0) {
      report(<span style="color: #e6db74;">"  "</span>);
      disp_print_entry(disp_entry);
      report(<span style="color: #e6db74;">"\n"</span>);
    }
    i++;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6a79d73" class="outline-3">
<h3 id="org6a79d73">multi_disp</h3>
<div class="outline-text-3" id="text-org6a79d73">
</div><div id="outline-container-org81066c9" class="outline-4">
<h4 id="org81066c9">struct multi_disp</h4>
<div class="outline-text-4" id="text-org81066c9">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">rest</span>;
};

<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span> {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">table</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">size</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaabb2f0" class="outline-4">
<h4 id="orgaabb2f0">new_multi_disp</h4>
<div class="outline-text-4" id="text-orgaabb2f0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #a6e22e;">new_multi_disp</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">size</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>));
  multi_disp-&gt;size = size;
  multi_disp-&gt;table = malloc(<span style="color: #66d9ef; font-weight: bold;">size</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>));
  bzero(multi_disp-&gt;table, <span style="color: #66d9ef; font-weight: bold;">size</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>));
  <span style="color: #f92672; font-weight: bold;">return</span> multi_disp;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c2cd4d" class="outline-4">
<h4 id="org2c2cd4d">multi_disp_hash</h4>
<div class="outline-text-4" id="text-org2c2cd4d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">multi_disp_hash</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">sum</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (key[i] != 0) {
    sum = sum + (key[i] - jotable);
    i++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> (sum
          % (multi_disp-&gt;size - 1)) + 1;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc705788" class="outline-4">
<h4 id="orgc705788">multi_disp_insert_entry</h4>
<div class="outline-text-4" id="text-orgc705788">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">argument 'key' is shared</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">multi_disp_insert_entry</span>
(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span>,
 <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>,
 <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
 <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>)
{
  <span style="color: #f92672; font-weight: bold;">if</span> (0 == multi_disp_entry-&gt;key) {
    multi_disp_entry-&gt;key = key;
    multi_disp_entry-&gt;tag = tag;
    multi_disp_entry-&gt;data = data;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (array_equal_p(key, multi_disp_entry-&gt;key)) {
    multi_disp_entry-&gt;tag = tag;
    multi_disp_entry-&gt;data = data;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;rest == 0) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry_new</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>));
    bzero(multi_disp_entry_new, <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>));
    multi_disp_entry-&gt;rest = multi_disp_entry_new;
    multi_disp_insert_entry(multi_disp_entry_new, key, tag, data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    multi_disp_insert_entry(multi_disp_entry-&gt;rest, key, tag, data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org432aeec" class="outline-4">
<h4 id="org432aeec">multi_disp_insert</h4>
<div class="outline-text-4" id="text-org432aeec">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">argument 'key' is shared</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">multi_disp_insert</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span>,
                       <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>,
                       <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>,
                       <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>)
{
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = multi_disp_hash(multi_disp, key);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span> = multi_disp-&gt;table + index;
  multi_disp_insert_entry(multi_disp_entry, key, tag, data);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org123ebdf" class="outline-4">
<h4 id="org123ebdf">multi_disp_find_entry</h4>
<div class="outline-text-4" id="text-org123ebdf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>*
<span style="color: #a6e22e;">multi_disp_find_entry</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span>,
                      <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;key == 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> 0;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (array_equal_p(key, multi_disp_entry-&gt;key)) {
    <span style="color: #f92672; font-weight: bold;">return</span> multi_disp_entry;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;rest != 0) {
    <span style="color: #f92672; font-weight: bold;">return</span> multi_disp_find_entry(multi_disp_entry-&gt;rest, key);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> 0;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2247d0b" class="outline-4">
<h4 id="org2247d0b">multi_disp_find</h4>
<div class="outline-text-4" id="text-org2247d0b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>*
<span style="color: #a6e22e;">multi_disp_find</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span>,
                <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">key</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">{</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">report("- multi_disp_find\n");</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">while (key[i] != 0) {</span>
  <span style="color: #FF8888;">//     </span><span style="color: #FF8888;">report("  \"%s\"\n", jo2str(key[i]));</span>
  <span style="color: #FF8888;">//     </span><span style="color: #FF8888;">i++;</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">}</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">}</span>
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = multi_disp_hash(multi_disp, key);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span> = multi_disp-&gt;table + index;
  <span style="color: #f92672; font-weight: bold;">return</span> multi_disp_find_entry(multi_disp_entry, key);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd8cbb9" class="outline-4">
<h4 id="orgdd8cbb9">multi_disp_print_entry</h4>
<div class="outline-text-4" id="text-orgdd8cbb9">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">multi_disp_print_entry</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;key != 0) {
    report(<span style="color: #e6db74;">"{"</span>);
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
    <span style="color: #f92672; font-weight: bold;">while</span> (multi_disp_entry-&gt;key[i] != 0) {
      report(<span style="color: #e6db74;">"%s "</span>, jo2str(multi_disp_entry-&gt;key[i]));
      i++;
    }
    report(<span style="color: #e6db74;">"= %s %ld} "</span>,
           jo2str(multi_disp_entry-&gt;tag),
           multi_disp_entry-&gt;data);
  }
  <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;rest != 0) {
    multi_disp_print_entry(multi_disp_entry-&gt;rest);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd084185" class="outline-4">
<h4 id="orgd084185">multi_disp_print</h4>
<div class="outline-text-4" id="text-orgd084185">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">multi_disp_print</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span>) {
  report(<span style="color: #e6db74;">"- multi_disp_print\n"</span>);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; multi_disp-&gt;size) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span> = multi_disp-&gt;table + i;
    <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;key != 0) {
      report(<span style="color: #e6db74;">"  "</span>);
      multi_disp_print_entry(multi_disp_entry);
      report(<span style="color: #e6db74;">"\n"</span>);
    }
    i++;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6a30c" class="outline-3">
<h3 id="org6a30c">struct gene</h3>
<div class="outline-text-3" id="text-org6a30c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span> {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>;
  <span style="color: #f92672; font-weight: bold;">union</span> {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">disp</span>;
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">multi_disp</span>;
  };
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">arity</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc514e7f" class="outline-3">
<h3 id="orgc514e7f">plus_gene</h3>
<div class="outline-text-3" id="text-orgc514e7f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_gene</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">function_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">arity</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(function_name);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span> = malloc(<span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>));
  bzero(gene, <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>));

  gene-&gt;arity = arity;

  <span style="color: #f92672; font-weight: bold;">if</span> (arity == 1) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span> = new_disp(128);
    gene-&gt;disp = disp;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span> = new_multi_disp(128);
    gene-&gt;multi_disp = multi_disp;
  }

  bind_name(name, TAG_GENE, gene);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb25a0d7" class="outline-3">
<h3 id="orgb25a0d7">plus_disp</h3>
<div class="outline-text-3" id="text-orgb25a0d7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">argument 'tags' is shared</span>
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_disp</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">gene_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">tags</span>,
               <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tag_name</span>,
               <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(gene_name);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span> = str2jo(tag_name);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span> = name-&gt;data;
  <span style="color: #f92672; font-weight: bold;">if</span> (gene-&gt;arity == 1) {
    disp_insert(gene-&gt;disp, tags[0], tag, data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    multi_disp_insert(gene-&gt;multi_disp, tags, tag, data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org594d739" class="outline-3">
<h3 id="org594d739">plus_disp_default</h3>
<div class="outline-text-3" id="text-org594d739">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">plus_disp_default</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">gene_name</span>,
                       <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tag_name</span>,
                       <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = str2jo(gene_name);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span> = str2jo(tag_name);
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span> = name-&gt;data;
  gene-&gt;tag = tag;
  gene-&gt;data = data;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga54bf93" class="outline-3">
<h3 id="orga54bf93">disp_exe</h3>
<div class="outline-text-3" id="text-orga54bf93">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">disp_exe</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp</span>* <span style="color: #fd971f;">disp</span> = gene-&gt;disp;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">disp_entry</span>* <span style="color: #fd971f;">disp_entry</span> =
    disp_find(disp, tag);
  <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry == 0) {
    <span style="color: #f92672; font-weight: bold;">if</span> (gene-&gt;tag != 0) {
      ds_push(gene-&gt;tag, gene-&gt;data);
      disp_exe(JO_EXE-&gt;data, gene-&gt;tag);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      report(<span style="color: #e6db74;">"- disp_exe meet unknow tag\n"</span>);
      report(<span style="color: #e6db74;">"  tag : %s\n"</span>, jo2str(tag));
      disp_print(disp);
      p_debug();
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">if</span> (disp_entry-&gt;tag == TAG_PRIM) {
      <span style="color: #66d9ef; font-weight: bold;">primitive_t</span> <span style="color: #fd971f;">f</span> = (<span style="color: #66d9ef; font-weight: bold;">primitive_t</span>)disp_entry-&gt;data;
      f();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      ds_push(disp_entry-&gt;tag, disp_entry-&gt;data);
      disp_exe(JO_EXE-&gt;data, disp_entry-&gt;tag);
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3e9744a" class="outline-3">
<h3 id="org3e9744a">multi_disp_exe</h3>
<div class="outline-text-3" id="text-org3e9744a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">multi_disp_exe</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">tags</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp</span>* <span style="color: #fd971f;">multi_disp</span> = gene-&gt;multi_disp;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">multi_disp_entry</span>* <span style="color: #fd971f;">multi_disp_entry</span> =
    multi_disp_find(multi_disp, tags);
  <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry == 0) {
    <span style="color: #f92672; font-weight: bold;">if</span> (gene-&gt;tag != 0) {
      ds_push(gene-&gt;tag, gene-&gt;data);
      disp_exe(JO_EXE-&gt;data, gene-&gt;tag);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      report(<span style="color: #e6db74;">"- multi_disp_exe meet unknow tags\n"</span>);
      report(<span style="color: #e6db74;">"  tags : "</span>);
      <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
      <span style="color: #f92672; font-weight: bold;">while</span> (tags[i] != 0) {
        report(<span style="color: #e6db74;">"%s "</span>, jo2str(tags[i]));
        i++;
      }
      report(<span style="color: #e6db74;">"  \n"</span>);
      multi_disp_print(multi_disp);
      p_debug();
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">if</span> (multi_disp_entry-&gt;tag == TAG_PRIM) {
      <span style="color: #66d9ef; font-weight: bold;">primitive_t</span> <span style="color: #fd971f;">f</span> = (<span style="color: #66d9ef; font-weight: bold;">primitive_t</span>)multi_disp_entry-&gt;data;
      f();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      ds_push(multi_disp_entry-&gt;tag, multi_disp_entry-&gt;data);
      disp_exe(JO_EXE-&gt;data, multi_disp_entry-&gt;tag);
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org324cbf2" class="outline-3">
<h3 id="org324cbf2">p_gene_exe</h3>
<div class="outline-text-3" id="text-org324cbf2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_gene_exe</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gene</span>* <span style="color: #fd971f;">gene</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">if</span> (gene-&gt;arity == 1) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">t</span> = ds_tos();
    disp_exe(gene, t.t);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tags</span>[16];
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
    <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; gene-&gt;arity) {
      tags[i] = ds_peek_tag(gene-&gt;arity - i);
      i++;
    }
    tags[i] = 0;
    multi_disp_exe(gene, tags);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a589be" class="outline-3">
<h3 id="org1a589be">p_prim_exe</h3>
<div class="outline-text-3" id="text-org1a589be">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_prim_exe</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">primitive_t</span> <span style="color: #fd971f;">f</span> = (<span style="color: #66d9ef; font-weight: bold;">primitive_t</span>)a.d;
  f();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga94a734" class="outline-3">
<h3 id="orga94a734">p_jojo_exe</h3>
<div class="outline-text-3" id="text-orga94a734">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jojo_exe</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">jojo_gp</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = jojo_gp-&gt;p;

  rs_push(jojo,
          TAG_JOJO,
          jojo_gp,
          current_local_counter,
          current_dynamic_local_counter);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org347c99" class="outline-3">
<h3 id="org347c99">p_data_predicate_exe</h3>
<div class="outline-text-3" id="text-org347c99">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_data_predicate_exe</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = b.d;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_BOOL, (class-&gt;class_name == a.t));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org746f0c4" class="outline-3">
<h3 id="org746f0c4">p_default_exe</h3>
<div class="outline-text-3" id="text-org746f0c4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_default_exe</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">leave the data be.</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org97c292f" class="outline-3">
<h3 id="org97c292f">expose_gene</h3>
<div class="outline-text-3" id="text-org97c292f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_gene</span>() {
  plus_gene(<span style="color: #e6db74;">"exe"</span>, 1);
  plus_disp_default(<span style="color: #e6db74;">"exe"</span>, <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_default_exe);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;prim&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_prim_exe);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;jojo&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_jojo_exe);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;gene&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_gene_exe);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;data-constructor&gt;"</span>),
            <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_new);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;data-predicate&gt;"</span>),
            <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_data_predicate_exe);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org64682f9" class="outline-2">
<h2 id="org64682f9">exe &amp; jo_apply &amp; eval</h2>
<div class="outline-text-2" id="text-org64682f9">
</div><div id="outline-container-orgc32570f" class="outline-3">
<h3 id="orgc32570f"><span class="todo _note_">[note]</span> </h3>
<div class="outline-text-3" id="text-orgc32570f">
<ul class="org-ul">
<li><p><p></p><p>be careful when calling jo_apply in primitive,</p><p>because after push a jojo to rs,</p><p>one need to exit current primitive to run the jojo.</p><p></p></p><p></p><p><p></p><p>if wished follow a 'eval();' after jo_apply</p><p>to return to the primitive function.</p><p></p></p></li></ul>
</div>
</div>

<div id="outline-container-org727ab33" class="outline-3">
<h3 id="org727ab33">jo_apply</h3>
<div class="outline-text-3" id="text-org727ab33">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_debug</span>();

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">jo_apply</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>jo_bound_p(jo)) {
    report(<span style="color: #e6db74;">"- jo_apply fail\n"</span>);
    report(<span style="color: #e6db74;">"  jo is not bound : %s\n"</span>, jo2str(jo));
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(jo-&gt;tag, jo-&gt;data);
    disp_exe(JO_EXE-&gt;data, jo-&gt;tag);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org95ef226" class="outline-3">
<h3 id="org95ef226">eval_one_step</h3>
<div class="outline-text-3" id="text-org95ef226">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">eval_one_step</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = jojo[0];
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">next_jo</span> = jojo[1];
  <span style="color: #f92672; font-weight: bold;">if</span> (next_jo == JO_END) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">tail call is handled here</span>
    rs_drop();
    current_local_counter = p.l;
    current_dynamic_local_counter = p.y;
    <span style="color: #f92672; font-weight: bold;">if</span> (jo == JO_RECUR) {
      ds_push(p.t, p.d);
      disp_exe(JO_EXE-&gt;data, p.t);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      jo_apply(jo);
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    rs_inc();
    jo_apply(jo);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeeefb31" class="outline-3">
<h3 id="orgeeefb31">eval</h3>
<div class="outline-text-3" id="text-orgeeefb31">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">eval</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">base</span> = rs-&gt;pointer;
  <span style="color: #f92672; font-weight: bold;">while</span> (rs-&gt;pointer &gt;= base) {
    eval_one_step();
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5a3d344" class="outline-2">
<h2 id="org5a3d344"><b>ending</b></h2>
<div class="outline-text-2" id="text-org5a3d344">
</div><div id="outline-container-orgee57e3d" class="outline-3">
<h3 id="orgee57e3d">p_end</h3>
<div class="outline-text-3" id="text-orgee57e3d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_end</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">for 'p_step'</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">if 'p_step' does not handle tail call</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_pop();
  current_local_counter = p.l;
  current_dynamic_local_counter = p.y;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org11af421" class="outline-3">
<h3 id="org11af421">p_bye</h3>
<div class="outline-text-3" id="text-org11af421">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_bye</span>() {
  report(<span style="color: #e6db74;">"bye bye ^-^/\n"</span>);
  exit(0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7aa86d2" class="outline-3">
<h3 id="org7aa86d2">p_nop</h3>
<div class="outline-text-3" id="text-org7aa86d2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_nop</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">do nothing</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb71699" class="outline-3">
<h3 id="orgeb71699">expose_ending</h3>
<div class="outline-text-3" id="text-orgeb71699">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_ending</span>() {
  plus_prim(<span style="color: #e6db74;">"end"</span>, p_end);
  plus_prim(<span style="color: #e6db74;">"bye"</span>, p_bye);
  plus_prim(<span style="color: #e6db74;">"nop"</span>, p_nop);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org19a6f2a" class="outline-2">
<h2 id="org19a6f2a"><b>stack</b></h2>
<div class="outline-text-2" id="text-org19a6f2a">
</div><div id="outline-container-orgc1f5b51" class="outline-3">
<h3 id="orgc1f5b51">p_drop</h3>
<div class="outline-text-3" id="text-orgc1f5b51">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_drop</span>() {
  ds_pop();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef452d4" class="outline-3">
<h3 id="orgef452d4">p_dup</h3>
<div class="outline-text-3" id="text-orgef452d4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_dup</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(a.t, a.d);
  ds_push(a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ad7390" class="outline-3">
<h3 id="org4ad7390">p_over</h3>
<div class="outline-text-3" id="text-org4ad7390">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_over</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">b a -&gt; b a b</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(b.t, b.d);
  ds_push(a.t, a.d);
  ds_push(b.t, b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org71b75d7" class="outline-3">
<h3 id="org71b75d7">p_tuck</h3>
<div class="outline-text-3" id="text-org71b75d7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_tuck</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">b a -&gt; a b a</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(a.t, a.d);
  ds_push(b.t, b.d);
  ds_push(a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf14da4d" class="outline-3">
<h3 id="orgf14da4d">p_swap</h3>
<div class="outline-text-3" id="text-orgf14da4d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_swap</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">b a -&gt; a b</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(a.t, a.d);
  ds_push(b.t, b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1cc9d56" class="outline-3">
<h3 id="org1cc9d56">expose_stack</h3>
<div class="outline-text-3" id="text-org1cc9d56">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_stack</span>() {
  plus_prim(<span style="color: #e6db74;">"drop"</span>, p_drop);
  plus_prim(<span style="color: #e6db74;">"dup"</span>,  p_dup);
  plus_prim(<span style="color: #e6db74;">"over"</span>, p_over);
  plus_prim(<span style="color: #e6db74;">"tuck"</span>, p_tuck);
  plus_prim(<span style="color: #e6db74;">"swap"</span>, p_swap);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org14567d9" class="outline-2">
<h2 id="org14567d9"><b>io</b></h2>
<div class="outline-text-2" id="text-org14567d9">
</div><div id="outline-container-org7b64768" class="outline-3">
<h3 id="org7b64768">reading_stack</h3>
<div class="outline-text-3" id="text-org7b64768">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">reading_stack</span>; <span style="color: #FF8888;">// </span><span style="color: #FF8888;">of input_stack</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6111cfd" class="outline-3">
<h3 id="org6111cfd">writing_stack</h3>
<div class="outline-text-3" id="text-org6111cfd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">writing_stack</span>; <span style="color: #FF8888;">// </span><span style="color: #FF8888;">of output_stack</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org433dc98" class="outline-3">
<h3 id="org433dc98">p_reading_stack_push</h3>
<div class="outline-text-3" id="text-org433dc98">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_reading_stack_push</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  push(reading_stack, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org60351ec" class="outline-3">
<h3 id="org60351ec">p_reading_stack_tos</h3>
<div class="outline-text-3" id="text-org60351ec">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_reading_stack_tos</span>() {
  ds_push(TAG_INPUT_STACK, tos(reading_stack));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf20cb31" class="outline-3">
<h3 id="orgf20cb31">p_reading_stack_pop</h3>
<div class="outline-text-3" id="text-orgf20cb31">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_reading_stack_pop</span>() {
  ds_push(TAG_INPUT_STACK, pop(reading_stack));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge0f06a7" class="outline-3">
<h3 id="orge0f06a7">p_reading_stack_drop</h3>
<div class="outline-text-3" id="text-orge0f06a7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_reading_stack_drop</span>() {
  drop(reading_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb81fd1" class="outline-3">
<h3 id="orgbb81fd1">p_terminal_input_stack</h3>
<div class="outline-text-3" id="text-orgbb81fd1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_terminal_input_stack</span>() {
  ds_push(TAG_INPUT_STACK, terminal_input_stack());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f10d1f" class="outline-3">
<h3 id="org3f10d1f">p_input_stack_free</h3>
<div class="outline-text-3" id="text-org3f10d1f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_input_stack_free</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  input_stack_free(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga16f14a" class="outline-3">
<h3 id="orga16f14a">p_input_stack_empty_p</h3>
<div class="outline-text-3" id="text-orga16f14a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_input_stack_empty_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_BOOL, input_stack_empty_p(a.d));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org35a6e45" class="outline-3">
<h3 id="org35a6e45">has_byte_p</h3>
<div class="outline-text-3" id="text-org35a6e45">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">has_byte_p</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #960050;">!</span>input_stack_empty_p(tos(reading_stack));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org943065f" class="outline-3">
<h3 id="org943065f">read_byte</h3>
<div class="outline-text-3" id="text-org943065f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #a6e22e;">read_byte</span>() {
  <span style="color: #f92672; font-weight: bold;">return</span> input_stack_pop(tos(reading_stack));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5eb22b3" class="outline-3">
<h3 id="org5eb22b3">p_read_byte</h3>
<div class="outline-text-3" id="text-org5eb22b3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_read_byte</span>() {
  ds_push(TAG_BYTE, read_byte());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1082ac0" class="outline-3">
<h3 id="org1082ac0">byte_unread</h3>
<div class="outline-text-3" id="text-org1082ac0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">byte_unread</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">b</span>) {
  input_stack_push(tos(reading_stack), b);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3aef233" class="outline-3">
<h3 id="org3aef233">byte_write</h3>
<div class="outline-text-3" id="text-org3aef233">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">byte_write</span>(<span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">b</span>) {
  output_stack_push(tos(writing_stack), b);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga70ce26" class="outline-3">
<h3 id="orga70ce26">p_byte_write</h3>
<div class="outline-text-3" id="text-orga70ce26">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_byte_write</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  byte_write(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd95db0f" class="outline-3">
<h3 id="orgd95db0f">has_jo_p</h3>
<div class="outline-text-3" id="text-orgd95db0f">
<ul class="org-ul">
<li><p>note that,</p><p>this function clear spaces for next jo</p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">has_jo_p</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>has_byte_p()) {
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
    }
    c = read_byte();
    <span style="color: #f92672; font-weight: bold;">if</span> (char_space_p(c)) {
      <span style="color: #FF8888;">// </span><span style="color: #FF8888;">loop</span>
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      byte_unread(c);
      <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9970e03" class="outline-3">
<h3 id="org9970e03">p_has_jo_p</h3>
<div class="outline-text-3" id="text-org9970e03">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_has_jo_p</span>() {
  ds_push(TAG_BOOL, has_jo_p());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org10205bc" class="outline-3">
<h3 id="org10205bc">read_jo</h3>
<div class="outline-text-3" id="text-org10205bc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">read_jo</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buf</span>[1024];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cur</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">collecting_bytes</span> = <span style="color: #ae81ff;">false</span>;
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span>;
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">go</span> = <span style="color: #ae81ff;">true</span>;

  <span style="color: #f92672; font-weight: bold;">while</span> (go) {

    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>has_byte_p()) {
      <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>collecting_bytes) {
        report(<span style="color: #e6db74;">"- p_read_jo fail\n"</span>);
        report(<span style="color: #e6db74;">"  meet end-of-file when still collecting_bytes bytes\n"</span>);
        p_debug();
      }
      <span style="color: #f92672; font-weight: bold;">else</span> {
        <span style="color: #f92672; font-weight: bold;">break</span>;
      }
    }

    c = read_byte(); <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- read_byte() : %c\n", c);</span>

    <span style="color: #f92672; font-weight: bold;">if</span> (collecting_bytes) {
      <span style="color: #f92672; font-weight: bold;">if</span> (char_delimiter_p(c) ||
          char_space_p(c)) {
        byte_unread(c);
        go = <span style="color: #ae81ff;">false</span>;
      }
      <span style="color: #f92672; font-weight: bold;">else</span> {
        buf[cur] = c;
        cur++;
      }
    }

    <span style="color: #f92672; font-weight: bold;">else</span> {
      <span style="color: #f92672; font-weight: bold;">if</span> (char_space_p(c)) {
        <span style="color: #FF8888;">// </span><span style="color: #FF8888;">loop</span>
      }
      <span style="color: #f92672; font-weight: bold;">else</span> {
        collecting_bytes = <span style="color: #ae81ff;">true</span>;
        buf[cur] = c;
        cur++;
        <span style="color: #f92672; font-weight: bold;">if</span> (char_delimiter_p(c)) {
          go = <span style="color: #ae81ff;">false</span>;
        }
      }
    }
  }

  buf[cur] = 0;
  <span style="color: #f92672; font-weight: bold;">return</span> str2jo(buf);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ddd3cf" class="outline-3">
<h3 id="org7ddd3cf">p_read_jo</h3>
<div class="outline-text-3" id="text-org7ddd3cf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_read_jo</span>() {
  ds_push(TAG_JO, read_jo());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f5c74d" class="outline-3">
<h3 id="org8f5c74d">string_unread</h3>
<div class="outline-text-3" id="text-org8f5c74d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">string_unread</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    string_unread(str+1);
    byte_unread(str[0]);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2ac96d" class="outline-3">
<h3 id="orgc2ac96d">p_string_unread</h3>
<div class="outline-text-3" id="text-orgc2ac96d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_unread</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  string_unread(ap-&gt;p);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1eb651" class="outline-3">
<h3 id="orgc1eb651">jo_unread</h3>
<div class="outline-text-3" id="text-orgc1eb651">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">jo_unread</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(jo);
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">byte_unread(' ');</span>
  string_unread(str);
  byte_unread(<span style="color: #f8f8f0; background-color: #1b1d1e;">' </span><span style="color: #d33682; font-weight: bold;">'</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6dcdd99" class="outline-3">
<h3 id="org6dcdd99">p_newline</h3>
<div class="outline-text-3" id="text-org6dcdd99">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_newline</span>() {
  output_stack_push(tos(writing_stack), <span style="color: #f8f8f0; background-color: #1b1d1e;">'\n</span><span style="color: #d33682; font-weight: bold;">'</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga96e386" class="outline-3">
<h3 id="orga96e386">p_space</h3>
<div class="outline-text-3" id="text-orga96e386">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_space</span>() {
  output_stack_push(tos(writing_stack), <span style="color: #f8f8f0; background-color: #1b1d1e;">' </span><span style="color: #d33682; font-weight: bold;">'</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8fad90" class="outline-3">
<h3 id="orga8fad90">expose_io</h3>
<div class="outline-text-3" id="text-orga8fad90">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_io</span>() {
  plus_atom(<span style="color: #e6db74;">"&lt;input-stack&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"reading-stack-push"</span>, p_reading_stack_push);
  plus_prim(<span style="color: #e6db74;">"reading-stack-tos"</span>, p_reading_stack_tos);
  plus_prim(<span style="color: #e6db74;">"reading-stack-pop"</span>, p_reading_stack_pop);
  plus_prim(<span style="color: #e6db74;">"reading-stack-drop"</span>, p_reading_stack_drop);

  plus_prim(<span style="color: #e6db74;">"terminal-input-stack"</span>, p_terminal_input_stack);
  plus_prim(<span style="color: #e6db74;">"input-stack-free"</span>, p_input_stack_free);
  plus_prim(<span style="color: #e6db74;">"input-stack-empty?"</span>, p_input_stack_empty_p);

  plus_prim(<span style="color: #e6db74;">"read-byte"</span>, p_read_byte);
  plus_prim(<span style="color: #e6db74;">"byte-write"</span>, p_byte_write);

  plus_prim(<span style="color: #e6db74;">"has-jo?"</span>, p_has_jo_p);
  plus_prim(<span style="color: #e6db74;">"read-jo"</span>, p_read_jo);

  plus_prim(<span style="color: #e6db74;">"string-unread"</span>, p_string_unread);

  plus_prim(<span style="color: #e6db74;">"newline"</span>, p_newline);
  plus_prim(<span style="color: #e6db74;">"space"</span>, p_space);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org28a54d7" class="outline-2">
<h2 id="org28a54d7"><b>local</b></h2>
<div class="outline-text-2" id="text-org28a54d7">
</div><div id="outline-container-org161928d" class="outline-3">
<h3 id="org161928d">local_find</h3>
<div class="outline-text-3" id="text-org161928d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">local_find</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">return index of local_record</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">-1 -- no found</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = current_local_counter - 1;
  <span style="color: #f92672; font-weight: bold;">while</span> (cursor &gt;= p.l) {
    <span style="color: #f92672; font-weight: bold;">if</span> (local_record[cursor].name == name) {
      <span style="color: #f92672; font-weight: bold;">return</span> cursor;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      cursor--;
    }
  }
  <span style="color: #f92672; font-weight: bold;">return</span> -1;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge027548" class="outline-3">
<h3 id="orge027548">ins_local</h3>
<div class="outline-text-3" id="text-orge027548">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = local_find(name);

  <span style="color: #f92672; font-weight: bold;">if</span> (index != -1) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span> <span style="color: #fd971f;">lp</span> = local_record[index];
    ds_push(lp.local_tag, lp.local_data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- ins_local fatal error\n"</span>);
    report(<span style="color: #e6db74;">"  name is not bound\n"</span>);
    report(<span style="color: #e6db74;">"  name : %s\n"</span>, jo2str(name));
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f594f3" class="outline-3">
<h3 id="org1f594f3">set_local</h3>
<div class="outline-text-3" id="text-org1f594f3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_local</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (current_local_counter &lt; LOCAL_RECORD_SIZE) {
    local_record[current_local_counter].name = name;
    local_record[current_local_counter].local_tag = tag;
    local_record[current_local_counter].local_data = data;
    current_local_counter++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- set_local fail\n"</span>);
    report(<span style="color: #e6db74;">"  local_record is filled\n"</span>);
    report(<span style="color: #e6db74;">"  LOCAL_RECORD_SIZE : %ld\n"</span>, LOCAL_RECORD_SIZE);
    report(<span style="color: #e6db74;">"  name : %s\n"</span>, jo2str(name));
    report(<span style="color: #e6db74;">"  tag : %s\n"</span>, jo2str(tag));
    report(<span style="color: #e6db74;">"  data : %ld\n"</span>, data);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7252335" class="outline-3">
<h3 id="org7252335">ins_set_local</h3>
<div class="outline-text-3" id="text-org7252335">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_set_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  set_local(name, a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga33fefe" class="outline-3">
<h3 id="orga33fefe">expose_local</h3>
<div class="outline-text-3" id="text-orga33fefe">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_local</span>() {
  plus_prim(<span style="color: #e6db74;">"ins/local"</span>, ins_local);
  plus_prim(<span style="color: #e6db74;">"ins/set-local"</span>, ins_set_local);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1c058ec" class="outline-2">
<h2 id="org1c058ec"><b>dynamic-local</b></h2>
<div class="outline-text-2" id="text-org1c058ec">
</div><div id="outline-container-org2f48924" class="outline-3">
<h3 id="org2f48924">dynamic_local_find</h3>
<div class="outline-text-3" id="text-org2f48924">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">dynamic_local_find</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">return index of local_record</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">-1 -- no found</span>
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = current_dynamic_local_counter - 1;

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- dynamic_local_find\n");</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  current_dynamic_local_counter : %ld\n", current_dynamic_local_counter);</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  init cursor : %ld\n", cursor);</span>

  <span style="color: #f92672; font-weight: bold;">while</span> (cursor &gt;= 0) {

    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  cursor : %ld\n", cursor);</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  name : %s\n", jo2str(name));</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  dynamic_local_record[cursor].name : %s\n",</span>
    <span style="color: #FF8888;">//        </span><span style="color: #FF8888;">jo2str(dynamic_local_record[cursor].name));</span>

    <span style="color: #f92672; font-weight: bold;">if</span> (dynamic_local_record[cursor].name == name) {
      <span style="color: #f92672; font-weight: bold;">return</span> cursor;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      cursor--;
    }
  }
  <span style="color: #f92672; font-weight: bold;">return</span> -1;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5213ec4" class="outline-3">
<h3 id="org5213ec4">ins_dynamic_local</h3>
<div class="outline-text-3" id="text-org5213ec4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_dynamic_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = dynamic_local_find(name);

  <span style="color: #f92672; font-weight: bold;">if</span> (index != -1) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dynamic_local</span> <span style="color: #fd971f;">lp</span> = dynamic_local_record[index];
    ds_push(lp.dynamic_local_tag,
            lp.dynamic_local_data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- ins_dynamic_local fatal error\n"</span>);
    report(<span style="color: #e6db74;">"  name is not bound\n"</span>);
    report(<span style="color: #e6db74;">"  name : %s\n"</span>, jo2str(name));
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge8dae45" class="outline-3">
<h3 id="orge8dae45">set_dynamic_local</h3>
<div class="outline-text-3" id="text-orge8dae45">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_dynamic_local</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (current_dynamic_local_counter &lt; DYNAMIC_LOCAL_RECORD_SIZE) {
    dynamic_local_record[current_dynamic_local_counter].name = name;
    dynamic_local_record[current_dynamic_local_counter].dynamic_local_tag = tag;
    dynamic_local_record[current_dynamic_local_counter].dynamic_local_data = data;
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("- set_dynamic_local\n");</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  &gt; %s\n", jo2str(dynamic_local_record[current_dynamic_local_counter].name));</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  &gt; %s\n", jo2str(dynamic_local_record[current_dynamic_local_counter].dynamic_local_tag));</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  &gt; %ld\n", dynamic_local_record[current_dynamic_local_counter].dynamic_local_data);</span>
    current_dynamic_local_counter++;
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report("  &gt; %ld\n", current_dynamic_local_counter);</span>
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- set_dynamic_local fail\n"</span>);
    report(<span style="color: #e6db74;">"  dynamic_local_record is filled\n"</span>);
    report(<span style="color: #e6db74;">"  DYNAMIC_LOCAL_RECORD_SIZE : %ld\n"</span>,
           DYNAMIC_LOCAL_RECORD_SIZE);
    report(<span style="color: #e6db74;">"  name : %s\n"</span>, jo2str(name));
    report(<span style="color: #e6db74;">"  tag : %s\n"</span>, jo2str(tag));
    report(<span style="color: #e6db74;">"  data : %ld\n"</span>, data);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9fc1eab" class="outline-3">
<h3 id="org9fc1eab">ins_set_dynamic_local</h3>
<div class="outline-text-3" id="text-org9fc1eab">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_set_dynamic_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = jojo[0];

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  set_dynamic_local(name, a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org23d819c" class="outline-3">
<h3 id="org23d819c">expose_dynamic_local</h3>
<div class="outline-text-3" id="text-org23d819c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_dynamic_local</span>() {
  plus_prim(<span style="color: #e6db74;">"ins/dynamic-local"</span>, ins_dynamic_local);
  plus_prim(<span style="color: #e6db74;">"ins/set-dynamic-local"</span>, ins_set_dynamic_local);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdeda97" class="outline-2">
<h2 id="orgdeda97"><b>compiler</b></h2>
<div class="outline-text-2" id="text-orgdeda97">
</div><div id="outline-container-orga2b230" class="outline-3">
<h3 id="orga2b230">compiling_stack</h3>
<div class="outline-text-3" id="text-orga2b230">
<ul class="org-ul">
<li><p>to redirect compiling location</p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">stack</span>* <span style="color: #fd971f;">compiling_stack</span>; <span style="color: #FF8888;">// </span><span style="color: #FF8888;">of jojo</span>

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_compiling_stack_inc</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = pop(compiling_stack);
  push(compiling_stack, jojo + 1);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8edf44" class="outline-3">
<h3 id="orgb8edf44">emit</h3>
<div class="outline-text-3" id="text-orgb8edf44">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">emit</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">n</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = pop(compiling_stack);
  jojo[0] = n;
  push(compiling_stack, jojo + 1);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcecd9a6" class="outline-3">
<h3 id="orgcecd9a6">emit_jojo_end</h3>
<div class="outline-text-3" id="text-orgcecd9a6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">emit_jojo_end</span>() {
  emit(JO_END);
  emit(0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org19c55b9" class="outline-3">
<h3 id="org19c55b9">about string pattern [syntax of jojo]</h3>
<div class="outline-text-3" id="text-org19c55b9">
</div><div id="outline-container-orgcffa285" class="outline-4">
<h4 id="orgcffa285">local_string_p</h4>
<div class="outline-text-4" id="text-orgcffa285">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">:local</span>
<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">local_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_count_member(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_last_byte(str) == <span style="color: #f8f8f0; background-color: #1b1d1e;">'!</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_member_p(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>)) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff4e122" class="outline-4">
<h4 id="orgff4e122">set_local_string_p</h4>
<div class="outline-text-4" id="text-orgff4e122">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">:local!</span>
<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">set_local_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_count_member(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_last_byte(str) != <span style="color: #f8f8f0; background-color: #1b1d1e;">'!</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_member_p(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>)) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ffd5b8" class="outline-4">
<h4 id="org5ffd5b8">field_string_p</h4>
<div class="outline-text-4" id="text-org5ffd5b8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">.field</span>
<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">field_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_last_byte(str) == <span style="color: #f8f8f0; background-color: #1b1d1e;">'!</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_count_member(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f3aa26" class="outline-4">
<h4 id="org9f3aa26">set_field_string_p</h4>
<div class="outline-text-4" id="text-org9f3aa26">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">.field!</span>
<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">set_field_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_last_byte(str) != <span style="color: #f8f8f0; background-color: #1b1d1e;">'!</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_count_member(str, <span style="color: #f8f8f0; background-color: #1b1d1e;">'.</span><span style="color: #d33682; font-weight: bold;">'</span>) != 1) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org69db9a9" class="outline-4">
<h4 id="org69db9a9">tag_string_p</h4>
<div class="outline-text-4" id="text-org69db9a9">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">&lt;tag&gt;</span>
<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">tag_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'&lt;</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (string_last_byte(str) != <span style="color: #f8f8f0; background-color: #1b1d1e;">'&gt;</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgee3684f" class="outline-3">
<h3 id="orgee3684f">compile_jo</h3>
<div class="outline-text-3" id="text-orgee3684f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_closure</span>();
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">compile_string</span>();

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">compile_jo</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (jo == ROUND_BAR) {
    jo_apply(read_jo());
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(jo);
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">number</span>
  <span style="color: #f92672; font-weight: bold;">if</span> (int_string_p(str)) {
    emit(JO_INS_LIT);
    emit(TAG_INT);
    emit(string_to_int(str));
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">"string"</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == DOUBLEQUOTE) {
    compile_string();
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">:local</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (local_string_p(str)) {
    emit(JO_INS_LOCAL);
    emit(jo);
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">:local!</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (set_local_string_p(str)) {
    emit(JO_INS_SET_LOCAL);
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(str, 0, strlen(str) -1);
    emit(str2jo(tmp));
    free(tmp);
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">.field</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (field_string_p(str)) {
    emit(JO_INS_FIELD);
    emit(jo);
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">.field!</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (set_field_string_p(str)) {
    emit(JO_INS_SET_FIELD);
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(str, 0, strlen(str) -1);
    emit(str2jo(tmp));
    free(tmp);
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">,</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == COMMA) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">ignore</span>
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">' jo</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\''</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">next_jo</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (jo_bar_ket_p(next_jo)) {
      report(<span style="color: #e6db74;">"- compile_jo fail\n"</span>);
      report(<span style="color: #e6db74;">"  can not handle bar-ket after ' in this reader\n"</span>);
      report(<span style="color: #e6db74;">"  can only handle ' jo\n"</span>);
      report(<span style="color: #e6db74;">"  delimiter : %s\n"</span>, jo2str(next_jo));
      p_debug();
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      emit(JO_INS_LIT);
      emit(TAG_JO);
      emit(next_jo);
    }
  }
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">{...}</span>
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == FLOWER_BAR) {
    k_closure();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    emit(jo);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgabb15bb" class="outline-3">
<h3 id="orgabb15bb">compile_until_meet_jo</h3>
<div class="outline-text-3" id="text-orgabb15bb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">compile_until_meet_jo</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ending_jo</span>) {
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (jo == ending_jo) { <span style="color: #f92672; font-weight: bold;">return</span>; }
    compile_jo(jo);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org391f1fe" class="outline-3">
<h3 id="org391f1fe">compile_until_meet_jo_or_jo</h3>
<div class="outline-text-3" id="text-org391f1fe">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #a6e22e;">compile_until_meet_jo_or_jo</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ending_jo1</span>, <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ending_jo2</span>) {
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (jo == ending_jo1 || jo == ending_jo2) {
      <span style="color: #f92672; font-weight: bold;">return</span> jo;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      compile_jo(jo);
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3390f10" class="outline-3">
<h3 id="org3390f10">p_compile_until_round_ket</h3>
<div class="outline-text-3" id="text-org3390f10">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_compile_until_round_ket</span>() {
  compile_until_meet_jo(ROUND_KET);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a8033d" class="outline-3">
<h3 id="org6a8033d">compile_jojo_until_ket</h3>
<div class="outline-text-3" id="text-org6a8033d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #a6e22e;">compile_jojo_until_ket</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ket</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = tos(compiling_stack);
  compile_until_meet_jo(ket);
  emit_jojo_end();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">jojo_len</span> = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)jojo;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">new_jojo</span> = array_len_dup(jojo, jojo_len);
  drop(compiling_stack);
  push(compiling_stack, jojo);
  <span style="color: #f92672; font-weight: bold;">return</span> new_jojo;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc42ce52" class="outline-3">
<h3 id="orgc42ce52">expose_compiler</h3>
<div class="outline-text-3" id="text-orgc42ce52">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_compiler</span>() {

}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2a5f18e" class="outline-2">
<h2 id="org2a5f18e"><b>control</b></h2>
<div class="outline-text-2" id="text-org2a5f18e">
</div><div id="outline-container-orgfa571e3" class="outline-3">
<h3 id="orgfa571e3">k_ignore</h3>
<div class="outline-text-3" id="text-orgfa571e3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_ignore</span>() {
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">s</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (s == ROUND_BAR) {
      k_ignore();
    }
    <span style="color: #f92672; font-weight: bold;">if</span> (s == ROUND_KET) {
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge12db62" class="outline-3">
<h3 id="orge12db62">ins_lit</h3>
<div class="outline-text-3" id="text-orge12db62">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_lit</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span> = jojo[0];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span> = jojo[1];
  ds_push(tag, data);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org736f3ee" class="outline-3">
<h3 id="org736f3ee">ins_jmp</h3>
<div class="outline-text-3" id="text-org736f3ee">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_jmp</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">offset</span> = jojo[0];
  rs_push(jojo + offset, p.t, p.d, p.l, p.y);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbfd5f21" class="outline-3">
<h3 id="orgbfd5f21">ins_jz</h3>
<div class="outline-text-3" id="text-orgbfd5f21">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">ins_jz</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  rs_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">offset</span> = jojo[0];
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t == TAG_BOOL &amp;&amp; a.d == <span style="color: #ae81ff;">false</span>) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">q</span> = rs_pop();
    rs_push(jojo + offset, p.t, p.d, q.l, q.y);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcbfa175" class="outline-3">
<h3 id="orgcbfa175">k_if</h3>
<div class="outline-text-3" id="text-orgcbfa175">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">//// </span><span style="color: #FF8888;">if then</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">(if a b p? then c d)</span>
<span style="color: #FF8888;">//// </span><span style="color: #FF8888;">==&gt;</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">a b p? jz[:end-of-then]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">c d</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-then</span>

<span style="color: #FF8888;">//// </span><span style="color: #FF8888;">if then else</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">(if a b p? then c d else e f)</span>
<span style="color: #FF8888;">//// </span><span style="color: #FF8888;">==&gt;</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">a b p? jz[:end-of-then]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">c d jmp[:end-of-else]</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-then</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">e f</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-else</span>

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_if</span>() {
  compile_until_meet_jo(JO_THEN);
  emit(JO_INS_JZ);
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">end_of_then</span> = tos(compiling_stack);
  p_compiling_stack_inc();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">ending_jo</span> = compile_until_meet_jo_or_jo(JO_ELSE, ROUND_KET);
  <span style="color: #f92672; font-weight: bold;">if</span> (ending_jo == ROUND_KET) {
    end_of_then[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - end_of_then;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    emit(JO_INS_JMP);
    <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">end_of_else</span> = tos(compiling_stack);
    p_compiling_stack_inc();
    end_of_then[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - end_of_then;
    p_compile_until_round_ket();
    end_of_else[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - end_of_else;
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org29344b5" class="outline-3">
<h3 id="org29344b5">compile_maybe_square</h3>
<div class="outline-text-3" id="text-org29344b5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">compile_maybe_square</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">first_jo</span> = read_jo();
  <span style="color: #f92672; font-weight: bold;">if</span> (first_jo == SQUARE_BAR) { compile_until_meet_jo(SQUARE_KET); }
  <span style="color: #f92672; font-weight: bold;">else</span> { compile_jo(first_jo); }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec727c4" class="outline-3">
<h3 id="orgec727c4">k_case</h3>
<div class="outline-text-3" id="text-orgec727c4">
<ul class="org-ul">
<li><p>k_case can only handle one-value</p></li></ul>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">//   </span><span style="color: #FF8888;">(case [...]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">tag [...]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">...)</span>
<span style="color: #FF8888;">//// </span><span style="color: #FF8888;">==&gt;</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[...]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">dup tag 'tag eq? jz[:end-of-this-case]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">drop [...] jmp[:end-of-case]</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-this-case</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">... ...</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-case</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">drop</span>

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_case</span>() {
  compile_maybe_square();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">counter</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">case_ends</span>[256];

  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">dc</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (dc == ROUND_KET) { <span style="color: #f92672; font-weight: bold;">break</span>; }

    emit(str2jo(<span style="color: #e6db74;">"dup"</span>));
    emit(str2jo(<span style="color: #e6db74;">"tag"</span>));
    {
      <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = malloc(1 + strlen(jo2str(dc)));
      tmp[0] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
      strcat(tmp, jo2str(dc));
      emit(JO_INS_LIT);
      emit(TAG_JO);
      emit(str2jo(tmp));
      free(tmp);
    }
    emit(str2jo(<span style="color: #e6db74;">"eq?"</span>));

    emit(JO_INS_JZ);
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">end_of_this_case</span> = tos(compiling_stack);
    p_compiling_stack_inc();
    emit(str2jo(<span style="color: #e6db74;">"drop"</span>));
    compile_maybe_square();

    emit(JO_INS_JMP);
    case_ends[counter] = tos(compiling_stack);
    counter++;
    p_compiling_stack_inc();

    end_of_this_case[0] = (<span style="color: #66d9ef; font-weight: bold;">jo_t</span>*)tos(compiling_stack) - end_of_this_case;
  }

  <span style="color: #f92672; font-weight: bold;">while</span> (counter &gt; 0) {
    counter--;
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">end_of_case</span> = case_ends[counter];
    end_of_case[0] = (<span style="color: #66d9ef; font-weight: bold;">jo_t</span>*)tos(compiling_stack) - end_of_case;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgacaf5c1" class="outline-3">
<h3 id="orgacaf5c1">k_cond</h3>
<div class="outline-text-3" id="text-orgacaf5c1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">//   </span><span style="color: #FF8888;">(cond</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[:t1 leaf? :t2 leaf? and] [...]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[:t1 node? :t2 node? and] [...]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">else [else-body])</span>
<span style="color: #FF8888;">//// </span><span style="color: #FF8888;">==&gt;</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[:t1 leaf? :t2 leaf? and] jz[:end-of-this-cond]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[...] jmp[:end-of-cond]</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-this-cond</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[:t1 node? :t2 node? and] jz[:end-of-this-cond]</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[...] jmp[:end-of-cond]</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-this-cond</span>
<span style="color: #FF8888;">//     </span><span style="color: #FF8888;">[else-body]</span>
<span style="color: #FF8888;">//   </span><span style="color: #FF8888;">:end-of-cond</span>

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_cond</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">counter</span> = 0;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cond_ends</span>[256];
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">s</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (s == ROUND_KET) { <span style="color: #f92672; font-weight: bold;">break</span>; }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (s == JO_ELSE) {
      compile_maybe_square();
      k_ignore();
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
    jo_unread(s);
    compile_maybe_square();
    emit(JO_INS_JZ);
    <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">end_of_this_cond</span> = tos(compiling_stack);
    p_compiling_stack_inc();

    compile_maybe_square();
    emit(JO_INS_JMP);
    cond_ends[counter] = tos(compiling_stack);
    counter++;
    p_compiling_stack_inc();

    end_of_this_cond[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - end_of_this_cond;
  }
  <span style="color: #f92672; font-weight: bold;">while</span> (counter &gt; 0) {
    counter--;
    <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">end_of_cond</span> = cond_ends[counter];
    end_of_cond[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - end_of_cond;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org87216b3" class="outline-3">
<h3 id="org87216b3">p_recur</h3>
<div class="outline-text-3" id="text-org87216b3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_recur</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  ds_push(p.t, p.d);
  disp_exe(JO_EXE-&gt;data, p.t);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc13171" class="outline-3">
<h3 id="orgcc13171">expose_control</h3>
<div class="outline-text-3" id="text-orgcc13171">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_control</span>() {
  plus_prim(<span style="color: #e6db74;">"note"</span>, k_ignore);
  plus_prim(<span style="color: #e6db74;">"ins/lit"</span>, ins_lit);

  plus_prim(<span style="color: #e6db74;">"ins/jmp"</span>, ins_jmp);
  plus_prim(<span style="color: #e6db74;">"ins/jz"</span>, ins_jz);

  plus_prim(<span style="color: #e6db74;">"if"</span>, k_if);
  plus_prim(<span style="color: #e6db74;">"begin"</span>, p_compile_until_round_ket);

  plus_prim(<span style="color: #e6db74;">"case"</span>, k_case);
  plus_prim(<span style="color: #e6db74;">"cond"</span>, k_cond);

  plus_prim(<span style="color: #e6db74;">"recur"</span>, p_recur);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb9fc41e" class="outline-2">
<h2 id="orgb9fc41e"><b>top</b></h2>
<div class="outline-text-2" id="text-orgb9fc41e">
</div><div id="outline-container-org6a4ea86" class="outline-3">
<h3 id="org6a4ea86">test_flag</h3>
<div class="outline-text-3" id="text-org6a4ea86">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #fd971f;">test_flag</span> = <span style="color: #ae81ff;">false</span>;
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_test_flag</span>() { ds_push(TAG_BOOL, test_flag); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_test_flag_on</span>() { test_flag = <span style="color: #ae81ff;">true</span>; }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_test_flag_off</span>() { test_flag = <span style="color: #ae81ff;">false</span>; }
</pre>
</div>
</div>
</div>

<div id="outline-container-org70c611d" class="outline-3">
<h3 id="org70c611d">k_plus_data</h3>
<div class="outline-text-3" id="text-org70c611d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #a6e22e;">#define</span> <span style="color: #fd971f;">MAX_FIELDS</span> 1024

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_plus_data</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = read_jo();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">fields</span>[MAX_FIELDS];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (i &gt;= MAX_FIELDS) {
      k_ignore();
      report(<span style="color: #e6db74;">"- k_plus_data fail\n"</span>);
      report(<span style="color: #e6db74;">"  too many fields\n"</span>);
      report(<span style="color: #e6db74;">"  MAX_FIELDS : %ld\n"</span>, MAX_FIELDS);
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">field</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (field == ROUND_KET) {
      fields[i] = 0;
      i++;
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
    fields[i] = field;
    i++;
  }
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">fresh_fields</span> = malloc(<span style="color: #66d9ef; font-weight: bold;">i</span>*<span style="color: #f92672; font-weight: bold;">sizeof</span>(jo_t));
  <span style="color: #f92672; font-weight: bold;">while</span> (i &gt; 0) {
    i--;
    fresh_fields[i] = fields[i];
  }
  plus_data(jo2str(name), fresh_fields);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org26f6e2b" class="outline-3">
<h3 id="org26f6e2b">k_arrow</h3>
<div class="outline-text-3" id="text-org26f6e2b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_arrow</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = read_jo();
  <span style="color: #f92672; font-weight: bold;">if</span> (jo == str2jo(<span style="color: #e6db74;">"--"</span>)) {
    k_ignore();
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == ROUND_KET) {
    <span style="color: #f92672; font-weight: bold;">return</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (local_string_p(jo2str(jo))) {
    k_arrow();
    emit(JO_INS_SET_LOCAL);
    emit(jo);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    k_arrow();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5520f8" class="outline-3">
<h3 id="orge5520f8">k_plus_jojo</h3>
<div class="outline-text-3" id="text-orge5520f8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_plus_jojo</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">fun_name</span> = read_jo();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = compile_jojo_until_ket(ROUND_KET);
  bind_name(fun_name, TAG_JOJO, new_jojo_gp(jojo));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf211582" class="outline-3">
<h3 id="orgf211582">expose_top</h3>
<div class="outline-text-3" id="text-orgf211582">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_top</span>() {
  plus_prim(<span style="color: #e6db74;">"test-flag"</span>, p_test_flag);
  plus_prim(<span style="color: #e6db74;">"test-flag-on"</span>, p_test_flag_on);
  plus_prim(<span style="color: #e6db74;">"test-flag-off"</span>, p_test_flag_off);

  plus_prim(<span style="color: #e6db74;">"-&gt;"</span>, k_arrow);
  plus_prim(<span style="color: #e6db74;">"+jojo"</span>, k_plus_jojo);
  plus_prim(<span style="color: #e6db74;">"+data"</span>, k_plus_data);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org199376a" class="outline-2">
<h2 id="org199376a"><b>repl</b></h2>
<div class="outline-text-2" id="text-org199376a">
</div><div id="outline-container-orgfc26b66" class="outline-3">
<h3 id="orgfc26b66">local_env_print</h3>
<div class="outline-text-3" id="text-orgfc26b66">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">data_print</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>);

<span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">local_env_empty_p</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span>) {
  <span style="color: #f92672; font-weight: bold;">return</span> lr-&gt;name == 0;
}

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">local_env_print</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (local_env_empty_p(lr)) {
    report(<span style="color: #e6db74;">"{}"</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"{"</span>);
    <span style="color: #f92672; font-weight: bold;">while</span> ((lr+1)-&gt;name != 0) {
      data_print(lr-&gt;local_tag, lr-&gt;local_data);
      report(<span style="color: #e6db74;">" %s! "</span>, jo2str(lr-&gt;name));
      lr++;
    }
    data_print(lr-&gt;local_tag, lr-&gt;local_data);
    report(<span style="color: #e6db74;">" %s!"</span>, jo2str(lr-&gt;name));
    report(<span style="color: #e6db74;">"}"</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf32bce" class="outline-3">
<h3 id="orgdf32bce">data_print</h3>
<div class="outline-text-3" id="text-orgdf32bce">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">jojo_print</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>);

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">data_print</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">tag</span>, <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">data</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_INT) {
    report(<span style="color: #e6db74;">"%ld"</span>, data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_STRING) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = data;
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = gp-&gt;p;
    report(<span style="color: #e6db74;">"\"%s\""</span>, str);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_JO) {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = data;
    report(<span style="color: #e6db74;">"'%s"</span>, jo2str(jo));
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_BOOL) {
    <span style="color: #f92672; font-weight: bold;">if</span> (data) {
      report(<span style="color: #e6db74;">"true"</span>);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      report(<span style="color: #e6db74;">"flase"</span>);
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_JOJO) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">jojo_gp</span> = data;
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = jojo_gp-&gt;p;
    jojo_print(jojo);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_LOCAL_ENV) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = data;
    local_env_print(lr);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (tag == TAG_CLOSURE) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">closure</span> = data;

    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = get_field(TAG_CLOSURE, closure,
                            str2jo(<span style="color: #e6db74;">".local-env"</span>));
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = ap-&gt;p;

    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = get_field(TAG_CLOSURE, closure,
                            str2jo(<span style="color: #e6db74;">".jojo"</span>));
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">jojo_gp</span> = b.d;
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = jojo_gp-&gt;p;

    <span style="color: #f92672; font-weight: bold;">if</span> (local_env_empty_p(lr)) {
      jojo_print(jojo);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      local_env_print(lr);
      report(<span style="color: #e6db74;">"+"</span>);
      jojo_print(jojo);
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>in_jotable_p(tag)) {
    report(<span style="color: #e6db74;">"[&lt;bad-tag:%ld&gt; %ld]"</span>, tag, data);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"[%s %ld]"</span>, jo2str(tag), data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org248c8a8" class="outline-3">
<h3 id="org248c8a8">p_data_print</h3>
<div class="outline-text-3" id="text-org248c8a8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_data_print</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  data_print(a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde700f9" class="outline-3">
<h3 id="orgde700f9">jojo_print_one</h3>
<div class="outline-text-3" id="text-orgde700f9">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #a6e22e;">jojo_print_one</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_INS_LIT) {
    data_print(jojo[1], jojo[2]);
    jojo++;
    jojo++;
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_INS_JZ) {
    report(<span style="color: #e6db74;">"(jz %ld)"</span>, jojo[1]);
    jojo++;
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_INS_JMP) {
    report(<span style="color: #e6db74;">"(jmp %ld)"</span>, jojo[1]);
    jojo++;
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_INS_LOCAL ||
           jojo[0] == JO_INS_DYNAMIC_LOCAL ||
           jojo[0] == JO_INS_FIELD) {
    report(<span style="color: #e6db74;">"%s"</span>, jo2str(jojo[1]));
    jojo++;
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_INS_SET_LOCAL ||
           jojo[0] == JO_INS_SET_DYNAMIC_LOCAL ||
           jojo[0] == JO_INS_SET_FIELD) {
    report(<span style="color: #e6db74;">"%s!"</span>, jo2str(jojo[1]));
    jojo++;
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"%s"</span>, jo2str(jojo[0]));
    jojo++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> jojo;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org66ec0c3" class="outline-3">
<h3 id="org66ec0c3">jojo_print</h3>
<div class="outline-text-3" id="text-org66ec0c3">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">jojo_print</span>(<span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span>) {
  report(<span style="color: #e6db74;">"{"</span>);
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_END &amp;&amp; jojo[1] == 0) { <span style="color: #f92672; font-weight: bold;">break</span>; }
    jojo = jojo_print_one(jojo);
    <span style="color: #f92672; font-weight: bold;">if</span> (jojo[0] == JO_END &amp;&amp; jojo[1] == 0) { <span style="color: #f92672; font-weight: bold;">break</span>; }
    report(<span style="color: #e6db74;">" "</span>);
  }
  report(<span style="color: #e6db74;">"}"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbdf6a6b" class="outline-3">
<h3 id="orgbdf6a6b">p_print_ds</h3>
<div class="outline-text-3" id="text-orgbdf6a6b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_print_ds</span>() {
  report(<span style="color: #e6db74;">"  * %ld *  "</span>, ds_length());
  report(<span style="color: #e6db74;">"-- "</span>);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; ds_length()) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_ref(i);
    data_print(a.t, a.d);  report(<span style="color: #e6db74;">" "</span>);
    i++;
  }
  report(<span style="color: #e6db74;">"--\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc09046f" class="outline-3">
<h3 id="orgc09046f">print_return_point</h3>
<div class="outline-text-3" id="text-orgc09046f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">print_return_point</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span>) {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
  report(<span style="color: #e6db74;">"    &gt;&gt; %s &lt;&lt; "</span>, jo2str(*(jojo - 1)));
  jojo_print(jojo);
  report(<span style="color: #e6db74;">"\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfad9587" class="outline-3">
<h3 id="orgfad9587">p_print_rs</h3>
<div class="outline-text-3" id="text-orgfad9587">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_print_rs</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length</span> = rs_length();
  report(<span style="color: #e6db74;">"  - return-stack * %ld * :\n"</span>, length);
  <span style="color: #f92672; font-weight: bold;">if</span> (length == 0) { <span style="color: #f92672; font-weight: bold;">return</span>; };
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (index &lt; length - 1) {
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_ref(index);
    print_return_point(p);
    index++;
  }
  { <span style="color: #FF8888;">// </span><span style="color: #FF8888;">tos of rs is special</span>
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_ref(index);
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = p.j;
    report(<span style="color: #e6db74;">"    =&gt; "</span>);
    jojo_print(jojo);
    report(<span style="color: #e6db74;">"\n"</span>);
    index++;
    index++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f8a356" class="outline-3">
<h3 id="org3f8a356">repl_flag</h3>
<div class="outline-text-3" id="text-org3f8a356">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #fd971f;">repl_flag</span> = <span style="color: #ae81ff;">false</span>;
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_repl_flag</span>() { ds_push(TAG_BOOL, repl_flag); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_repl_flag_on</span>() { repl_flag = <span style="color: #ae81ff;">true</span>; }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_repl_flag_off</span>() { repl_flag = <span style="color: #ae81ff;">false</span>; }
</pre>
</div>
</div>
</div>

<div id="outline-container-org30ef1a6" class="outline-3">
<h3 id="org30ef1a6">repl_one_step</h3>
<div class="outline-text-3" id="text-org30ef1a6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">repl_one_step</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = tos(compiling_stack);
  compile_jo(read_jo());
  emit_jojo_end();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">jojo_len</span> = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)jojo;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">new_jojo</span> = array_len_dup(jojo, jojo_len);
  drop(compiling_stack);
  push(compiling_stack, jojo);
  rs_push(new_jojo,
          TAG_JOJO,
          new_jojo_gp(new_jojo),
          current_local_counter,
          current_dynamic_local_counter);
  eval();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org97c1a8a" class="outline-3">
<h3 id="org97c1a8a">repl</h3>
<div class="outline-text-3" id="text-org97c1a8a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">repl</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  push(reading_stack, input_stack);
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>has_jo_p()) {
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    repl_one_step();
    <span style="color: #f92672; font-weight: bold;">if</span> (repl_flag) {
      p_print_ds();
    }
  }
  drop(reading_stack);
  input_stack_free(input_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8197579" class="outline-3">
<h3 id="org8197579">debug_repl</h3>
<div class="outline-text-3" id="text-org8197579">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">debug_repl_level</span> = 0;

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">debug_repl</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span>) {
  push(reading_stack, input_stack);
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>has_jo_p()) {
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    repl_one_step();
    p_print_ds();
    report(<span style="color: #e6db74;">"debug[%ld]&gt; "</span>, debug_repl_level);
  }
  drop(reading_stack);
  input_stack_free(input_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ccd5b5" class="outline-3">
<h3 id="org5ccd5b5">p_debug</h3>
<div class="outline-text-3" id="text-org5ccd5b5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_debug</span>() {
  report(<span style="color: #e6db74;">"- in debug-repl [level %ld] &gt;_&lt;!\n"</span>, debug_repl_level);
  p_print_rs();
  p_print_ds();
  report(<span style="color: #e6db74;">"debug[%ld]&gt; "</span>, debug_repl_level);
  debug_repl_level++;
  debug_repl(terminal_input_stack());
  debug_repl_level--;
  report(<span style="color: #e6db74;">"- exit debug-repl [level %ld]\n"</span>, debug_repl_level);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org17507fd" class="outline-3">
<h3 id="org17507fd">to handle kernel signal</h3>
<div class="outline-text-3" id="text-org17507fd">
</div><div id="outline-container-org57c28c8" class="outline-4">
<h4 id="org57c28c8"><span class="todo _note_">[note]</span> </h4>
<div class="outline-text-4" id="text-org57c28c8">
<ul class="org-ul">
<li><p><p></p><p>A function is said to be reentrant</p><p>if it can safely be simultaneously executed</p><p>by multiple threads of execution in the same process.</p><p>In this context, “safe” means that</p><p>the function achieves its expected result,</p><p>regardless of the state of execution</p><p>of any other thread of execution.</p><p></p></p><p></p><p><p></p><p>Because a signal handler may asynchronously interrupt</p><p>the execution of a program at any point in time,</p><p>the main program and the signal handler</p><p>in effect form two independent</p><p>(although not concurrent) threads of execution</p><p>within the same process.</p><p></p></p><p></p><p><p></p><p>&#x2013; quote from (2010) (michael kerrisk) the linux programming interface</p><p></p></p></li>

<li><p>thus single handler must be reentrant.</p></li>

<li><p>since nonreentrant functions in many C libraries [specially stdio],</p><p>and we can call such functions in the debug repl of jojo,</p><p>we should not simply call the debug repl in the kernel_signal_handler.</p></li>

<li><p><p></p><p>but except introducing runtime overhead,</p><p>I can think of not solutions to this problem.</p><p></p></p><p></p><p><p></p><p>thus, after exited the debug repl,</p><p>possibly unnecessary errors that induced by nonreentrant functions,</p><p>might lead you into the debug repl again.</p><p></p></p><p></p><p><p></p><p>thus, the debug repl is not reliable to enable you</p><p>to recover from any errors which trigger kernel signal.</p><p>[the debug repl can only debug them.]</p><p></p></p></li></ul>
</div>
</div>

<div id="outline-container-orge64248" class="outline-4">
<h4 id="orge64248">kernel_signal_handler</h4>
<div class="outline-text-4" id="text-orge64248">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">kernel_signal_handler</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">sig</span>, <span style="color: #66d9ef; font-weight: bold;">siginfo_t</span> *<span style="color: #fd971f;">siginfo</span>, <span style="color: #66d9ef; font-weight: bold;">void</span> *<span style="color: #fd971f;">ucontext</span>) {
  fflush(stdin);
  fflush(stdout);
  fflush(stderr);

  report(<span style="color: #e6db74;">"- kernel_signal_handler\n"</span>);
  psiginfo(siginfo, <span style="color: #e6db74;">"  signal "</span>);

  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">errno_backup</span>;
  errno_backup = errno;

  p_debug();

  errno = errno_backup;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org59c2597" class="outline-4">
<h4 id="org59c2597">init_kernel_signal_handler</h4>
<div class="outline-text-4" id="text-org59c2597">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_kernel_signal_handler</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">sigaction</span> <span style="color: #fd971f;">kernel_signal_action</span>;

  sigemptyset(&amp;kernel_signal_action.sa_mask);

  kernel_signal_action.sa_flags
    = SA_SIGINFO
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">| SA_NODEFER</span>
    | SA_RESTART;
  kernel_signal_action.sa_sigaction = kernel_signal_handler;

  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">sig_array</span>[] = { SIGSEGV, SIGBUS, SIGFPE, SIGILL,
                      SIGPIPE, SIGSYS, SIGXCPU, SIGXFSZ};

  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">sig_array_length</span> = <span style="color: #f92672; font-weight: bold;">sizeof</span>(sig_array)/<span style="color: #f92672; font-weight: bold;">sizeof</span>(sig_array[0]);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; sig_array_length) {
    <span style="color: #f92672; font-weight: bold;">if</span> (sigaction(sig_array[i], &amp;kernel_signal_action, 0) == -1) {
      perror(<span style="color: #e6db74;">"- init_kernel_signal_handler fail"</span>);
    }
    i++;
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgccea3a5" class="outline-3">
<h3 id="orgccea3a5">expose_repl</h3>
<div class="outline-text-3" id="text-orgccea3a5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_repl</span>() {
  plus_prim(<span style="color: #e6db74;">"data-print"</span>, p_data_print);
  plus_prim(<span style="color: #e6db74;">"print-data-stack"</span>, p_print_ds);

  plus_prim(<span style="color: #e6db74;">"repl-flag"</span>, p_repl_flag);
  plus_prim(<span style="color: #e6db74;">"repl-flag-on"</span>, p_repl_flag_on);
  plus_prim(<span style="color: #e6db74;">"repl-flag-off"</span>, p_repl_flag_off);

  plus_prim(<span style="color: #e6db74;">"debug"</span>, p_debug);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5acd439" class="outline-2">
<h2 id="org5acd439">step</h2>
<div class="outline-text-2" id="text-org5acd439">
</div><div id="outline-container-orgbd0b760" class="outline-3">
<h3 id="orgbd0b760">report_one_step</h3>
<div class="outline-text-3" id="text-orgbd0b760">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #fd971f;">step_flag</span> = <span style="color: #ae81ff;">false</span>;
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">stepper_counter</span> = 0;
<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">pending_steps</span> = 0;

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report_one_step</span>() {
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #f92672; font-weight: bold;">if</span> (pending_steps &gt; 0) {
      p_print_rs();
      p_print_ds();
      stepper_counter++;
      report(<span style="color: #e6db74;">"- stepper counting : %ld\n"</span>, stepper_counter);
      pending_steps--;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>has_jo_p()) {
      step_flag = <span style="color: #ae81ff;">false</span>;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = read_jo();
    <span style="color: #f92672; font-weight: bold;">if</span> (jo == str2jo(<span style="color: #e6db74;">"help"</span>)) {
      report(<span style="color: #e6db74;">"- stepper usage :\n"</span>);
      report(<span style="color: #e6db74;">"  type '.' to execute one step\n"</span>);
      report(<span style="color: #e6db74;">"  type a numebr to execute the number of steps\n"</span>);
      report(<span style="color: #e6db74;">"  - available commands :\n"</span>);
      report(<span style="color: #e6db74;">"    help exit bye\n"</span>);
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == str2jo(<span style="color: #e6db74;">"."</span>)) {
      p_print_rs();
      p_print_ds();
      stepper_counter++;
      report(<span style="color: #e6db74;">"- stepper counting : %ld\n"</span>, stepper_counter);
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (nat_string_p(jo2str(jo))) {
      p_print_rs();
      p_print_ds();
      stepper_counter++;
      report(<span style="color: #e6db74;">"- stepper counting : %ld\n"</span>, stepper_counter);
      pending_steps = string_to_int(jo2str(jo)) - 1;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == str2jo(<span style="color: #e6db74;">"exit"</span>)) {
      step_flag = <span style="color: #ae81ff;">false</span>;
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (jo == str2jo(<span style="color: #e6db74;">"bye"</span>)) {
      p_bye();
      <span style="color: #f92672; font-weight: bold;">return</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      <span style="color: #FF8888;">// </span><span style="color: #FF8888;">loop</span>
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c88594" class="outline-3">
<h3 id="org3c88594">eval_one_step_at_level</h3>
<div class="outline-text-3" id="text-org3c88594">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">eval_one_step_at_level</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">level</span>) {
  eval_one_step();
  <span style="color: #f92672; font-weight: bold;">while</span> (rs-&gt;pointer &gt; level) {
    eval_one_step();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8cc67c" class="outline-3">
<h3 id="orgf8cc67c">p_step</h3>
<div class="outline-text-3" id="text-orgf8cc67c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_step</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">input_stack</span> = terminal_input_stack();
  push(reading_stack, input_stack);
  step_flag = <span style="color: #ae81ff;">true</span>;
  stepper_counter = 0;
  pending_steps = 0;
  report(<span style="color: #e6db74;">"stepper&gt; "</span>);

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">base</span> = rs-&gt;pointer;
  <span style="color: #f92672; font-weight: bold;">while</span> (rs-&gt;pointer &gt;= base) {
    eval_one_step_at_level(base);
    eval_one_step();
    report_one_step();
  }

  <span style="color: #f92672; font-weight: bold;">if</span> (rs-&gt;pointer &gt;= base) {
    report(<span style="color: #e6db74;">"- exit stepper\n"</span>);
  }

  <span style="color: #f92672; font-weight: bold;">if</span> (rs-&gt;pointer &lt; base) {
    report(<span style="color: #e6db74;">"- the stepped jojo is finished\n"</span>);
    report(<span style="color: #e6db74;">"- automatically exit stepper\n"</span>);
  }

  drop(reading_stack);
  input_stack_free(input_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgced35e0" class="outline-3">
<h3 id="orgced35e0">expose_step</h3>
<div class="outline-text-3" id="text-orgced35e0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_step</span>() {
  plus_prim(<span style="color: #e6db74;">"step"</span>, p_step);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3072416" class="outline-2">
<h2 id="org3072416">&lt;bool&gt;</h2>
<div class="outline-text-2" id="text-org3072416">
</div><div id="outline-container-orgb77bcbf" class="outline-3">
<h3 id="orgb77bcbf">p_true</h3>
<div class="outline-text-3" id="text-orgb77bcbf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_true</span>() {
  ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfcf31fa" class="outline-3">
<h3 id="orgfcf31fa">p_false</h3>
<div class="outline-text-3" id="text-orgfcf31fa">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_false</span>() {
  ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org39cbc6f" class="outline-3">
<h3 id="org39cbc6f">p_not</h3>
<div class="outline-text-3" id="text-org39cbc6f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_not</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_BOOL, <span style="color: #960050;">!</span>a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbcf1a80" class="outline-3">
<h3 id="orgbcf1a80">p_and</h3>
<div class="outline-text-3" id="text-orgbcf1a80">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_and</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, a.d &amp;&amp; b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org96e8de6" class="outline-3">
<h3 id="org96e8de6">p_or</h3>
<div class="outline-text-3" id="text-org96e8de6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_or</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, a.d || b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7247e4e" class="outline-3">
<h3 id="org7247e4e">expose_bool</h3>
<div class="outline-text-3" id="text-org7247e4e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_bool</span>() {
  plus_atom(<span style="color: #e6db74;">"&lt;bool&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"true"</span>, p_true);
  plus_prim(<span style="color: #e6db74;">"false"</span>, p_false);
  plus_prim(<span style="color: #e6db74;">"not"</span>, p_not);
  plus_prim(<span style="color: #e6db74;">"and"</span>, p_and);
  plus_prim(<span style="color: #e6db74;">"or"</span>, p_or);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5f697ad" class="outline-2">
<h2 id="org5f697ad">&lt;string&gt;</h2>
<div class="outline-text-2" id="text-org5f697ad">
</div><div id="outline-container-org763a38a" class="outline-3">
<h3 id="org763a38a">new_string_gp</h3>
<div class="outline-text-3" id="text-org763a38a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #a6e22e;">new_string_gp</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = TAG_STRING-&gt;data;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = new_record_gp();
  gp-&gt;class = class;
  gp-&gt;p = str;
  <span style="color: #f92672; font-weight: bold;">return</span> gp;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org144f78f" class="outline-3">
<h3 id="org144f78f">compile_string</h3>
<div class="outline-text-3" id="text-org144f78f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">compile_string</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">"..."</span>
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buffer</span>[1024 * 1024];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span> = read_byte();
    <span style="color: #f92672; font-weight: bold;">if</span> (c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'"</span><span style="color: #d33682; font-weight: bold;">'</span>) {
      buffer[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      buffer[cursor] = c;
      cursor++;
    }
  }
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = strdup(buffer);

  emit(JO_INS_LIT);
  emit(TAG_STRING);
  emit(new_string_gp(str));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org78a9eb" class="outline-3">
<h3 id="org78a9eb">string_write</h3>
<div class="outline-text-3" id="text-org78a9eb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">string_write</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">while</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    byte_write(str[0]);
    str++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org64ead85" class="outline-3">
<h3 id="org64ead85">p_string_write</h3>
<div class="outline-text-3" id="text-org64ead85">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_write</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  string_write(ap-&gt;p);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8491b05" class="outline-3">
<h3 id="org8491b05">p_string_length</h3>
<div class="outline-text-3" id="text-org8491b05">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_length</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  ds_push(TAG_INT, strlen(ap-&gt;p));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c69b41" class="outline-3">
<h3 id="org5c69b41">p_string_ref</h3>
<div class="outline-text-3" id="text-org5c69b41">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_ref</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">bp</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = bp-&gt;p;
  ds_push(TAG_BYTE, str[a.d]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1e512" class="outline-3">
<h3 id="orge1e512">p_string_append</h3>
<div class="outline-text-3" id="text-orge1e512">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_append</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">bp</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str0</span> = bp-&gt;p;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str1</span> = ap-&gt;p;

  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str2</span> = malloc(strlen(str0) + strlen(str1) + 1);
  str2[0] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  strcat(str2, str0);
  strcat(str2, str1);

  ds_push(TAG_STRING, new_string_gp(str2));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b62bc8" class="outline-3">
<h3 id="org7b62bc8">p_string_slice</h3>
<div class="outline-text-3" id="text-org7b62bc8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_slice</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[&lt;string&gt; begin end] -&gt; [&lt;string&gt;]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">co</span> = c.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str0</span> = co-&gt;p;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">begin</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">end</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str1</span> = substring(str0, begin, end);

  ds_push(TAG_STRING, new_string_gp(str1));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb7327e" class="outline-3">
<h3 id="orgbb7327e">p_string_empty_p</h3>
<div class="outline-text-3" id="text-orgbb7327e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_empty_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = ap-&gt;p;
  ds_push(TAG_BOOL, str[0] == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org780a7be" class="outline-3">
<h3 id="org780a7be">p_string_eq_p</h3>
<div class="outline-text-3" id="text-org780a7be">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_eq_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">bp</span> = b.d;
  ds_push(TAG_BOOL, string_equal(ap-&gt;p, bp-&gt;p));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7256487" class="outline-3">
<h3 id="org7256487">p_read_string</h3>
<div class="outline-text-3" id="text-org7256487">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_read_string</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buffer</span>[1024 * 1024];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span> = read_byte();
    <span style="color: #f92672; font-weight: bold;">if</span> (c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'"</span><span style="color: #d33682; font-weight: bold;">'</span>) {
      buffer[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      buffer[cursor] = c;
      cursor++;
    }
  }
  ds_push(TAG_STRING, new_string_gp(strdup(buffer)));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc02aef0" class="outline-3">
<h3 id="orgc02aef0">p_read_line</h3>
<div class="outline-text-3" id="text-orgc02aef0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_read_line</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buffer</span>[1024 * 1024];
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (<span style="color: #ae81ff;">true</span>) {
    <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">c</span> = read_byte();
    <span style="color: #f92672; font-weight: bold;">if</span> (c == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\n</span><span style="color: #d33682; font-weight: bold;">'</span>) {
      buffer[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\n</span><span style="color: #d33682; font-weight: bold;">'</span>;
      cursor++;
      buffer[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
      <span style="color: #f92672; font-weight: bold;">break</span>;
    }
    <span style="color: #f92672; font-weight: bold;">else</span> {
      buffer[cursor] = c;
      cursor++;
    }
  }
  ds_push(TAG_STRING, new_string_gp(strdup(buffer)));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org447f054" class="outline-3">
<h3 id="org447f054">p_string_to_jo</h3>
<div class="outline-text-3" id="text-org447f054">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_string_to_jo</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = ap-&gt;p;
  ds_push(TAG_JO, str2jo(str));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5df19fa" class="outline-3">
<h3 id="org5df19fa">expose_string</h3>
<div class="outline-text-3" id="text-org5df19fa">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_string</span>() {
  plus_prim(<span style="color: #e6db74;">"string-write"</span>, p_string_write);
  plus_prim(<span style="color: #e6db74;">"string-length"</span>, p_string_length);
  plus_prim(<span style="color: #e6db74;">"string-ref"</span>, p_string_ref);
  plus_prim(<span style="color: #e6db74;">"string-append"</span>, p_string_append);
  plus_prim(<span style="color: #e6db74;">"string-slice"</span>, p_string_slice);
  plus_prim(<span style="color: #e6db74;">"string-empty?"</span>, p_string_empty_p);
  plus_prim(<span style="color: #e6db74;">"string-eq?"</span>, p_string_eq_p);

  plus_prim(<span style="color: #e6db74;">"read-string"</span>, p_read_string);
  plus_prim(<span style="color: #e6db74;">"read-line"</span>, p_read_line);

  plus_prim(<span style="color: #e6db74;">"string-&gt;jo"</span>, p_string_to_jo);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge146e9d" class="outline-2">
<h2 id="orge146e9d">&lt;int&gt;</h2>
<div class="outline-text-2" id="text-orge146e9d">
</div><div id="outline-container-orgb99e045" class="outline-3">
<h3 id="orgb99e045">p_inc</h3>
<div class="outline-text-3" id="text-orgb99e045">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_inc</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_INT, a.d + 1);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org806b089" class="outline-3">
<h3 id="org806b089">p_dec</h3>
<div class="outline-text-3" id="text-org806b089">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_dec</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_INT, a.d - 1);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f3506a" class="outline-3">
<h3 id="org7f3506a">p_neg</h3>
<div class="outline-text-3" id="text-org7f3506a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_neg</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_INT, - a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8892631" class="outline-3">
<h3 id="org8892631">p_add</h3>
<div class="outline-text-3" id="text-org8892631">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_add</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_INT, a.d + b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge24957d" class="outline-3">
<h3 id="orge24957d">p_sub</h3>
<div class="outline-text-3" id="text-orge24957d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_sub</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_INT, b.d - a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org958fad" class="outline-3">
<h3 id="org958fad">p_mul</h3>
<div class="outline-text-3" id="text-org958fad">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_mul</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_INT, a.d * b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f1cac4" class="outline-3">
<h3 id="org7f1cac4">p_div</h3>
<div class="outline-text-3" id="text-org7f1cac4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_div</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_INT, b.d / a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8364b5" class="outline-3">
<h3 id="org8364b5">p_mod</h3>
<div class="outline-text-3" id="text-org8364b5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_mod</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_INT, b.d % a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2f1096" class="outline-3">
<h3 id="orgb2f1096">p_gt_p</h3>
<div class="outline-text-3" id="text-orgb2f1096">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_gt_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, b.d &gt; a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf41dbf" class="outline-3">
<h3 id="orgbf41dbf">p_lt_p</h3>
<div class="outline-text-3" id="text-orgbf41dbf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_lt_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, b.d &lt; a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb09e24" class="outline-3">
<h3 id="orgbb09e24">p_gteq_p</h3>
<div class="outline-text-3" id="text-orgbb09e24">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_gteq_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, b.d &gt;= a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1aafce5" class="outline-3">
<h3 id="org1aafce5">p_lteq_p</h3>
<div class="outline-text-3" id="text-org1aafce5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_lteq_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(TAG_BOOL, b.d &lt;= a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org17bcf5a" class="outline-3">
<h3 id="org17bcf5a">p_int_write</h3>
<div class="outline-text-3" id="text-org17bcf5a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_int_write</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">buffer</span> [32];
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  sprintf(buffer, <span style="color: #e6db74;">"%ld"</span>, a.d);
  string_write(buffer);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga18686c" class="outline-3">
<h3 id="orga18686c">expose_int</h3>
<div class="outline-text-3" id="text-orga18686c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_int</span>() {
  plus_prim(<span style="color: #e6db74;">"inc"</span>, p_inc);
  plus_prim(<span style="color: #e6db74;">"dec"</span>, p_dec);
  plus_prim(<span style="color: #e6db74;">"neg"</span>, p_neg);

  plus_prim(<span style="color: #e6db74;">"add"</span>, p_add);
  plus_prim(<span style="color: #e6db74;">"sub"</span>, p_sub);

  plus_prim(<span style="color: #e6db74;">"mul"</span>, p_mul);
  plus_prim(<span style="color: #e6db74;">"div"</span>, p_div);
  plus_prim(<span style="color: #e6db74;">"mod"</span>, p_mod);

  plus_prim(<span style="color: #e6db74;">"gt?"</span>, p_gt_p);
  plus_prim(<span style="color: #e6db74;">"lt?"</span>, p_lt_p);
  plus_prim(<span style="color: #e6db74;">"gteq?"</span>, p_gteq_p);
  plus_prim(<span style="color: #e6db74;">"lteq?"</span>, p_lteq_p);

  plus_prim(<span style="color: #e6db74;">"int-write"</span>, p_int_write);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org99d716e" class="outline-2">
<h2 id="org99d716e">&lt;jo&gt;</h2>
<div class="outline-text-2" id="text-org99d716e">
</div><div id="outline-container-org88d89f8" class="outline-3">
<h3 id="org88d89f8">special literal jo</h3>
<div class="outline-text-3" id="text-org88d89f8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_round_bar</span>()    { ds_push(TAG_JO, ROUND_BAR); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_round_ket</span>()    { ds_push(TAG_JO, ROUND_KET); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_square_bar</span>()   { ds_push(TAG_JO, SQUARE_BAR); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_square_ket</span>()   { ds_push(TAG_JO, SQUARE_KET); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_flower_bar</span>()   { ds_push(TAG_JO, FLOWER_BAR); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_flower_ket</span>()   { ds_push(TAG_JO, FLOWER_KET); }

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_doublequote</span>()  { ds_push(TAG_JO, DOUBLEQUOTE); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_singlequote</span>()  { ds_push(TAG_JO, SINGLEQUOTE); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_backquote</span>()    { ds_push(TAG_JO, BACKQUOTE); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_comma</span>()        { ds_push(TAG_JO, COMMA); }
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9fad5b" class="outline-3">
<h3 id="orge9fad5b">p_jo_write</h3>
<div class="outline-text-3" id="text-orge9fad5b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_write</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  string_write(jo2str(a.d));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org262079e" class="outline-3">
<h3 id="org262079e">p_jo_unread</h3>
<div class="outline-text-3" id="text-org262079e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_unread</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  jo_unread(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb97919c" class="outline-3">
<h3 id="orgb97919c">p_jo_apply</h3>
<div class="outline-text-3" id="text-orgb97919c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_apply</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  jo_apply(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c0eff5" class="outline-3">
<h3 id="org6c0eff5">p_jo_to_int</h3>
<div class="outline-text-3" id="text-org6c0eff5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_to_int</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_INT, string_to_int(jo2str(a.d)));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb39ee5c" class="outline-3">
<h3 id="orgb39ee5c">p_jo_to_byte</h3>
<div class="outline-text-3" id="text-orgb39ee5c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_to_byte</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(a.d);
  ds_push(TAG_BYTE, str[0]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org907602c" class="outline-3">
<h3 id="org907602c">p_int_jo_p</h3>
<div class="outline-text-3" id="text-org907602c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_int_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, int_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgccd8afc" class="outline-3">
<h3 id="orgccd8afc">p_local_jo_p</h3>
<div class="outline-text-3" id="text-orgccd8afc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_local_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, local_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3cfac36" class="outline-3">
<h3 id="org3cfac36">p_set_local_jo_p</h3>
<div class="outline-text-3" id="text-org3cfac36">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_local_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, set_local_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d69b38" class="outline-3">
<h3 id="org1d69b38">p_field_jo_p</h3>
<div class="outline-text-3" id="text-org1d69b38">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_field_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, field_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge833acc" class="outline-3">
<h3 id="orge833acc">p_set_field_jo_p</h3>
<div class="outline-text-3" id="text-orge833acc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_field_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, set_field_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org317964f" class="outline-3">
<h3 id="org317964f">p_tag_jo_p</h3>
<div class="outline-text-3" id="text-org317964f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_tag_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, tag_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org85ac8c1" class="outline-3">
<h3 id="org85ac8c1">underscore_string_p</h3>
<div class="outline-text-3" id="text-org85ac8c1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">underscore_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (*str == <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">true</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (*str != <span style="color: #f8f8f0; background-color: #1b1d1e;">'_</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> underscore_string_p(str++);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org350f4d" class="outline-3">
<h3 id="org350f4d">p_underscore_jo_p</h3>
<div class="outline-text-3" id="text-org350f4d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_underscore_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, underscore_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge0e1f3c" class="outline-3">
<h3 id="orge0e1f3c">p_get_local_jo_to_set_local_jo</h3>
<div class="outline-text-3" id="text-orge0e1f3c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_get_local_jo_to_set_local_jo</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(a.d);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = malloc(2 + strlen(str));
  tmp[0] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  strcat(tmp, str);
  strcat(tmp, <span style="color: #e6db74;">"!"</span>);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = str2jo(tmp);
  free(tmp);
  ds_push(TAG_JO, jo);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org79f6a22" class="outline-3">
<h3 id="org79f6a22">dynamic_local_string_p</h3>
<div class="outline-text-3" id="text-org79f6a22">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">dynamic_local_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (strlen(str) &lt;= 2) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> local_string_p(str+1);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcad49a4" class="outline-3">
<h3 id="orgcad49a4">set_dynamic_local_string_p</h3>
<div class="outline-text-3" id="text-orgcad49a4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">bool</span> <span style="color: #a6e22e;">set_dynamic_local_string_p</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (strlen(str) &lt;= 2) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (str[0] != <span style="color: #f8f8f0; background-color: #1b1d1e;">':</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    <span style="color: #f92672; font-weight: bold;">return</span> <span style="color: #ae81ff;">false</span>;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #f92672; font-weight: bold;">return</span> set_local_string_p(str+1);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd02fd7e" class="outline-3">
<h3 id="orgd02fd7e">p_dynamic_local_jo_p</h3>
<div class="outline-text-3" id="text-orgd02fd7e">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_dynamic_local_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, dynamic_local_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8e1a0ef" class="outline-3">
<h3 id="org8e1a0ef">p_set_dynamic_local_jo_p</h3>
<div class="outline-text-3" id="text-org8e1a0ef">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_dynamic_local_jo_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BOOL, set_dynamic_local_string_p(jo2str(a.d)));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaa1d78a" class="outline-3">
<h3 id="orgaa1d78a">p_jo_to_string</h3>
<div class="outline-text-3" id="text-orgaa1d78a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_to_string</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = a.d;
  ds_push(TAG_STRING, new_string_gp(strdup(jo2str(jo))));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga080dbf" class="outline-3">
<h3 id="orga080dbf">p_jo_bound_p</h3>
<div class="outline-text-3" id="text-orga080dbf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_bound_p</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = a.d;
    ds_push(TAG_BOOL, jo_bound_p(jo));
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf75fab6" class="outline-3">
<h3 id="orgf75fab6">p_jo_ref</h3>
<div class="outline-text-3" id="text-orgf75fab6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_ref</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">if</span> (a.t != TAG_JO) {
    report(<span style="color: #e6db74;">"- p_jo_ref fail\n"</span>);
    report(<span style="color: #e6db74;">"  argument is not a jo : "</span>);
    data_print(a.t, a.d);
    report(<span style="color: #e6db74;">"\n"</span>);
    p_debug();
  }
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jo</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">if</span> (<span style="color: #960050;">!</span>jo_bound_p(jo)) {
    report(<span style="color: #e6db74;">"- p_jo_ref fail\n"</span>);
    report(<span style="color: #e6db74;">"  jo is unbound : "</span>);
    data_print(a.t, a.d);
    report(<span style="color: #e6db74;">"\n"</span>);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(jo-&gt;tag, jo-&gt;data);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga27a990" class="outline-3">
<h3 id="orga27a990">expose_jo</h3>
<div class="outline-text-3" id="text-orga27a990">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_jo</span>() {
  plus_prim(<span style="color: #e6db74;">"round-bar"</span>,    p_round_bar);
  plus_prim(<span style="color: #e6db74;">"round-ket"</span>,    p_round_ket);
  plus_prim(<span style="color: #e6db74;">"square-bar"</span>,   p_square_bar);
  plus_prim(<span style="color: #e6db74;">"square-ket"</span>,   p_square_ket);
  plus_prim(<span style="color: #e6db74;">"flower-bar"</span>,   p_flower_bar);
  plus_prim(<span style="color: #e6db74;">"flower-ket"</span>,   p_flower_ket);

  plus_prim(<span style="color: #e6db74;">"doublequote"</span>,  p_doublequote);
  plus_prim(<span style="color: #e6db74;">"singlequote"</span>,  p_singlequote);
  plus_prim(<span style="color: #e6db74;">"backquote"</span>,    p_backquote);
  plus_prim(<span style="color: #e6db74;">"comma"</span>,        p_comma);

  plus_prim(<span style="color: #e6db74;">"jo-write"</span>,  p_jo_write);
  plus_prim(<span style="color: #e6db74;">"jo-unread"</span>, p_jo_unread);
  plus_prim(<span style="color: #e6db74;">"jo-apply"</span>,  p_jo_apply);
  plus_prim(<span style="color: #e6db74;">"jo-&gt;int"</span>,   p_jo_to_int);
  plus_prim(<span style="color: #e6db74;">"jo-&gt;byte"</span>,  p_jo_to_byte);

  plus_prim(<span style="color: #e6db74;">"int-jo?"</span>,       p_int_jo_p);
  plus_prim(<span style="color: #e6db74;">"local-jo?"</span>,     p_local_jo_p);
  plus_prim(<span style="color: #e6db74;">"set-local-jo?"</span>, p_set_local_jo_p);
  plus_prim(<span style="color: #e6db74;">"field-jo?"</span>,     p_field_jo_p);
  plus_prim(<span style="color: #e6db74;">"set-field-jo?"</span>, p_set_field_jo_p);
  plus_prim(<span style="color: #e6db74;">"tag-jo?"</span>,       p_tag_jo_p);

  plus_prim(<span style="color: #e6db74;">"underscore-jo?"</span>,       p_underscore_jo_p);

  plus_prim(<span style="color: #e6db74;">"dynamic-local-jo?"</span>,    p_dynamic_local_jo_p);
  plus_prim(<span style="color: #e6db74;">"set-dynamic-local-jo?"</span>,    p_set_dynamic_local_jo_p);

  plus_prim(<span style="color: #e6db74;">"local-jo-&gt;set-local-jo"</span>, p_get_local_jo_to_set_local_jo);

  plus_prim(<span style="color: #e6db74;">"jo-&gt;string"</span>, p_jo_to_string);

  plus_prim(<span style="color: #e6db74;">"jo-bound?"</span>, p_jo_bound_p);
  plus_prim(<span style="color: #e6db74;">"jo-ref"</span>, p_jo_ref);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2e532f0" class="outline-2">
<h2 id="org2e532f0">&lt;address&gt;</h2>
<div class="outline-text-2" id="text-org2e532f0">
</div><div id="outline-container-orga4ad3cd" class="outline-3">
<h3 id="orga4ad3cd">p_compiling_stack_tos</h3>
<div class="outline-text-3" id="text-orga4ad3cd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_compiling_stack_tos</span>() {
  ds_push(TAG_ADDRESS, tos(compiling_stack));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org11f661f" class="outline-3">
<h3 id="org11f661f">p_compiling_stack_drop</h3>
<div class="outline-text-3" id="text-org11f661f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_compiling_stack_drop</span>() {
  drop(compiling_stack);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org18393bb" class="outline-3">
<h3 id="org18393bb">p_compiling_stack_push</h3>
<div class="outline-text-3" id="text-org18393bb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_compiling_stack_push</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  push(compiling_stack, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org17736b1" class="outline-3">
<h3 id="org17736b1">p_set_offset_to_here</h3>
<div class="outline-text-3" id="text-org17736b1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_offset_to_here</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">address</span> = a.d;
  address[0] = (<span style="color: #66d9ef; font-weight: bold;">cell</span>*)tos(compiling_stack) - address;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org63385d8" class="outline-3">
<h3 id="org63385d8">p_tag_change</h3>
<div class="outline-text-3" id="text-org63385d8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_tag_change</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  ds_push(a.d, b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb74c8d1" class="outline-3">
<h3 id="orgb74c8d1">p_allocate</h3>
<div class="outline-text-3" id="text-orgb74c8d1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_allocate</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_ADDRESS, calloc(a.d, 1));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org521e6b0" class="outline-3">
<h3 id="org521e6b0">p_free</h3>
<div class="outline-text-3" id="text-org521e6b0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_free</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  free(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea2295b" class="outline-3">
<h3 id="orgea2295b">p_set_cell</h3>
<div class="outline-text-3" id="text-orgea2295b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_cell</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">cell address -&gt;</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">address</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">value</span> = b.d;
  address[0] = value;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org19599dd" class="outline-3">
<h3 id="org19599dd">p_get_cell</h3>
<div class="outline-text-3" id="text-org19599dd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_get_cell</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">address -&gt; cell</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">address</span> = a.d;
  ds_push(TAG_INT, address[0]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddfd9d7" class="outline-3">
<h3 id="orgddfd9d7">p_set_byte</h3>
<div class="outline-text-3" id="text-orgddfd9d7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_set_byte</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">byte address -&gt;</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">address</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span> <span style="color: #fd971f;">value</span> = b.d;
  address[0] = value;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org11eb1fb" class="outline-3">
<h3 id="org11eb1fb">p_get_byte</h3>
<div class="outline-text-3" id="text-org11eb1fb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_get_byte</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">address -&gt; byte</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">address</span> = a.d;
  ds_push(TAG_BYTE, address[0]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org30e67f6" class="outline-3">
<h3 id="org30e67f6">expose_address</h3>
<div class="outline-text-3" id="text-org30e67f6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_address</span>() {
  plus_prim(<span style="color: #e6db74;">"compiling-stack-tos"</span>, p_compiling_stack_tos);
  plus_prim(<span style="color: #e6db74;">"compiling-stack-drop"</span>, p_compiling_stack_drop);
  plus_prim(<span style="color: #e6db74;">"compiling-stack-push"</span>, p_compiling_stack_push);

  plus_prim(<span style="color: #e6db74;">"set-offset-to-here"</span>, p_set_offset_to_here);

  plus_prim(<span style="color: #e6db74;">"tag-change"</span>, p_tag_change);

  plus_prim(<span style="color: #e6db74;">"allocate"</span>, p_allocate);
  plus_prim(<span style="color: #e6db74;">"free"</span>, p_free);

  plus_prim(<span style="color: #e6db74;">"set-cell"</span>, p_set_cell);
  plus_prim(<span style="color: #e6db74;">"get-cell"</span>, p_get_cell);
  plus_prim(<span style="color: #e6db74;">"set-byte"</span>, p_set_byte);
  plus_prim(<span style="color: #e6db74;">"get-byte"</span>, p_get_byte);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org72906ca" class="outline-2">
<h2 id="org72906ca">&lt;array&gt;</h2>
<div class="outline-text-2" id="text-org72906ca">
</div><div id="outline-container-orgc65ca4f" class="outline-3">
<h3 id="orgc65ca4f">new_array_gp</h3>
<div class="outline-text-3" id="text-orgc65ca4f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #a6e22e;">new_array_gp</span>(<span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span>) {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = TAG_ARRAY-&gt;data;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = new_record_gp();
  gp-&gt;class = class;
  gp-&gt;p = array;
  <span style="color: #f92672; font-weight: bold;">return</span> gp;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org122318a" class="outline-3">
<h3 id="org122318a">p_new_array</h3>
<div class="outline-text-3" id="text-org122318a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_new_array</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span> = malloc((<span style="color: #66d9ef; font-weight: bold;">len</span>*2 + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  bzero(array, (<span style="color: #66d9ef; font-weight: bold;">len</span>*2 + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  array[0] = len;

  ds_push(TAG_ARRAY, new_array_gp(array));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga648d86" class="outline-3">
<h3 id="orga648d86">p_array_length</h3>
<div class="outline-text-3" id="text-orga648d86">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_array_length</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span> = gp-&gt;p;
  ds_push(TAG_INT, array[0]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfee2d19" class="outline-3">
<h3 id="orgfee2d19">p_array_ref</h3>
<div class="outline-text-3" id="text-orgfee2d19">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_array_ref</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">bp</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span> = bp-&gt;p;
  <span style="color: #f92672; font-weight: bold;">if</span> (i &gt;= array[0]) {
    report(<span style="color: #e6db74;">"- p_array_ref fail\n"</span>);
    report(<span style="color: #e6db74;">"  array is not long enough for the index\n"</span>);
    report(<span style="color: #e6db74;">"  index : %ld\n"</span>, i);
    report(<span style="color: #e6db74;">"  array length : %ld\n"</span>, array[0]);
    p_debug();
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (array[i*2 +1] == 0) {
    report(<span style="color: #e6db74;">"- p_array_ref fail\n"</span>);
    report(<span style="color: #e6db74;">"  the index entry of array is not initialized\n"</span>);
    report(<span style="color: #e6db74;">"  index : %ld\n"</span>, i);
    p_debug();
  }
  ds_push(array[i*2 +1], array[i*2+1 +1]);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf34c0f6" class="outline-3">
<h3 id="orgf34c0f6">p_array_set</h3>
<div class="outline-text-3" id="text-orgf34c0f6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_array_set</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">v</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">bp</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span> = bp-&gt;p;
  <span style="color: #f92672; font-weight: bold;">if</span> (i &gt;= array[0]) {
    report(<span style="color: #e6db74;">"- p_array_set fail\n"</span>);
    report(<span style="color: #e6db74;">"  array is not long enough for the index\n"</span>);
    report(<span style="color: #e6db74;">"  index : %ld\n"</span>, i);
    report(<span style="color: #e6db74;">"  array length : %ld\n"</span>, array[0]);
    report(<span style="color: #e6db74;">"  value to set : %s %ld\n"</span>, jo2str(v.t), v.d);
    p_debug();
  }
  array[i*2+1]    = v.t;
  array[i*2+1 +1] = v.d;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd2d77e7" class="outline-3">
<h3 id="orgd2d77e7">p_mark</h3>
<div class="outline-text-3" id="text-orgd2d77e7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_mark</span>() {
  ds_push(TAG_MARK, 0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org19bfe85" class="outline-3">
<h3 id="org19bfe85">collect_find_length</h3>
<div class="outline-text-3" id="text-org19bfe85">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #a6e22e;">collect_find_length</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (ds_peek_tag(len+1) != TAG_MARK) {
    len++;
  }
  <span style="color: #f92672; font-weight: bold;">return</span> len;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e4a98d" class="outline-3">
<h3 id="org6e4a98d">p_collect</h3>
<div class="outline-text-3" id="text-org6e4a98d">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_collect</span>() {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">len</span> = collect_find_length();
  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">array</span> = malloc((<span style="color: #66d9ef; font-weight: bold;">len</span>*2 + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  bzero(array, (<span style="color: #66d9ef; font-weight: bold;">len</span>*2 + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(cell));
  array[0] = len;

  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">counter</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (counter &lt; len) {
    <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = (len -1) - counter;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">v</span> = ds_pop();
    array[i*2+1]    = v.t;
    array[i*2+1 +1] = v.d;
    counter++;
  }
  ds_drop();

  ds_push(TAG_ARRAY, new_array_gp(array));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9564b75" class="outline-3">
<h3 id="org9564b75">expose_array</h3>
<div class="outline-text-3" id="text-org9564b75">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_array</span>() {
  plus_prim(<span style="color: #e6db74;">"new-array"</span>, p_new_array);
  plus_prim(<span style="color: #e6db74;">"array-length"</span>, p_array_length);
  plus_prim(<span style="color: #e6db74;">"array-ref"</span>, p_array_ref);
  plus_prim(<span style="color: #e6db74;">"array-set"</span>, p_array_set);

  plus_atom(<span style="color: #e6db74;">"&lt;mark&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"mark"</span>, p_mark);
  plus_prim(<span style="color: #e6db74;">"collect"</span>, p_collect);

  plus_atom(<span style="color: #e6db74;">"&lt;array&gt;"</span>, gc_free);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5dbe836" class="outline-2">
<h2 id="org5dbe836">&lt;closure&gt;</h2>
<div class="outline-text-2" id="text-org5dbe836">
</div><div id="outline-container-orgc158cc7" class="outline-3">
<h3 id="orgc158cc7">gc_local_env</h3>
<div class="outline-text-3" id="text-orgc158cc7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">gc_local_env</span>(<span style="color: #66d9ef; font-weight: bold;">gc_state_t</span> <span style="color: #fd971f;">gc_state</span>, <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span>) {
  <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_MARKING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_red("- gc_local_env : GC_STATE_MARKING\n");</span>
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">sleep(1);</span>
    <span style="color: #f92672; font-weight: bold;">if</span> (gp-&gt;mark == GC_MARK_USING) { <span style="color: #f92672; font-weight: bold;">return</span>; }
    gp-&gt;mark = GC_MARK_USING;
    <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = gp-&gt;p;
    <span style="color: #f92672; font-weight: bold;">while</span> (lr-&gt;name != 0) {
        mark_one_data(lr-&gt;local_tag, lr-&gt;local_data);
      lr++;
    }
  }
  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (gc_state == GC_STATE_SWEEPING) {
    <span style="color: #FF8888;">// </span><span style="color: #FF8888;">report_in_green("- gc_local_env : GC_STATE_SWEEPING\n");</span>
    free(gp-&gt;p);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9bfd202" class="outline-3">
<h3 id="org9bfd202">current_local_record</h3>
<div class="outline-text-3" id="text-org9bfd202">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #a6e22e;">current_local_record</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">rp</span> <span style="color: #fd971f;">p</span> = rs_tos();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">length</span> = current_local_counter - p.l;
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = malloc((length + 1) * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>));
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; length) {
    lr[i].name       = local_record[p.l + i].name;
    lr[i].local_tag  = local_record[p.l + i].local_tag;
    lr[i].local_data = local_record[p.l + i].local_data;
    i++;
  }
  lr[i].name = 0;
  <span style="color: #f92672; font-weight: bold;">return</span> lr;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org627b5dd" class="outline-3">
<h3 id="org627b5dd">p_current_local_env</h3>
<div class="outline-text-3" id="text-org627b5dd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_current_local_env</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = current_local_record();

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = TAG_LOCAL_ENV-&gt;data;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">gp</span> = new_record_gp();
  gp-&gt;class = class;
  gp-&gt;p = lr;

  ds_push(TAG_LOCAL_ENV, gp);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfdfa26a" class="outline-3">
<h3 id="orgfdfa26a">set_local_record</h3>
<div class="outline-text-3" id="text-orgfdfa26a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">set_local_record</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span>) {
  <span style="color: #f92672; font-weight: bold;">while</span> (lr-&gt;name != 0) {
    set_local(lr-&gt;name, lr-&gt;local_tag, lr-&gt;local_data);
    lr++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a06e96" class="outline-3">
<h3 id="org4a06e96">p_closure_exe</h3>
<div class="outline-text-3" id="text-org4a06e96">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_closure_exe</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">closure</span> = c.d;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = get_field(TAG_CLOSURE, closure,
                          str2jo(<span style="color: #e6db74;">".local-env"</span>));
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">local</span>* <span style="color: #fd971f;">lr</span> = ap-&gt;p;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = get_field(TAG_CLOSURE, closure,
                          str2jo(<span style="color: #e6db74;">".jojo"</span>));
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">jojo_gp</span> = b.d;
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = jojo_gp-&gt;p;

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">save current_local_counter</span>
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">local_counter</span> = current_local_counter;

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">with side effect on current_local_counter</span>
  set_local_record(lr);

  rs_push(jojo,
          TAG_CLOSURE,
          closure,
          local_counter,
          current_dynamic_local_counter);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf62c099" class="outline-3">
<h3 id="orgf62c099">k_closure</h3>
<div class="outline-text-3" id="text-orgf62c099">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">k_closure</span>() {
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = compile_jojo_until_ket(FLOWER_KET);
  emit(JO_INS_LIT);
  emit(TAG_JOJO);
  emit(new_jojo_gp(jojo));
  emit(JO_CURRENT_LOCAL_ENV);
  emit(JO_CLOSURE);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd3795a" class="outline-3">
<h3 id="orgfd3795a">expose_closure</h3>
<div class="outline-text-3" id="text-orgfd3795a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_closure</span>() {
  plus_prim(<span style="color: #e6db74;">"current-local-env"</span>, p_current_local_env);

  plus_atom(<span style="color: #e6db74;">"&lt;local-env&gt;"</span>, gc_local_env);

  plus_data(<span style="color: #e6db74;">"&lt;closure&gt;"</span>, J(<span style="color: #e6db74;">".jojo"</span>, <span style="color: #e6db74;">".local-env"</span>));
  plus_prim(<span style="color: #e6db74;">"closure-exe"</span>, p_closure_exe);
  plus_disp(<span style="color: #e6db74;">"exe"</span>, J(<span style="color: #e6db74;">"&lt;closure&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_closure_exe);

  plus_gene(<span style="color: #e6db74;">"apply"</span>, 1);
  plus_disp(<span style="color: #e6db74;">"apply"</span>, J(<span style="color: #e6db74;">"&lt;closure&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_closure_exe);
  plus_disp(<span style="color: #e6db74;">"apply"</span>, J(<span style="color: #e6db74;">"&lt;jojo&gt;"</span>), <span style="color: #e6db74;">"&lt;prim&gt;"</span>, p_jojo_exe);
  plus_prim(<span style="color: #e6db74;">"jojo-apply"</span>, p_jojo_exe);
  plus_prim(<span style="color: #e6db74;">"closure-apply"</span>, p_closure_exe);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5bbd4c8" class="outline-2">
<h2 id="org5bbd4c8">&lt;file&gt;</h2>
<div class="outline-text-2" id="text-org5bbd4c8">
</div><div id="outline-container-orgba2f65c" class="outline-3">
<h3 id="orgba2f65c">p_error_number_print</h3>
<div class="outline-text-3" id="text-orgba2f65c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_error_number_print</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">errno -&gt; {terminal-output}</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">no</span> = a.d;
  report(<span style="color: #e6db74;">"%s"</span>, strerror(no));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org57184eb" class="outline-3">
<h3 id="org57184eb">path_open</h3>
<div class="outline-text-3" id="text-org57184eb">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">path_open</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">flag</span>) {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[path] -&gt; [file true] or [errno false]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">path</span> = ap-&gt;p;

  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = open(path, flag);
  <span style="color: #f92672; font-weight: bold;">if</span> (fd == -1) {
    ds_push(TAG_INT, errno);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_FILE, fd);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff206b2" class="outline-3">
<h3 id="orgff206b2">p_path_open_read</h3>
<div class="outline-text-3" id="text-orgff206b2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_path_open_read</span>() {
  path_open(O_RDONLY);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea84068" class="outline-3">
<h3 id="orgea84068">p_path_open_write</h3>
<div class="outline-text-3" id="text-orgea84068">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_path_open_write</span>() {
  path_open(O_WRONLY);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org918bcdd" class="outline-3">
<h3 id="org918bcdd">p_path_open_read_and_write</h3>
<div class="outline-text-3" id="text-org918bcdd">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_path_open_read_and_write</span>() {
  path_open(O_RDWR);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3ada7" class="outline-3">
<h3 id="orgb3ada7">p_path_open_create</h3>
<div class="outline-text-3" id="text-orgb3ada7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_path_open_create</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[path] -&gt; [file true] or [errno false]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">path</span> = ap-&gt;p;

  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = open(path, O_CREAT | O_RDWR);
  <span style="color: #f92672; font-weight: bold;">if</span> (fd == -1) {
    ds_push(TAG_INT, errno);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_FILE, fd);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org582db41" class="outline-3">
<h3 id="org582db41">p_file_close</h3>
<div class="outline-text-3" id="text-org582db41">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_file_close</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[:fd] -&gt; []</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">error reasons :</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">1. to close an unopened file descriptor</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">2. close the same file descriptor twice</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">3. error conditions for specific file system</span>
  <span style="color: #FF8888;">//    </span><span style="color: #FF8888;">to diagnose during a close operation</span>
  <span style="color: #FF8888;">//    </span><span style="color: #FF8888;">- for example, NFS (Network File System)</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">if</span> (close(fd) == -1) {
    report(<span style="color: #e6db74;">"- p_close fail\n"</span>);
    perror(<span style="color: #e6db74;">"  close error : "</span>);
  };
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org572282a" class="outline-3">
<h3 id="org572282a">p_file_read</h3>
<div class="outline-text-3" id="text-org572282a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_file_read</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[requested-bytes buffer file] -&gt;</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[real-bytes true] or [errno false]</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">partial read reasons :</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">1. [regular-file] end-of-file is reached</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">2. [terminal] meets '\n'</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">void</span>* <span style="color: #fd971f;">buffer</span> = b.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">size_t</span> <span style="color: #fd971f;">want_bytes</span> = c.d;

  <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = read(fd, buffer, want_bytes);
  <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == -1) {
    ds_push(TAG_INT, errno);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BYTE, real_bytes);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org51a21ad" class="outline-3">
<h3 id="org51a21ad">p_file_write</h3>
<div class="outline-text-3" id="text-org51a21ad">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_file_write</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[want-bytes buffer file] -&gt;</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[real-bytes true] or [errno false]</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">- partial write reasons</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">1. disk was filled</span>
  <span style="color: #FF8888;">//   </span><span style="color: #FF8888;">2. the process resource limit on file sizes was reached</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">void</span>* <span style="color: #fd971f;">buffer</span> = b.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">size_t</span> <span style="color: #fd971f;">want_bytes</span> = c.d;

  <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = write(fd, buffer, want_bytes);
  <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == -1) {
    ds_push(TAG_INT, errno);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_BYTE, real_bytes);
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga2da8b5" class="outline-3">
<h3 id="orga2da8b5">p_file_input_stack</h3>
<div class="outline-text-3" id="text-orga2da8b5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_file_input_stack</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">fd</span> = a.d;
  ds_push(TAG_INPUT_STACK, file_input_stack(fd));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org70d3c82" class="outline-3">
<h3 id="org70d3c82">current_reading_dir</h3>
<div class="outline-text-3" id="text-org70d3c82">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">erase_real_path_to_dir</span>(<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">path</span>) {
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cursor</span> = strlen(path);
  <span style="color: #f92672; font-weight: bold;">while</span> (path[cursor] != <span style="color: #f8f8f0; background-color: #1b1d1e;">'/</span><span style="color: #d33682; font-weight: bold;">'</span>) {
    path[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
    cursor--;
  }
  path[cursor] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
}

<span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">current_reading_dir</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">input_stack</span>* <span style="color: #fd971f;">current_input_stack</span> = tos(reading_stack);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">real_path</span> = malloc(PATH_MAX);

  <span style="color: #f92672; font-weight: bold;">if</span> (current_input_stack-&gt;type == INPUT_STACK_TERMINAL ||
      current_input_stack-&gt;type == INPUT_STACK_STRING) {
    realpath(<span style="color: #e6db74;">"./"</span>, real_path);
    strcat(real_path, <span style="color: #e6db74;">"/"</span>);
    <span style="color: #f92672; font-weight: bold;">return</span> real_path;
  }

  <span style="color: #f92672; font-weight: bold;">else</span> <span style="color: #f92672; font-weight: bold;">if</span> (current_input_stack-&gt;type == INPUT_STACK_REGULAR_FILE) {
    <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">proc_link_path</span> = malloc(PATH_MAX);
    sprintf(proc_link_path, <span style="color: #e6db74;">"/proc/self/fd/%d"</span>,
            current_input_stack-&gt;file);
    <span style="color: #66d9ef; font-weight: bold;">ssize_t</span> <span style="color: #fd971f;">real_bytes</span> = readlink(proc_link_path,
                                  real_path, PATH_MAX);
    <span style="color: #f92672; font-weight: bold;">if</span> (real_bytes == -1) {
      report(<span style="color: #e6db74;">"- current_reading_dir fail to readlink\n"</span>);
      report(<span style="color: #e6db74;">"  proc_link_path : %s\n"</span>, proc_link_path);
      perror(<span style="color: #e6db74;">"  readlink "</span>);
      free(proc_link_path);
      free(real_path);
      p_debug();
    }
    free(proc_link_path);
    real_path[real_bytes] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
    erase_real_path_to_dir(real_path);
    strcat(real_path, <span style="color: #e6db74;">"/"</span>);
    <span style="color: #f92672; font-weight: bold;">return</span> real_path;
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    report(<span style="color: #e6db74;">"- current_reading_dir fail\n"</span>);
    report(<span style="color: #e6db74;">"  unknown current_input_stack type\n"</span>);
    free(real_path);
    p_debug();
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6732990" class="outline-3">
<h3 id="org6732990">p_current_reading_dir</h3>
<div class="outline-text-3" id="text-org6732990">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_current_reading_dir</span>() {
  ds_push(TAG_STRING, new_string_gp(current_reading_dir()));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf7f67a" class="outline-3">
<h3 id="orgdf7f67a">current_running_dir</h3>
<div class="outline-text-3" id="text-orgdf7f67a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #FF8888;">// </span><span style="color: #FF8888;">caller free</span>
<span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #a6e22e;">current_running_dir</span>() {
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">real_path</span> = malloc(PATH_MAX);
  realpath(<span style="color: #e6db74;">"./"</span>, real_path);
  strcat(real_path, <span style="color: #e6db74;">"/"</span>);
  <span style="color: #f92672; font-weight: bold;">return</span> real_path;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5f895fe" class="outline-3">
<h3 id="org5f895fe">p_current_running_dir</h3>
<div class="outline-text-3" id="text-org5f895fe">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_current_running_dir</span>() {
  ds_push(TAG_STRING, new_string_gp(current_running_dir()));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd94f618" class="outline-3">
<h3 id="orgd94f618">expose_file</h3>
<div class="outline-text-3" id="text-orgd94f618">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_file</span>() {
  plus_atom(<span style="color: #e6db74;">"&lt;file&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"error-number-print"</span>, p_error_number_print);

  plus_prim(<span style="color: #e6db74;">"path-open-read"</span>, p_path_open_read);
  plus_prim(<span style="color: #e6db74;">"path-open-write"</span>, p_path_open_write);
  plus_prim(<span style="color: #e6db74;">"path-open-read-and-write"</span>, p_path_open_read_and_write);
  plus_prim(<span style="color: #e6db74;">"path-open-create"</span>, p_path_open_create);
  plus_prim(<span style="color: #e6db74;">"file-close"</span>, p_file_close);
  plus_prim(<span style="color: #e6db74;">"file-read"</span>, p_file_read);
  plus_prim(<span style="color: #e6db74;">"file-write"</span>, p_file_write);

  plus_prim(<span style="color: #e6db74;">"file-input-stack"</span>, p_file_input_stack);

  plus_prim(<span style="color: #e6db74;">"current-reading-dir"</span>, p_current_reading_dir);
  plus_prim(<span style="color: #e6db74;">"current-running-dir"</span>, p_current_running_dir);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org22b34e6" class="outline-2">
<h2 id="org22b34e6"><b>system</b></h2>
<div class="outline-text-2" id="text-org22b34e6">
</div><div id="outline-container-orgdb26bae" class="outline-3">
<h3 id="orgdb26bae">p_cmd_number</h3>
<div class="outline-text-3" id="text-orgdb26bae">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">cmd_number</span>;

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_cmd_number</span>() {
  ds_push(TAG_INT, cmd_number);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org687ed95" class="outline-3">
<h3 id="org687ed95">p_index_to_cmd_string</h3>
<div class="outline-text-3" id="text-org687ed95">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">char</span>** <span style="color: #fd971f;">cmd_string_array</span>;

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_index_to_cmd_string</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">index -&gt; string</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">index</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">cmd_string</span> = cmd_string_array[index];

  ds_push(TAG_STRING, new_string_gp(strdup(cmd_string)));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e312e4" class="outline-3">
<h3 id="org9e312e4">p_find_env_string</h3>
<div class="outline-text-3" id="text-org9e312e4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_find_env_string</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">string -&gt; [env-string true] or [false]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">arg_string</span> = ap-&gt;p;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">env_string</span> = getenv(arg_string);
  <span style="color: #f92672; font-weight: bold;">if</span> (env_string == 0) {
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">false</span>);
  }
  <span style="color: #f92672; font-weight: bold;">else</span> {
    ds_push(TAG_STRING, new_string_gp(strdup(env_string)));
    ds_push(TAG_BOOL, <span style="color: #ae81ff;">true</span>);
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6679f84" class="outline-3">
<h3 id="org6679f84">expose_system</h3>
<div class="outline-text-3" id="text-org6679f84">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_system</span>() {
  plus_prim(<span style="color: #e6db74;">"cmd-number"</span>, p_cmd_number);
  plus_prim(<span style="color: #e6db74;">"index-&gt;cmd-string"</span>, p_index_to_cmd_string);
  plus_prim(<span style="color: #e6db74;">"find-env-string"</span>, p_find_env_string);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org97badbf" class="outline-2">
<h2 id="org97badbf"><b>lib</b></h2>
<div class="outline-text-2" id="text-org97badbf">
</div><div id="outline-container-org3eba553" class="outline-3">
<h3 id="org3eba553">TAG_LIB</h3>
<div class="outline-text-3" id="text-org3eba553">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">TAG_LIB</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce4dd17" class="outline-3">
<h3 id="orgce4dd17">p_lib_open</h3>
<div class="outline-text-3" id="text-orgce4dd17">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_lib_open</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[&lt;string&gt;] -&gt; [&lt;lib&gt;]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">lib_name</span> = ap-&gt;p;

  <span style="color: #66d9ef; font-weight: bold;">void</span>* <span style="color: #fd971f;">lib</span> = dlopen(lib_name, RTLD_NOW);
  <span style="color: #f92672; font-weight: bold;">if</span> (lib == 0) {
    report(<span style="color: #e6db74;">"- p_lib_open fail to open library\n"</span>);
    report(<span style="color: #e6db74;">"  lib_name : %s\n"</span>, lib_name);
    report(<span style="color: #e6db74;">"  dynamic loader error : %s\n"</span>, dlerror());
    p_debug();
  }

  ds_push(TAG_LIB, lib);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3260f6a" class="outline-3">
<h3 id="org3260f6a">p_lib_call</h3>
<div class="outline-text-3" id="text-org3260f6a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_lib_call</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[&lt;lib&gt; &lt;string&gt;] -&gt; [*]</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">function_name</span> = ap-&gt;p;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">void</span>* <span style="color: #fd971f;">lib</span> = b.d;

  <span style="color: #66d9ef; font-weight: bold;">primitive_t</span> <span style="color: #fd971f;">fun</span> = dlsym(lib, function_name);
  <span style="color: #f92672; font-weight: bold;">if</span> (fun == 0) {
    report(<span style="color: #e6db74;">"- p_lib_call fail\n"</span>);
    report(<span style="color: #e6db74;">"  function_name : %s\n"</span>, function_name);
    report(<span style="color: #e6db74;">"  dynamic loader error : %s\n"</span>, dlerror());
  };

  fun();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd458307" class="outline-3">
<h3 id="orgd458307">p_lib_set_cell</h3>
<div class="outline-text-3" id="text-orgd458307">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_lib_set_cell</span>() {
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">[&lt;lib&gt; &lt;string&gt;] -&gt; []</span>
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">gp</span>* <span style="color: #fd971f;">ap</span> = a.d;
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">cell_name</span> = ap-&gt;p;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">void</span>* <span style="color: #fd971f;">lib</span> = b.d;

  <span style="color: #66d9ef; font-weight: bold;">cell</span>* <span style="color: #fd971f;">cell</span> = dlsym(lib, cell_name);
  <span style="color: #f92672; font-weight: bold;">if</span> (cell == 0) {
    report(<span style="color: #e6db74;">"- p_lib_set_cell fail\n"</span>);
    report(<span style="color: #e6db74;">"  cell_name : %s\n"</span>, cell_name);
    report(<span style="color: #e6db74;">"  dynamic loader error : %s\n"</span>, dlerror());
  };

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  cell[0] = c.d;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc59ab9f" class="outline-3">
<h3 id="orgc59ab9f">expose_lib</h3>
<div class="outline-text-3" id="text-orgc59ab9f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_lib</span>() {
  TAG_LIB = str2jo(<span style="color: #e6db74;">"&lt;lib&gt;"</span>);

  plus_atom(<span style="color: #e6db74;">"&lt;lib&gt;"</span>, gc_ignore);

  plus_prim(<span style="color: #e6db74;">"lib-open"</span>, p_lib_open);
  plus_prim(<span style="color: #e6db74;">"lib-call"</span>, p_lib_call);
  plus_prim(<span style="color: #e6db74;">"lib-set-cell"</span>, p_lib_set_cell);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org93de330" class="outline-2">
<h2 id="org93de330"><b>core</b></h2>
<div class="outline-text-2" id="text-org93de330">
</div><div id="outline-container-org913bbb0" class="outline-3">
<h3 id="org913bbb0">core_flag</h3>
<div class="outline-text-3" id="text-org913bbb0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_core_flag</span>() { ds_push(TAG_BOOL, core_flag); }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_core_flag_on</span>() { core_flag = <span style="color: #ae81ff;">true</span>; }
<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_core_flag_off</span>() { core_flag = <span style="color: #ae81ff;">false</span>; }
</pre>
</div>
</div>
</div>

<div id="outline-container-orge29375f" class="outline-3">
<h3 id="orge29375f">load_core</h3>
<div class="outline-text-3" id="text-orge29375f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">load_core</span>() {
<span style="color: #a6e22e;">  #include</span> <span style="color: #e6db74;">"core.h"</span>
  core_jo[core_jo_len - 1] = <span style="color: #f8f8f0; background-color: #1b1d1e;">'\0</span><span style="color: #d33682; font-weight: bold;">'</span>;
  repl(string_input_stack((<span style="color: #66d9ef; font-weight: bold;">char</span>*)core_jo));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6fd36f" class="outline-3">
<h3 id="orgd6fd36f">p_name_bind</h3>
<div class="outline-text-3" id="text-orgd6fd36f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  bind_name(b.d, a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org67f2801" class="outline-3">
<h3 id="org67f2801">p_name_rebind</h3>
<div class="outline-text-3" id="text-org67f2801">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_rebind</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  rebind_name(b.d, a.t, a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb64163" class="outline-3">
<h3 id="orgfb64163">p_jo_emit</h3>
<div class="outline-text-3" id="text-orgfb64163">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  emit(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org69ace4a" class="outline-3">
<h3 id="org69ace4a">p_emit_lit</h3>
<div class="outline-text-3" id="text-org69ace4a">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_emit_lit</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  emit(JO_INS_LIT);
  emit(a.t);
  emit(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org292992b" class="outline-3">
<h3 id="org292992b">p_emit_zero</h3>
<div class="outline-text-3" id="text-org292992b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_emit_zero</span>() {
  emit(0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga703a26" class="outline-3">
<h3 id="orga703a26">p_jo_emit_local</h3>
<div class="outline-text-3" id="text-orga703a26">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  emit(JO_INS_LOCAL);
  emit(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga500774" class="outline-3">
<h3 id="orga500774">p_jo_emit_set_local</h3>
<div class="outline-text-3" id="text-orga500774">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_set_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(a.d);
  emit(JO_INS_SET_LOCAL);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(str, 0, strlen(str) -1);
  emit(str2jo(tmp));
  free(tmp);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgebdc3dc" class="outline-3">
<h3 id="orgebdc3dc">p_jo_emit_dynamic_local</h3>
<div class="outline-text-3" id="text-orgebdc3dc">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_dynamic_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  emit(JO_INS_DYNAMIC_LOCAL);
  emit(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org441d468" class="outline-3">
<h3 id="org441d468">p_jo_emit_set_dynamic_local</h3>
<div class="outline-text-3" id="text-org441d468">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_set_dynamic_local</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(a.d);
  emit(JO_INS_SET_DYNAMIC_LOCAL);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(str, 0, strlen(str) -1);
  emit(str2jo(tmp));
  free(tmp);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org9bfb0a1" class="outline-3">
<h3 id="org9bfb0a1">p_jo_emit_field</h3>
<div class="outline-text-3" id="text-org9bfb0a1">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_field</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  emit(JO_INS_FIELD);
  emit(a.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1933416" class="outline-3">
<h3 id="org1933416">p_jo_emit_set_field</h3>
<div class="outline-text-3" id="text-org1933416">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_jo_emit_set_field</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">str</span> = jo2str(a.d);
  <span style="color: #66d9ef; font-weight: bold;">char</span>* <span style="color: #fd971f;">tmp</span> = substring(str, 0, strlen(str) -1);
  emit(JO_INS_SET_FIELD);
  emit(str2jo(tmp));
  free(tmp);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8371b98" class="outline-3">
<h3 id="org8371b98">p_emit_jz</h3>
<div class="outline-text-3" id="text-org8371b98">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_emit_jz</span>() {
  emit(JO_INS_JZ);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">address</span> = tos(compiling_stack);
  p_compiling_stack_inc();
  ds_push(TAG_ADDRESS, address);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org31676c" class="outline-3">
<h3 id="org31676c">p_emit_jmp</h3>
<div class="outline-text-3" id="text-org31676c">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_emit_jmp</span>() {
  emit(JO_INS_JMP);
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">address</span> = tos(compiling_stack);
  p_compiling_stack_inc();
  ds_push(TAG_ADDRESS, address);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf2ccfb6" class="outline-3">
<h3 id="orgf2ccfb6">p_name_bind_data</h3>
<div class="outline-text-3" id="text-orgf2ccfb6">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind_data</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  plus_data(jo2str(name), b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd68094" class="outline-3">
<h3 id="orgdd68094">p_name_bind_gene</h3>
<div class="outline-text-3" id="text-orgdd68094">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind_gene</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  plus_gene(jo2str(name), b.d);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7e23312" class="outline-3">
<h3 id="org7e23312">p_name_bind_disp_to_jojo</h3>
<div class="outline-text-3" id="text-org7e23312">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind_disp_to_jojo</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">tags</span> = b.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = c.d;
  plus_disp(jo2str(name), tags, <span style="color: #e6db74;">"&lt;jojo&gt;"</span>, jojo);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6a570f" class="outline-3">
<h3 id="orgc6a570f">p_name_bind_disp_defalut_to_jojo</h3>
<div class="outline-text-3" id="text-orgc6a570f">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind_disp_defalut_to_jojo</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">c</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span>* <span style="color: #fd971f;">jojo</span> = c.d;
  plus_disp_default(jo2str(name), <span style="color: #e6db74;">"&lt;jojo&gt;"</span>, jojo);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb08ee32" class="outline-3">
<h3 id="orgb08ee32">p_name_bind_atom</h3>
<div class="outline-text-3" id="text-orgb08ee32">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_bind_atom</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;

  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">b</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">gc_actor_t</span> <span style="color: #fd971f;">gc_actor</span> = b.d;

  plus_atom(jo2str(name), gc_actor);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga0e0489" class="outline-3">
<h3 id="orga0e0489">p_name_get</h3>
<div class="outline-text-3" id="text-orga0e0489">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_name_get</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">name</span> = a.d;
  ds_push(name-&gt;tag, name-&gt;data);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4d22cf" class="outline-3">
<h3 id="orgd4d22cf">p_class_to_tag</h3>
<div class="outline-text-3" id="text-orgd4d22cf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_class_to_tag</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">class</span>* <span style="color: #fd971f;">class</span> = a.d;
  ds_push(TAG_JO, class-&gt;class_name);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org85b60b8" class="outline-3">
<h3 id="org85b60b8">p_cells_copy</h3>
<div class="outline-text-3" id="text-org85b60b8">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p_cells_copy</span>() {
  <span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">dp</span> <span style="color: #fd971f;">a</span> = ds_pop();
  ds_push(TAG_ADDRESS, array_dup(a.d));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1ced0f4" class="outline-3">
<h3 id="org1ced0f4">expose_core</h3>
<div class="outline-text-3" id="text-org1ced0f4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_core</span>() {
  plus_prim(<span style="color: #e6db74;">"core-flag"</span>, p_core_flag);
  plus_prim(<span style="color: #e6db74;">"core-flag-on"</span>, p_core_flag_on);
  plus_prim(<span style="color: #e6db74;">"core-flag-off"</span>, p_core_flag_off);

  plus_prim(<span style="color: #e6db74;">"name-bind"</span>, p_name_bind);
  plus_prim(<span style="color: #e6db74;">"name-rebind"</span>, p_name_rebind);

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">note that, the notation of instruction is not exposed to jojo</span>
  plus_prim(<span style="color: #e6db74;">"jo-emit"</span>, p_jo_emit);
  plus_prim(<span style="color: #e6db74;">"emit-lit"</span>, p_emit_lit);
  plus_prim(<span style="color: #e6db74;">"string-emit"</span>, p_emit_lit);
  plus_prim(<span style="color: #e6db74;">"emit-zero"</span>, p_emit_zero);

  plus_prim(<span style="color: #e6db74;">"jo-emit-local"</span>,     p_jo_emit_local);
  plus_prim(<span style="color: #e6db74;">"jo-emit-set-local"</span>, p_jo_emit_set_local);

  plus_prim(<span style="color: #e6db74;">"jo-emit-dynamic-local"</span>, p_jo_emit_dynamic_local);
  plus_prim(<span style="color: #e6db74;">"jo-emit-set-dynamic-local"</span>, p_jo_emit_set_dynamic_local);

  plus_prim(<span style="color: #e6db74;">"jo-emit-field"</span>,     p_jo_emit_field);
  plus_prim(<span style="color: #e6db74;">"jo-emit-set-field"</span>, p_jo_emit_set_field);

  plus_prim(<span style="color: #e6db74;">"emit-jz"</span>, p_emit_jz);
  plus_prim(<span style="color: #e6db74;">"emit-jmp"</span>, p_emit_jmp);
  plus_prim(<span style="color: #e6db74;">"emit-jojo-end"</span>, emit_jojo_end);

  plus_prim(<span style="color: #e6db74;">"name-bind-data"</span>, p_name_bind_data);
  plus_prim(<span style="color: #e6db74;">"name-bind-gene"</span>, p_name_bind_gene);
  plus_prim(<span style="color: #e6db74;">"name-bind-disp-to-jojo"</span>, p_name_bind_disp_to_jojo);
  plus_prim(<span style="color: #e6db74;">"name-bind-disp-default-to-jojo"</span>, p_name_bind_disp_defalut_to_jojo);

  plus_prim(<span style="color: #e6db74;">"name-bind-atom"</span>, p_name_bind_atom);
  plus_prim(<span style="color: #e6db74;">"name-get"</span>, p_name_get);

  plus_prim(<span style="color: #e6db74;">"class-&gt;tag"</span>, p_class_to_tag);

  plus_prim(<span style="color: #e6db74;">"cells-copy"</span>, p_cells_copy);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4990bab" class="outline-2">
<h2 id="org4990bab"><b>report</b></h2>
<div class="outline-text-2" id="text-org4990bab">
</div><div id="outline-container-orgef00ab2" class="outline-3">
<h3 id="orgef00ab2">report_local_record</h3>
<div class="outline-text-3" id="text-orgef00ab2">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">report_local_record</span>() {
  report(<span style="color: #e6db74;">"- report_local_record\n"</span>);
  <span style="color: #66d9ef; font-weight: bold;">cell</span> <span style="color: #fd971f;">i</span> = 0;
  <span style="color: #f92672; font-weight: bold;">while</span> (i &lt; current_local_counter) {
    report(<span style="color: #e6db74;">"  - name : %s\n"</span>, jo2str(local_record[i].name));
    report(<span style="color: #e6db74;">"    tag : %s\n"</span>, jo2str(local_record[i].local_tag));
    report(<span style="color: #e6db74;">"    data : %ld\n"</span>, local_record[i].local_data);
    i++;
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org27b2fab" class="outline-3">
<h3 id="org27b2fab">expose_report</h3>
<div class="outline-text-3" id="text-org27b2fab">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_report</span>() {
  plus_prim(<span style="color: #e6db74;">"report-local-record"</span>, report_local_record);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org343ad23" class="outline-2">
<h2 id="org343ad23"><b>play</b></h2>
<div class="outline-text-2" id="text-org343ad23">
</div><div id="outline-container-orgf8a7fb7" class="outline-3">
<h3 id="orgf8a7fb7">p1</h3>
<div class="outline-text-3" id="text-orgf8a7fb7">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">p1</span>() {
  report(<span style="color: #e6db74;">"\e[31m Hello World \e[0m\n"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5380f39" class="outline-3">
<h3 id="org5380f39">expose_play</h3>
<div class="outline-text-3" id="text-org5380f39">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">expose_play</span>() {
  plus_prim(<span style="color: #e6db74;">"p1"</span>, p1);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb02a09b" class="outline-2">
<h2 id="orgb02a09b">init &amp; main</h2>
<div class="outline-text-2" id="text-orgb02a09b">
</div><div id="outline-container-orgaa4daf" class="outline-3">
<h3 id="orgaa4daf">init_system</h3>
<div class="outline-text-3" id="text-orgaa4daf">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_system</span>() {
  setvbuf(stdout, 0, _IONBF, 0);
  setvbuf(stderr, 0, _IONBF, 0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org10ec9ef" class="outline-3">
<h3 id="org10ec9ef">init_jotable</h3>
<div class="outline-text-3" id="text-org10ec9ef">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_jotable</span>() {
  bzero(jotable, <span style="color: #66d9ef; font-weight: bold;">JOTABLE_SIZE</span> * <span style="color: #f92672; font-weight: bold;">sizeof</span>(<span style="color: #f92672; font-weight: bold;">struct</span> <span style="color: #66d9ef; font-weight: bold;">jotable_entry</span>));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd86cd77" class="outline-3">
<h3 id="orgd86cd77">init_literal_jo</h3>
<div class="outline-text-3" id="text-orgd86cd77">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_literal_jo</span>() {
  EMPTY_JO = str2jo(<span style="color: #e6db74;">""</span>);

  TAG_PRIM         = str2jo(<span style="color: #e6db74;">"&lt;prim&gt;"</span>);
  TAG_JOJO         = str2jo(<span style="color: #e6db74;">"&lt;jojo&gt;"</span>);
  TAG_CLOSURE      = str2jo(<span style="color: #e6db74;">"&lt;closure&gt;"</span>);
  TAG_ADDRESS      = str2jo(<span style="color: #e6db74;">"&lt;address&gt;"</span>);
  TAG_CLASS        = str2jo(<span style="color: #e6db74;">"&lt;class&gt;"</span>);

  TAG_LOCAL_ENV    = str2jo(<span style="color: #e6db74;">"&lt;local-env&gt;"</span>);


  TAG_BOOL         = str2jo(<span style="color: #e6db74;">"&lt;bool&gt;"</span>);
  TAG_INT          = str2jo(<span style="color: #e6db74;">"&lt;int&gt;"</span>);
  TAG_BYTE         = str2jo(<span style="color: #e6db74;">"&lt;byte&gt;"</span>);
  TAG_STRING       = str2jo(<span style="color: #e6db74;">"&lt;string&gt;"</span>);
  TAG_ARRAY        = str2jo(<span style="color: #e6db74;">"&lt;array&gt;"</span>);
  TAG_JO           = str2jo(<span style="color: #e6db74;">"&lt;jo&gt;"</span>);

  TAG_MARK         = str2jo(<span style="color: #e6db74;">"&lt;mark&gt;"</span>);

  TAG_UNINITIALISED_FIELD_PLACE_HOLDER =
    str2jo(<span style="color: #e6db74;">"&lt;uninitialised-field-place-holder&gt;"</span>);

  TAG_FILE         = str2jo(<span style="color: #e6db74;">"&lt;file&gt;"</span>);
  TAG_INPUT_STACK  = str2jo(<span style="color: #e6db74;">"&lt;input-stack&gt;"</span>);

  TAG_DATA_PREDICATE = str2jo(<span style="color: #e6db74;">"&lt;data-predicate&gt;"</span>);
  TAG_DATA_CONSTRUCTOR = str2jo(<span style="color: #e6db74;">"&lt;data-constructor&gt;"</span>);

  TAG_GENE = str2jo(<span style="color: #e6db74;">"&lt;gene&gt;"</span>);

  ROUND_BAR    =   str2jo(<span style="color: #e6db74;">"("</span>);
  ROUND_KET    =   str2jo(<span style="color: #e6db74;">")"</span>);
  SQUARE_BAR   =   str2jo(<span style="color: #e6db74;">"["</span>);
  SQUARE_KET   =   str2jo(<span style="color: #e6db74;">"]"</span>);
  FLOWER_BAR   =   str2jo(<span style="color: #e6db74;">"{"</span>);
  FLOWER_KET   =   str2jo(<span style="color: #e6db74;">"}"</span>);
  DOUBLEQUOTE  =   str2jo(<span style="color: #e6db74;">"\""</span>);
  SINGLEQUOTE  =   str2jo(<span style="color: #e6db74;">"'"</span>);
  BACKQUOTE    =   str2jo(<span style="color: #e6db74;">"`"</span>);
  COMMA        =   str2jo(<span style="color: #e6db74;">","</span>);

  JO_INS_LIT       = str2jo(<span style="color: #e6db74;">"ins/lit"</span>);

  JO_INS_LOCAL     = str2jo(<span style="color: #e6db74;">"ins/local"</span>);
  JO_INS_SET_LOCAL = str2jo(<span style="color: #e6db74;">"ins/set-local"</span>);

  JO_INS_DYNAMIC_LOCAL = str2jo(<span style="color: #e6db74;">"ins/dynamic-local"</span>);
  JO_INS_SET_DYNAMIC_LOCAL = str2jo(<span style="color: #e6db74;">"ins/set-dynamic-local"</span>);

  JO_INS_FIELD     = str2jo(<span style="color: #e6db74;">"ins/field"</span>);
  JO_INS_SET_FIELD = str2jo(<span style="color: #e6db74;">"ins/set-field"</span>);

  JO_INS_JMP = str2jo(<span style="color: #e6db74;">"ins/jmp"</span>);
  JO_INS_JZ  = str2jo(<span style="color: #e6db74;">"ins/jz"</span>);

  JO_NULL     = str2jo(<span style="color: #e6db74;">"null"</span>);
  JO_THEN     = str2jo(<span style="color: #e6db74;">"then"</span>);
  JO_ELSE     = str2jo(<span style="color: #e6db74;">"else"</span>);

  JO_APPLY     = str2jo(<span style="color: #e6db74;">"apply"</span>);
  JO_EXE       = str2jo(<span style="color: #e6db74;">"exe"</span>);
  JO_END       = str2jo(<span style="color: #e6db74;">"end"</span>);
  JO_RECUR     = str2jo(<span style="color: #e6db74;">"recur"</span>);
  JO_CLOSURE   = str2jo(<span style="color: #e6db74;">"closure"</span>);

  JO_CURRENT_LOCAL_ENV   = str2jo(<span style="color: #e6db74;">"current-local-env"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b13392" class="outline-3">
<h3 id="org6b13392">init_stacks</h3>
<div class="outline-text-3" id="text-org6b13392">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">jo_t</span> <span style="color: #fd971f;">jojo_area</span>[64 * 1024];

<span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_stacks</span>() {
  ds = new_stack(<span style="color: #e6db74;">"ds"</span>);
  rs = new_stack(<span style="color: #e6db74;">"rs"</span>);

  compiling_stack = new_stack(<span style="color: #e6db74;">"compiling_stack"</span>);
  push(compiling_stack, jojo_area);

  reading_stack = new_stack(<span style="color: #e6db74;">"reading_stack"</span>);

  writing_stack = new_stack(<span style="color: #e6db74;">"writing_stack"</span>);
  push(writing_stack, terminal_output_stack());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f417d0" class="outline-3">
<h3 id="org1f417d0">init_expose</h3>
<div class="outline-text-3" id="text-org1f417d0">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">init_expose</span>() {
  expose_gc();
  expose_gene();
  expose_stack();
  expose_ending();
  expose_io();
  expose_local();
  expose_dynamic_local();
  expose_compiler();
  expose_control();
  expose_top();
  expose_repl();
  expose_step();
  expose_bool();
  expose_string();
  expose_int();
  expose_jo();
  expose_address();
  expose_jojo();
  expose_array();
  expose_closure();
  expose_file();
  expose_system();
  expose_lib();
  expose_core();
  expose_report();
  expose_play();
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org321a18b" class="outline-3">
<h3 id="org321a18b">main</h3>
<div class="outline-text-3" id="text-org321a18b">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #a6e22e;">main</span>(<span style="color: #66d9ef; font-weight: bold;">int</span> <span style="color: #fd971f;">argc</span>, <span style="color: #66d9ef; font-weight: bold;">char</span>** <span style="color: #fd971f;">argv</span>) {
  cmd_number = argc;
  cmd_string_array = argv;

  init_system();
  init_jotable();
  init_literal_jo();
  init_stacks();
  init_expose();
  init_kernel_signal_handler();

  load_core();

  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">p_repl_flag_on();</span>
  <span style="color: #FF8888;">// </span><span style="color: #FF8888;">repl(terminal_input_stack());</span>
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: xieyuheng</p>
<p class="date">Created: 2017-09-25 Mon 01:20</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
