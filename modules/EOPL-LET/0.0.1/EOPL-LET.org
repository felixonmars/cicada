#+property: tangle EOPL-LET.jo

* [note]

  #+begin_src jojo
  (note val = <int> | <bool>)
  (note env = <null-env> | <cons-env>)
  (note program = exp)
  (note exp
    = <const-exp>
    | <zero?-exp>
    | <if-exp>
    | <diff-exp>
    | <var-exp>
    | <let-exp>)
  #+end_src

* env

  #+begin_src jojo
  (+data <null-env>)
  (+data <cons-env> .rest .var .val)

  (+jojo env-apply (-> :var :env -- val)
    (case :env
      <null-env> ["- env-apply fail" w nl
                  "  can not find var : " w :var w nl
                  debug]
      <cons-env> (if :env .var :var equal?
                     then :env .val
                     else :var :env .rest recur)))

  (+jojo init-env
    null-env
    ':x 10 cons-env
    ':v 5  cons-env
    ':i 1  cons-env)
  #+end_src

* exp

  #+begin_src jojo
  (+data <const-exp> .num)
  (+data <zero?-exp> .exp1)
  (+data <if-exp>    .exp1 .exp2 .exp3)
  (+data <diff-exp>  .exp1 .exp2)
  (+data <var-exp>   .var)
  (+data <let-exp>   .var .exp1 .body)

  (+jojo program-eval (-> :program -- val)
    :program init-env eval)

  (+jojo eval (-> :exp :env -- val)
    (case :exp
      <const-exp> [:exp .num]
      <zero?-exp> [:exp .exp1 :env recur 0 equal?]
      <if-exp>    (if :exp .exp1 :env recur
                      then :exp .exp2 :env recur
                      else :exp .exp3 :env recur)
      <diff-exp>  [:exp .exp1 :env recur
                   :exp .exp2 :env recur sub]
      <var-exp>   [:exp .var :env env-apply]
      <let-exp>   [:env
                   :exp .var
                   :exp .exp1 :env recur
                   cons-env :new-env!
                   :exp .body :new-env recur]))
  #+end_src

* parse

  #+begin_src jojo
  (note
    123 -- <const-exp>
    (diff ... ...) -- <diff-exp>
    (if ... ... ...) -- <if-exp>
    (zero? ...) -- <zero?-exp>
    :var -- <var-exp>
    (let :var ... ...) -- <let-exp>)

  (+jojo parse (-> :sexp -- exp)
    (cond
      [:sexp int-jo?]   [:sexp jo->int const-exp]
      [:sexp local-jo?] [:sexp var-exp]
      [:sexp cons? not] ["- parse fail" w nl
                         "  can not parse sexp : " w
                         :sexp sexp-write nl
                         debug]
      else [:sexp parse/cons]))

  (+jojo parse/cons (-> :sexp -- exp)
    :sexp .car :key!
    :sexp .cdr :body!
    (cond [:key 'zero? eq?] [:body parse/spread zero?-exp]
          [:key 'if eq?]    [:body parse/spread if-exp]
          [:key 'diff eq?]  [:body parse/spread diff-exp]
          [:key 'let eq?]   [:body .car :body
                             .cdr parse/spread let-exp]))

  (+jojo parse/spread {parse} list-map list-spread)
  #+end_src

* EOPL-LET

  #+begin_src jojo
  (+jojo EOPL-LET (-> :body --)
    :body {parse program-eval} list-map)
  #+end_src

* [test]

  #+begin_src jojo
  (note
    (run (import EOPL-LET/0.0.1)
      (EOPL-LET
       1 2 3
       (diff 2 1)
       (diff 3 1)
       (let :y 5 (diff :x :y))
       (zero? 1)
       (zero? 0)
       (let :y (diff :x 3)
            (if (zero? :y) 0 666)))))
  #+end_src
